<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Comercial - Policryl</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">

    <style>
        /* === VARIÁVEIS DE TEMA === */
        :root {
            /* Palette Dark baseada nas referências */
            --bg-app: #12122b;       /* Fundo profundo */
            --bg-header: #1a1640;    /* Roxo escuro */
            --bg-card: #201c4e;      /* Azul/Roxo cards */
            --bg-card-border: #363275; 
            
            --text-primary: #ffffff;
            --text-secondary: #a5b4fc; 
            --accent: #6366f1; 
            
            --status-blue: #3b82f6;
            --status-orange: #f97316;
            --status-green: #22c55e;
            --status-red: #ef4444;
            
            --font-main: 'Inter', sans-serif;
            --radius: 16px;
            --shadow: 0 8px 24px rgba(0,0,0,0.4);
        }

        /* Tema LIGHT */
        body.light-theme {
            --bg-app: #f1f5f9;
            --bg-header: #ffffff;
            --bg-card: #ffffff;
            --bg-card-border: #cbd5e1;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        /* === RESET & BASE === */
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-app);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            transition: background 0.3s ease;
        }

        .dashboard-wrapper {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 25px;
            height: 100vh;
        }

        /* === HEADER CORRIGIDO === */
        .top-bar {
            background: var(--bg-header);
            border-radius: var(--radius);
            border: 1px solid var(--bg-card-border);
            padding: 0 30px;
            /* Aumentei a altura para caber o gráfico sem cortar */
            height: 220px; 
            display: grid;
            grid-template-columns: 25% 50% 25%;
            align-items: center;
            position: relative;
            box-shadow: var(--shadow);
        }

        /* Logo Area */
        .brand-area { display: flex; align-items: center; gap: 20px; }
        .logo { height: 60px; width: auto; object-fit: contain; }
        .brand-text h1 { font-size: 1.2rem; font-weight: 800; letter-spacing: 1px; line-height: 1; }
        .brand-text span { font-size: 0.8rem; color: var(--text-secondary); display: block; margin-top: 5px; }

        /* Gauge Area (Velocímetro) */
        .gauge-container {
            position: relative;
            height: 100%;
            width: 100%;
            display: flex;
            flex-direction: column;
            justify-content: flex-end; 
            align-items: center;
            padding-bottom: 20px;
        }
        
        /* Wrapper para forçar tamanho do canvas e não estourar */
        .canvas-wrapper {
            position: relative;
            height: 140px; 
            width: 280px;  
        }

        .gauge-overlay {
            /* Ajustado para não sobrepor a agulha */
            margin-top: -10px; 
            text-align: center;
            z-index: 10;
        }
        .gauge-value {
            font-size: 1.6rem;
            font-weight: 900;
            color: var(--text-primary);
            text-shadow: 0 4px 10px rgba(0,0,0,0.5);
            display: block;
            line-height: 1.2;
        }
        .gauge-label { font-size: 0.75rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; }

        /* Controles Area */
        .controls-area {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 15px;
            height: 100%;
        }

        .btn-icon {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--bg-card-border);
            color: var(--text-primary);
            width: 42px; height: 42px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.3rem;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
        }
        .btn-icon:hover { background: var(--accent); color: white; border-color: var(--accent); }

        .controls-column {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 12px;
        }

        .timer-display {
            font-family: monospace;
            font-size: 0.9rem;
            color: var(--text-secondary);
            text-align: right;
            margin-right: 5px;
        }
        
        /* Selects Customizados */
        select.custom-select {
            background: var(--bg-app);
            border: 1px solid var(--bg-card-border);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 8px;
            font-family: var(--font-main);
            font-size: 0.85rem;
            cursor: pointer;
            outline: none;
        }
        select.custom-select:hover { border-color: var(--accent); }

        .btn-filter {
            background: var(--bg-card);
            border: 1px solid var(--accent);
            color: var(--text-primary);
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600; cursor: pointer;
            display: flex; align-items: center; gap: 8px;
            font-family: var(--font-main);
            font-size: 0.9rem;
        }
        .btn-filter:hover { background: var(--accent); color: white; }

        /* Menu Filtro */
        .filter-wrapper { position: relative; }
        .filter-dropdown {
            position: absolute;
            top: 130%; right: 0;
            background: var(--bg-header);
            border: 1px solid var(--bg-card-border);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            width: 280px;
            display: none;
            z-index: 100;
            flex-direction: column; gap: 15px;
        }
        .filter-dropdown.active { display: flex; }
        .filter-group label { display: block; font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 5px; font-weight: 600; }
        .btn-apply {
            background: var(--accent); border: none; padding: 12px;
            color: white; font-weight: bold; border-radius: 6px; cursor: pointer;
            width: 100%;
        }

        /* === KPIS ROW === */
        .kpi-row {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 1.5vw;
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--bg-card-border);
            border-radius: var(--radius);
            padding: 24px 20px;
            display: flex; flex-direction: column; justify-content: center;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
            min-height: 150px;
        }

        .card-label { font-size: 0.75rem; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 8px; letter-spacing: 0.5px; }
        .kpi-main h2 { font-size: 1.8rem; font-weight: 800; margin: 0; color: var(--text-primary); letter-spacing: -0.5px; }
        .kpi-main.highlight h2 { color: var(--status-green); }
        .card-sub { font-size: 0.8rem; color: var(--text-secondary); margin-top: 5px; opacity: 0.8; }

        /* Cards Coloridos */
        .kpi-status { border-top: 5px solid; justify-content: space-between; }
        .kpi-status h2 { font-size: 2.5rem; font-weight: 800; line-height: 1; margin: 10px 0; }
        
        .status-blue { border-top-color: var(--status-blue); }
        .status-orange { border-top-color: var(--status-orange); }
        .status-green { border-top-color: var(--status-green); }

        /* === GRID FRANQUIAS === */
        .franchise-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1.5vw;
            flex: 1; 
        }

        .franchise-card {
            background: var(--bg-card);
            border: 1px solid var(--bg-card-border);
            border-radius: var(--radius);
            padding: 20px;
            display: flex; flex-direction: column; justify-content: space-between;
            box-shadow: var(--shadow);
            border-top: 4px solid; /* A cor vem do inline style no JS */
        }

        .fra-header {
            display: flex; align-items: center; gap: 12px;
            padding-bottom: 15px; border-bottom: 1px solid var(--bg-card-border);
            margin-bottom: 15px;
        }
        
        .fra-icon-box {
            width: 40px; height: 40px; border-radius: 8px;
            border: 2px solid; 
            display: flex; align-items: center; justify-content: center;
            background: transparent;
        }

        .fra-title h3 { font-size: 1rem; font-weight: 700; color: var(--text-primary); text-transform: uppercase; }
        .fra-title span { font-size: 0.75rem; color: var(--text-secondary); display: block; }

        .fra-body { display: flex; flex-direction: column; gap: 10px; }
        .fra-row { display: flex; justify-content: space-between; align-items: baseline; }
        .fra-label { font-size: 0.75rem; color: var(--text-secondary); text-transform: uppercase; font-weight: 600; }
        .fra-val { font-size: 1rem; font-weight: 600; color: var(--text-primary); }
        .fra-val.money { color: var(--status-green); font-weight: 700; font-size: 1.1rem; }
        
        .fra-row.divider {
            border-top: 1px solid var(--bg-card-border);
            padding-top: 10px; margin-top: 5px;
        }

        /* === LOADING === */
        .loading {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #0f0c29;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 9999;
        }
        .spinner {
            width: 50px; height: 50px;
            border: 4px solid rgba(255,255,255,0.1);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { margin-top: 15px; color: var(--accent); font-weight: 600; font-family: var(--font-main); }

        /* === RESPONSIVIDADE TV 4K === */
        @media (min-width: 1920px) {
            html { font-size: 20px; } 
            .dashboard-wrapper { padding: 30px; gap: 30px; }
            .top-bar { height: 260px; } /* Mais altura para TV grande */
            .canvas-wrapper { width: 360px; height: 180px; }
        }
        
        @media (max-width: 1366px) {
            html { font-size: 14px; }
            .kpi-row { grid-template-columns: repeat(3, 1fr); gap: 15px; }
            .franchise-grid { overflow-y: auto; }
        }
    </style>
</head>
<body>

    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div class="loading-text">Carregando Dashboard...</div>
    </div>

    <div class="dashboard-wrapper">
        
        <header class="top-bar">
            <div class="brand-area">
                <img src="logo-policryl-branco.png" alt="Policryl" class="logo">
                <div class="brand-text">
                    <h1>COMMERCIAL DASHBOARD</h1>
                    <span id="last-update">Atualizado: --:--</span>
                </div>
            </div>

            <div class="gauge-container">
                <div class="canvas-wrapper">
                    <canvas id="gaugeChart"></canvas>
                </div>
                <div class="gauge-overlay">
                    <span class="gauge-value" id="gauge-valor-anual">R$ 0,00</span>
                    <span class="gauge-label">Meta Anual (<span id="gauge-percent">0%</span>)</span>
                </div>
            </div>

            <div class="controls-area">
                
                <button class="btn-icon" onclick="toggleTheme()" title="Alternar Tema">
                    <i class="ph ph-moon" id="theme-icon"></i>
                </button>

                <div class="controls-column">
                    <div class="filter-wrapper">
                        <button class="btn-filter" onclick="toggleFilterMenu()">
                            FILTRAR <i class="ph ph-caret-down"></i>
                        </button>
                        
                        <div class="filter-dropdown" id="filter-menu">
                            <div class="filter-group">
                                <label>ANO</label>
                                <select id="filterAno" class="custom-select" style="width:100%"></select>
                            </div>
                            <div class="filter-group">
                                <label>MÊS</label>
                                <select id="filterMes" class="custom-select" style="width:100%"></select>
                            </div>
                            <div class="filter-group">
                                <label>LINHA / FRANQUIA</label>
                                <select id="filterLinha" class="custom-select" style="width:100%">
                                    <option value="todas">Todas as Linhas</option>
                                    <option value="FRA - Brasil Cacau">Brasil Cacau</option>
                                    <option value="FRA - Cacau Show">Cacau Show</option>
                                    <option value="FRA - Kopenhagen">Kopenhagen</option>
                                    <option value="IND - Industries">Industries</option>
                                    <option value="PLB - PolyBee">PolyBee</option>
                                    <option value="SKD - Skullderia">Skullderia</option>
                                </select>
                            </div>
                            <button class="btn-apply" onclick="applyFilters()">Aplicar Filtros</button>
                        </div>
                    </div>

                    <div style="display:flex; align-items:center; gap:10px;">
                        <span class="timer-display" id="countdown">--:--</span>
                        <select id="refreshSelect" class="custom-select" onchange="updateRefreshTime()">
                            <option value="30">30 seg (Teste)</option>
                            <option value="60">1 min</option>
                            <option value="120">2 min</option>
                            <option value="300">5 min</option>
                            <option value="600" selected>10 min</option>
                            <option value="900">15 min</option>
                            <option value="1800">30 min</option>
                        </select>
                    </div>
                </div>

            </div>
        </header>

        <section class="kpi-row">
            <div class="card kpi-main">
                <span class="card-label">META DO MÊS</span>
                <h2 id="metaMes">R$ 0,00</h2>
                <span class="card-sub" id="mesRef">--/--</span>
            </div>
            
            <div class="card kpi-main">
                <span class="card-label">META DO DIA (ACUMULADA)</span>
                <h2 id="metaDia">R$ 0,00</h2>
                <span class="card-sub">Esperado até hoje</span>
            </div>

            <div class="card kpi-main highlight">
                <span class="card-label">VALOR EM VENDAS</span>
                <h2 id="valorVendas">R$ 0,00</h2>
                <span class="card-sub">Total Faturado</span>
            </div>

            <div class="card kpi-status status-blue">
                <span class="card-label">PEDIDOS EM CASA</span>
                <h2 id="pedidosEmCasa">0</h2>
                <span class="card-sub">Aprovados</span>
            </div>

            <div class="card kpi-status status-orange">
                <span class="card-label">PEDIDOS À LIBERAR</span>
                <h2 id="pedidosLiberar">0</h2>
                <span class="card-sub">Atenção Necessária</span>
            </div>

            <div class="card kpi-status status-green">
                <span class="card-label">PEDIDOS FATURADOS</span>
                <h2 id="pedidosFaturados">0</h2>
                <span class="card-sub">Na expedição/Expedidos</span>
            </div>
        </section>

        <section class="franchise-grid" id="franchise-container">
            </section>

    </div>

    <script>
        // === 1. CONFIGURAÇÕES ===
        const CONFIG = {
            CSV_URL: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQKstKflONSWvQ6xfVkMdM53mveopLXVGNv9CyQT0kRbjdI7IGIVzvvMPLSXNyQ-xZTQEvDmKr1jI_I/pub?gid=1199309873&single=true&output=csv',
            
            // AQUI VOCÊ EDITA A META DE CADA ANO
            METAS_ANUAIS: {
                2024: 8500000,
                2025: 9000000,
                2026: 10000000,
                2027: 12000000
            }
        };

        // === 2. MAPEAMENTO DAS COLUNAS ===
        const COLS = {
            ANO:0, MES:1, LINHA:2,
            META_MES:3, META_DIARIA:4,
            QTDE_ORCAMENTOS:6, VALOR_ORCAMENTOS:7, 
            QTDE_PEDIDOS:13, VALOR_PEDIDOS:14, 
            PEDIDOS_ATRASADOS:25, PEDIDOS_A_LIBERAR:27,
            PEDIDOS_FATURADOS_MES:28, PEDIDOS_EM_CASA: 26 
        };

        // === 3. ESTADO GLOBAL ===
        let allData = [];
        let gaugeChart = null;
        let refreshTimer = null;
        let secondsLeft = 600;

        // === 4. PLUGIN VELOCÍMETRO (Agulha) ===
        const gaugeNeedle = {
            id: 'gaugeNeedle',
            afterDatasetDraw(chart) {
                const { ctx, data, chartArea: { top, bottom, left, right, width, height } } = chart;
                ctx.save();
                
                const valorTotal = data.datasets[0].needleValue || 0;
                const metaTotal = data.datasets[0].metaTotal || 1;
                
                let percentage = valorTotal / metaTotal;
                if (percentage > 1) percentage = 1;
                if (percentage < 0) percentage = 0;

                // Centro do gráfico
                const cx = width / 2;
                const cy = height - 5; 

                // Angulo
                const angle = Math.PI + (percentage * Math.PI); 

                ctx.translate(cx, top + (height / 1.35)); // Pivot Point
                ctx.rotate(angle);

                // Desenha a Agulha
                ctx.beginPath();
                ctx.moveTo(0, -4);
                ctx.lineTo(height / 1.6, 0); 
                ctx.lineTo(0, 4);
                ctx.fillStyle = document.body.classList.contains('light-theme') ? '#333' : '#fff';
                ctx.fill();
                
                // Base da agulha
                ctx.beginPath();
                ctx.arc(0, 0, 6, 0, Math.PI * 2);
                ctx.fillStyle = '#6366f1';
                ctx.fill();

                ctx.restore();
            }
        };

        // === 5. INICIALIZAÇÃO ===
        document.addEventListener('DOMContentLoaded', () => {
            initFilters();
            initGauge();
            loadSettings();
            fetchSheetData();
            startTimer();
        });

        // === 6. FETCH DADOS ===
        async function fetchSheetData() {
            try {
                const loading = document.getElementById('loading');
                if(loading) loading.style.display = 'flex';

                const res = await fetch(`${CONFIG.CSV_URL}&cb=${Date.now()}`);
                const txt = await res.text();
                const rows = csvToArray(txt); 
                
                if (rows.length > 1) {
                    allData = rows.slice(1);
                    updateDashboard();
                    updateLastUpdate();
                }
            } catch (e) {
                console.error("Erro ao carregar CSV:", e);
            } finally {
                const loading = document.getElementById('loading');
                if(loading) loading.style.display = 'none';
            }
        }

        // === 7. LÓGICA PRINCIPAL ===
        function updateDashboard() {
            const filters = getCurrentFilters();
            
            // FILTRO
            const dadosFiltrados = allData.filter(row => {
                const rowAno = String(row[COLS.ANO] || '').trim();
                const rowMes = normalizarMes(row[COLS.MES]);
                const rowLinha = String(row[COLS.LINHA] || '').trim().toLowerCase();
                
                const passaAno = rowAno === filters.ano;
                const passaMes = rowMes === filters.mes;
                const passaLinha = filters.linha === 'todas' || rowLinha === filters.linha.toLowerCase();

                return passaAno && passaMes && passaLinha;
            });

            // SOMAS KPI
            let totalMeta = 0, totalVendas = 0, totalFaturados = 0, totalEmCasa = 0;
            dadosFiltrados.forEach(row => {
                totalMeta += parseValue(row[COLS.META_MES]);
                totalVendas += parseValue(row[COLS.VALOR_PEDIDOS]);
                totalFaturados += parseValue(row[COLS.PEDIDOS_FATURADOS_MES]);
                totalEmCasa += parseValue(row[COLS.PEDIDOS_EM_CASA]); 
            });

            // KPIs GERAIS (Independente de mês)
            const dadosGerais = allData.filter(row => 
                filters.linha === 'todas' || 
                String(row[COLS.LINHA]).trim().toLowerCase() === filters.linha.toLowerCase()
            );
            const totalAtraso = dadosGerais.reduce((acc, row) => acc + parseValue(row[COLS.PEDIDOS_ATRASADOS]), 0);
            const totalLiberar = dadosGerais.reduce((acc, row) => acc + parseValue(row[COLS.PEDIDOS_A_LIBERAR]), 0);

            // META DIÁRIA CUMULATIVA
            const diasNoMes = new Date(filters.ano, filters.mes, 0).getDate();
            const hoje = new Date();
            const isMesAtual = (parseInt(filters.mes) === (hoje.getMonth() + 1)) && (parseInt(filters.ano) === hoje.getFullYear());
            const diasCorridos = isMesAtual ? hoje.getDate() : diasNoMes;
            const metaDiaAcumulada = (totalMeta / diasNoMes) * diasCorridos;

            // ATUALIZA HTML
            setText('metaMes', formatCurrency(totalMeta));
            setText('metaDia', formatCurrency(metaDiaAcumulada));
            setText('valorVendas', formatCurrency(totalVendas));
            
            setText('pedidosFaturados', formatNumber(totalFaturados));
            setText('pedidosLiberar', formatNumber(totalLiberar));
            setText('pedidosEmCasa', formatNumber(totalEmCasa)); 
            
            setText('mesRef', `${filters.mes}/${filters.ano}`);

            // RENDERIZA FRANQUIAS
            updateFranquias(allData, filters);

            // ATUALIZA VELOCÍMETRO (Meta Anual Dinâmica)
            updateGauge(filters.ano);
        }

        function updateFranquias(data, filters) {
            const container = document.getElementById('franchise-container');
            container.innerHTML = ''; 

            const ids = [
                { cod: 'bc', nome: 'FRA - Brasil Cacau', cor: '#f97316' },
                { cod: 'cs', nome: 'FRA - Cacau Show', cor: '#8b4513' },
                { cod: 'kp', nome: 'FRA - Kopenhagen', cor: '#e11d48' },
                { cod: 'id', nome: 'IND - Industries', cor: '#3b82f6' },
                { cod: 'pb', nome: 'PLB - PolyBee', cor: '#fbbf24' }
            ];

            ids.forEach(franq => {
                const fRows = data.filter(r => 
                    String(r[COLS.ANO]).trim() === filters.ano &&
                    normalizarMes(r[COLS.MES]) === filters.mes &&
                    String(r[COLS.LINHA]).trim().toLowerCase() === franq.nome.toLowerCase()
                );

                let fValOrc = 0, fValPed = 0, fQtdPed = 0, fQtdOrc = 0;
                fRows.forEach(r => {
                    fValOrc += parseValue(r[COLS.VALOR_ORCAMENTOS]);
                    fValPed += parseValue(r[COLS.VALOR_PEDIDOS]);
                    fQtdPed += parseValue(r[COLS.QTDE_PEDIDOS]);
                    fQtdOrc += parseValue(r[COLS.QTDE_ORCAMENTOS]);
                });

                const ticket = fQtdPed > 0 ? fValPed / fQtdPed : 0;
                const conversao = fValOrc > 0 ? (fValPed / fValOrc) * 100 : 0;

                const cardHTML = `
                <div class="franchise-card" style="border-top-color: ${franq.cor}">
                    <div class="fra-header">
                        <div class="fra-icon-box" style="border-color:${franq.cor}; color:${franq.cor}">
                            <span style="font-weight:900; font-size:12px">${franq.cod.toUpperCase()}</span>
                        </div>
                        <div class="fra-title">
                            <h3>${franq.nome.replace('FRA - ','').replace('IND - ','').replace('PLB - ','')}</h3>
                            <span>${filters.mes}/${filters.ano}</span>
                        </div>
                    </div>
                    <div class="fra-body">
                        <div class="fra-row"><span class="fra-label">Nº Orçamentos</span><span class="fra-val">${formatNumber(fQtdOrc)}</span></div>
                        <div class="fra-row"><span class="fra-label">Valor Orç.</span><span class="fra-val">${formatCurrency(fValOrc)}</span></div>
                        <div class="fra-row"><span class="fra-label">Venda</span><span class="fra-val money">${formatCurrency(fValPed)}</span></div>
                        <div class="fra-row"><span class="fra-label">Ticket Méd.</span><span class="fra-val">${formatCurrency(ticket)}</span></div>
                        <div class="fra-row divider">
                            <span class="fra-label">Conversão ($)</span>
                            <span class="fra-val" style="color:${conversao >= 30 ? 'var(--status-green)' : 'var(--text-primary)'}">${conversao.toFixed(1)}%</span>
                        </div>
                    </div>
                </div>`;
                
                container.innerHTML += cardHTML;
            });
        }

        function updateGauge(ano) {
            // Busca a meta no CONFIG ou usa default
            const metaDoAno = CONFIG.METAS_ANUAIS[ano] || 9000000;

            // Soma vendas do ano todo
            const dadosAno = allData.filter(r => String(r[COLS.ANO]).trim() === ano);
            const totalAno = dadosAno.reduce((acc, r) => acc + parseValue(r[COLS.VALOR_PEDIDOS]), 0);
            
            if(gaugeChart) {
                gaugeChart.data.datasets[0].needleValue = totalAno;
                gaugeChart.data.datasets[0].metaTotal = metaDoAno; 
                
                // Recalcula fatias proporcionais (15% - 35% - 35% - 15%)
                const p1 = metaDoAno * 0.15;
                const p2 = metaDoAno * 0.35;
                const p3 = metaDoAno * 0.35;
                const p4 = metaDoAno * 0.15;
                gaugeChart.data.datasets[0].data = [p1, p2, p3, p4];
                
                gaugeChart.update();
            }
            
            setText('gauge-valor-anual', formatCurrency(totalAno));
            const pct = (totalAno / metaDoAno) * 100;
            setText('gauge-percent', pct.toFixed(1) + '%');
        }

        // === 8. HELPERS ===
        function csvToArray(text){
            const lines = text.split(/\r?\n/).filter(l => l.length>0);
            return lines.map(line => {
                const out=[]; let cur='', q=false;
                for (let i=0;i<line.length;i++){
                    const ch=line[i];
                    if (ch === '"'){ if (q && line[i+1] === '"'){ cur+='"'; i++; } else { q=!q; } }
                    else if (ch === ',' && !q){ out.push(cur); cur=''; }
                    else { cur += ch; }
                }
                out.push(cur);
                return out;
            });
        }
        function parseValue(v){
            if (!v && v!==0) return 0;
            if (typeof v==='number') return v;
            let s = String(v).replace('R$','').replace(/\./g,'').replace(',','.').trim();
            return parseFloat(s)||0;
        }
        function formatCurrency(v){ return new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(v||0); }
        function formatNumber(v){ return new Intl.NumberFormat('pt-BR').format(v||0); }
        function setText(id, txt){ const el = document.getElementById(id); if(el) el.textContent = txt; }
        function normalizarMes(m){ const n=parseInt(m,10); return isNaN(n)?'01':String(n).padStart(2,'0'); }

        // === 9. CONTROLES ===
        function getCurrentFilters(){
            return {
                ano: document.getElementById('filterAno').value,
                mes: document.getElementById('filterMes').value,
                linha: document.getElementById('filterLinha').value
            };
        }
        function initFilters(){
            const selAno = document.getElementById('filterAno');
            const selMes = document.getElementById('filterMes');
            
            // Popula Anos
            [2024, 2025, 2026, 2027].forEach(a => {
                let opt = new Option(a, a);
                if(a === new Date().getFullYear()) opt.selected = true;
                selAno.add(opt);
            });
            
            // Popula Meses
            const nomes = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
            nomes.forEach((n,i) => {
                let val = String(i+1).padStart(2,'0');
                let opt = new Option(n, val);
                if((i+1) === (new Date().getMonth() + 1)) opt.selected = true;
                selMes.add(opt);
            });
        }
        function toggleFilterMenu(){ document.getElementById('filter-menu').classList.toggle('active'); }
        function applyFilters(){ updateDashboard(); toggleFilterMenu(); }

        function initGauge(){
            const ctx = document.getElementById('gaugeChart').getContext('2d');
            gaugeChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['1º Tri', '2º Tri', '3º Tri', '4º Tri'],
                    datasets: [{
                        data: [1, 1, 1, 1], // Placeholder, atualiza no updateGauge
                        backgroundColor: ['#334155', '#475569', '#64748b', '#94a3b8'],
                        borderWidth: 0,
                        cutout: '80%', 
                        circumference: 180,
                        rotation: -90,
                        needleValue: 0,
                        metaTotal: 1
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    layout: { padding: { bottom: 0, left:0, right:0, top:0 } },
                    plugins: { legend: {display:false}, tooltip: {enabled:false} }
                },
                plugins: [gaugeNeedle]
            });
        }

        // Timer
        function loadSettings(){
            const savedTime = localStorage.getItem('dash_refresh_sec');
            if(savedTime) {
                secondsLeft = parseInt(savedTime);
                document.getElementById('refreshSelect').value = savedTime;
            }
            const savedTheme = localStorage.getItem('dash_theme');
            if(savedTheme === 'light') toggleTheme(true);
        }

        function updateRefreshTime(){
            const val = document.getElementById('refreshSelect').value;
            secondsLeft = parseInt(val);
            localStorage.setItem('dash_refresh_sec', val);
            startTimer();
        }

        function startTimer(){
            clearInterval(refreshTimer);
            const display = document.getElementById('countdown');
            const total = parseInt(document.getElementById('refreshSelect').value);
            let count = total;
            
            refreshTimer = setInterval(() => {
                count--;
                let m = Math.floor(count/60);
                let s = count%60;
                display.textContent = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
                if(count<=0){
                    fetchSheetData();
                    count = total;
                }
            }, 1000);
        }

        function updateLastUpdate(){ 
            document.getElementById('last-update').textContent = `Atualizado: ${new Date().toLocaleTimeString()}`; 
        }

        function toggleTheme(forceLight = false){
            const body = document.body;
            const icon = document.getElementById('theme-icon');
            const isLight = forceLight || !body.classList.contains('light-theme');
            
            if(isLight) {
                body.classList.add('light-theme');
                icon.classList.replace('ph-moon', 'ph-sun');
                localStorage.setItem('dash_theme', 'light');
            } else {
                body.classList.remove('light-theme');
                icon.classList.replace('ph-sun', 'ph-moon');
                localStorage.setItem('dash_theme', 'dark');
            }
            if(gaugeChart) gaugeChart.update();
        }
    </script>
</body>
</html>
