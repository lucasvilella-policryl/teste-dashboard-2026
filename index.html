        function getProdutosFiltrados() {
            return state.produtos
                .filter(p => {
                    const matchSearch = p.sku.toLowerCase().includes(state.searchTerm.toLowerCase()) || 
                                       p.descricao.toLowerCase().includes(state.searchTerm.toLowerCase());
                    const matchStatus = state.filterStatus === 'todos' || 
                                       (state.filterStatus === 'ativo' && p.ativo) ||
                                       (state.filterStatus === 'inativo' && !p.ativo) ||
                                       getStatusProduto(p) === state.filterStatus;
                    const matchLinha = state.filterLinha === 'todas' || p.linha === state.filterLinha;
                    const matchVisibilidade = state.filterVisibilidade === 'todos' ||
                                             (state.filterVisibilidade === 'visiveis' && p.visivel) ||
                                             (state.filterVisibilidade === 'ocultos' && !p.visivel);
                    
                    return matchSearch && matchStatus && matchLinha && matchVisibilidade;
                })
                .sort((a, b) => {
                    if (state.sortBy === 'status') {
                        const statusOrder = { 'abaixo': 0, 'proximo': 1, 'ok': 2 };
                        return statusOrder[getStatusProduto(a)] - statusOrder[getStatusProduto(b)];
                    } else if (state.sortBy === 'quantidade') {
                        return state.sortOrder === 'asc' ? a.quantidade - b.quantidade : b.quantidade - a.quantidade;
                    }
                    return 0;
                });
        }

        // ==================== RENDER FUNCTIONS ====================
        function renderLogin() {
            return `
                <div class="login-screen">
                    <div class="login-box">
                        <h1>Policryl</h1>
                        <p>Sistema de Estoque</p>
                        <form onsubmit="handleLogin(event)">
                            <div class="form-group">
                                <label>Usu√°rio</label>
                                <input type="text" id="login-username" required autofocus>
                            </div>
                            <div class="form-group" style="margin-top: 16px;">
                                <label>Senha</label>
                                <input type="password" id="login-password" required>
                            </div>
                            <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 24px;">
                                Entrar
                            </button>
                        </form>
                        <div style="margin-top: 32px; padding-top: 24px; border-top: 1px solid #e2e8f0; font-size: 12px; color: #64748b;">
                            <p><strong>Acesso padr√£o:</strong></p>
                            <p style="margin-top: 8px;">Admin: admin / admin123</p>
                            <p style="margin-top: 4px; font-size: 11px;">Outros usu√°rios devem ser cadastrados pelo administrador</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderSidebar() {
            const menuItems = [
                { id: 'dashboard', label: 'Status do Estoque', icon: 'üìä', permission: 'view' },
                { id: 'consulta', label: 'Consultar Produto', icon: 'üîç', permission: 'view' },
                { id: 'estoque', label: 'Estoque Geral', icon: 'üì¶', permission: 'view' },
                { id: 'movimentacoes', label: 'Movimenta√ß√µes', icon: 'üìã', permission: 'view' },
                { id: 'nova-movimentacao', label: 'Cadastrar Movimenta√ß√£o', icon: 'üìà', permission: 'create-movimento' },
                { id: 'novo-produto', label: 'Cadastrar Produto', icon: '‚ûï', permission: 'create' },
                { id: 'novo-responsavel', label: 'Cadastrar Respons√°vel', icon: 'üë•', permission: 'create' },
                { id: 'nova-linha', label: 'Cadastrar Linha', icon: 'üè∑Ô∏è', permission: 'create' },
                { id: 'usuarios', label: 'Gerenciar Usu√°rios', icon: 'üë§', permission: 'config' },
                { id: 'configuracoes', label: 'Configura√ß√µes', icon: '‚öôÔ∏è', permission: 'config' }
            ];

            return `
                <div class="sidebar">
                    <div class="sidebar-header">
                        <h1>Policryl</h1>
                        <p>Sistema de Estoque</p>
                    </div>
                    <div class="user-info">
                        <div class="name">${state.currentUser.nome}</div>
                        <div class="role">
                            ${state.currentUser.role === 'admin' ? 'üëë Administrador' : 
                              state.currentUser.role === 'operador' ? '‚öôÔ∏è Operador' : 'üëÅÔ∏è Leitor'}
                        </div>
                    </div>
                    <nav class="sidebar-nav">
                        ${menuItems.map(item => {
                            const hasAccess = hasPermission(item.permission);
                            return `
                                <button 
                                    class="nav-item ${state.activeTab === item.id ? 'active' : ''} ${!hasAccess ? 'disabled' : ''}" 
                                    onclick="${hasAccess ? `changeTab('${item.id}')` : ''}"
                                    ${!hasAccess ? 'disabled' : ''}
                                >
                                    <span>${item.icon}</span>
                                    <span>${item.label}</span>
                                </button>
                            `;
                        }).join('')}
                    </nav>
                    <button class="logout-btn" onclick="logout()">
                        üö™ Sair
                    </button>
                </div>
            `;
        }

        function renderHeader() {
            const titles = {
                'dashboard': 'Status do Estoque',
                'consulta': 'Consultar Produto',
                'estoque': 'Estoque Geral',
                'movimentacoes': 'Movimenta√ß√µes',
                'nova-movimentacao': 'Cadastrar Movimenta√ß√£o',
                'novo-produto': 'Cadastrar Produto',
                'novo-responsavel': 'Cadastrar Respons√°vel',
                'nova-linha': 'Cadastrar Linha',
                'usuarios': 'Gerenciar Usu√°rios',
                'configuracoes': 'Configura√ß√µes do Sistema'
            };

            const stats = calcularEstatisticas();
            const subtitles = {
                'dashboard': `${stats.total} produtos cadastrados`,
                'estoque': `${stats.ativos} produtos ativos`,
                'movimentacoes': `${state.movimentacoes.length} movimenta√ß√µes registradas`
            };

            return `
                <div class="header">
                    <h2>${titles[state.activeTab]}</h2>
                    <p>${subtitles[state.activeTab] || ''}</p>
                    ${state.activeTab === 'dashboard' || state.activeTab === 'estoque' ? `
                        <div class="header-actions">
                            <button class="btn btn-primary" onclick="exportarExcel()">
                                üì• Exportar
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderDashboard() {
            const stats = calcularEstatisticas();
            const produtosFiltrados = getProdutosFiltrados();

            return `
                <div class="stats-grid">
                    <div class="stat-card blue">
                        <h3>Produtos Cadastrados</h3>
                        <div class="value">${stats.total}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Produtos Ativos</h3>
                        <div class="value">${stats.ativos}</div>
                    </div>
                    <div class="stat-card gray">
                        <h3>Produtos Inativos</h3>
                        <div class="value">${stats.inativos}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Estoque OK</h3>
                        <div class="value">${stats.ok}</div>
                    </div>
                    <div class="stat-card yellow">
                        <h3>Pr√≥ximo do M√≠nimo</h3>
                        <div class="value">${stats.proximo}</div>
                    </div>
                    <div class="stat-card red">
                        <h3>Abaixo do M√≠nimo</h3>
                        <div class="value">${stats.abaixo}</div>
                    </div>
                    ${hasPermission('view-values') ? `
                        <div class="stat-card purple">
                            <h3>Valor Total (Custo)</h3>
                            <div class="value" style="font-size: 24px;">${formatCurrency(stats.valorTotalEstoque)}</div>
                        </div>
                        <div class="stat-card purple">
                            <h3>Valor Total (Venda)</h3>
                            <div class="value" style="font-size: 24px;">${formatCurrency(stats.valorTotalVenda)}</div>
                        </div>
                    ` : ''}
                </div>

                <div class="filters">
                    <div class="filters-grid">
                        <div class="form-group">
                            <label>Buscar</label>
                            <input type="text" placeholder="SKU ou descri√ß√£o..." value="${state.searchTerm}" oninput="state.searchTerm = this.value; render()">
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select onchange="state.filterStatus = this.value; render()">
                                <option value="todos" ${state.filterStatus === 'todos' ? 'selected' : ''}>Todos</option>
                                <option value="ativo" ${state.filterStatus === 'ativo' ? 'selected' : ''}>Ativos</option>
                                <option value="inativo" ${state.filterStatus === 'inativo' ? 'selected' : ''}>Inativos</option>
                                <option value="abaixo" ${state.filterStatus === 'abaixo' ? 'selected' : ''}>Abaixo do M√≠nimo</option>
                                <option value="proximo" ${state.filterStatus === 'proximo' ? 'selected' : ''}>Pr√≥ximo do M√≠nimo</option>
                                <option value="ok" ${state.filterStatus === 'ok' ? 'selected' : ''}>OK</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Linha</label>
                            <select onchange="state.filterLinha = this.value; render()">
                                <option value="todas" ${state.filterLinha === 'todas' ? 'selected' : ''}>Todas</option>
                                ${state.linhas.map(l => `<option value="${l.nome}" ${state.filterLinha === l.nome ? 'selected' : ''}>${l.nome}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Visibilidade</label>
                            <select onchange="state.filterVisibilidade = this.value; render()">
                                <option value="todos" ${state.filterVisibilidade === 'todos' ? 'selected' : ''}>Todos</option>
                                <option value="visiveis" ${state.filterVisibilidade === 'visiveis' ? 'selected' : ''}>Vis√≠veis</option>
                                <option value="ocultos" ${state.filterVisibilidade === 'ocultos' ? 'selected' : ''}>Ocultos</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Ordenar por Quantidade</label>
                            <div class="btn-group">
                                <button class="btn ${state.sortBy === 'quantidade' && state.sortOrder === 'asc' ? 'btn-primary' : 'btn-secondary'}" onclick="state.sortBy = 'quantidade'; state.sortOrder = 'asc'; render()">Crescente</button>
                                <button class="btn ${state.sortBy === 'quantidade' && state.sortOrder === 'desc' ? 'btn-primary' : 'btn-secondary'}" onclick="state.sortBy = 'quantidade'; state.sortOrder = 'desc'; render()">Decrescente</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Foto</th>
                                <th>SKU</th>
                                <th>Descri√ß√£o</th>
                                <th>Linha</th>
                                <th>Quantidade</th>
                                <th>M√≠nimo</th>
                                ${hasPermission('view-values') ? '<th>Custo</th><th>Venda</th>' : ''}
                                <th>Status</th>
                                <th>Vis√≠vel</th>
                                <th>Ativo</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${produtosFiltrados.map(p => `
                                <tr>
                                    <td>
                                        ${p.foto ? 
                                            `<img src="${p.foto}" class="product-img" alt="${p.descricao}">` : 
                                            `<div class="img-placeholder">üì¶</div>`
                                        }
                                    </td>
                                    <td><strong>${p.sku}</strong></td>
                                    <td>${p.descricao}</td>
                                    <td><span class="badge badge-blue">${p.linha}</span></td>
                                    <td><strong>${p.quantidade}</strong></td>
                                    <td>${p.estoqueMinimo}</td>
                                    ${hasPermission('view-values') ? `
                                        <td>${formatCurrency(p.valorCusto)}</td>
                                        <td>${formatCurrency(p.valorVenda)}</td>
                                    ` : ''}
                                    <td>
                                        <span class="badge badge-${getStatusProduto(p) === 'ok' ? 'success' : getStatusProduto(p) === 'proximo' ? 'warning' : 'danger'}">
                                            ${getStatusLabel(getStatusProduto(p))}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge ${p.visivel ? 'badge-green' : 'badge-orange'}">
                                            ${p.visivel ? 'üëÅÔ∏è Sim' : 'üîí N√£o'}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge ${p.ativo ? 'badge-green' : 'badge-gray'}">
                                            ${p.ativo ? '‚úì Sim' : '‚úó N√£o'}
                                        </span>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderConsulta() {
            const produto = state.produtos.find(p => p.sku.toLowerCase() === state.consultaSKU.toLowerCase() && p.visivel);

            return `
                <div class="consulta-box">
                    <div class="consulta-search">
                        <input type="text" placeholder="Ex: POL-001" value="${state.consultaSKU}" oninput="state.consultaSKU = this.value">
                        <button class="btn btn-primary" onclick="render()">üîç Buscar</button>
                    </div>

                    ${produto ? `
                        <div class="consulta-result">
                            <div class="info-card">
                                <label>SKU</label>
                                <div class="value">${produto.sku}</div>
                            </div>
                            <div class="info-card">
                                <label>Descri√ß√£o</label>
                                <div class="value">${produto.descricao}</div>
                            </div>
                            <div class="info-card">
                                <label>Linha</label>
                                <div class="value">${produto.linha}</div>
                            </div>
                            <div class="info-card">
                                <label>Status</label>
                                <div class="value">${produto.ativo ? 'Ativo' : 'Inativo'}</div>
                            </div>
                            <div class="info-card highlight">
                                <label>Quantidade Atual</label>
                                <div class="value">${produto.quantidade}</div>
                            </div>
                            <div class="info-card">
                                <label>Quantidade M√≠nima</label>
                                <div class="value">${produto.estoqueMinimo}</div>
                            </div>
                            ${hasPermission('view-values') ? `
                                <div class="info-card">
                                    <label>Valor de Custo</label>
                                    <div class="value">${formatCurrency(produto.valorCusto)}</div>
                                </div>
                                <div class="info-card">
                                    <label>Valor de Venda</label>
                                    <div class="value">${formatCurrency(produto.valorVenda)}</div>
                                </div>
                            ` : ''}
                        </div>
                        <div style="margin-top: 24px;">
                            <label style="display: block; margin-bottom: 12px; font-weight: 600;">N√≠vel no Estoque</label>
                            <span class="badge badge-${getStatusProduto(produto) === 'ok' ? 'success' : getStatusProduto(produto) === 'proximo' ? 'warning' : 'danger'}" style="font-size: 16px; padding: 10px 20px;">
                                ${getStatusLabel(getStatusProduto(produto))}
                            </span>
                        </div>
                    ` : state.consultaSKU ? `
                        <div class="empty-state">
                            <p style="font-size: 18px; font-weight: 600;">Nenhum produto encontrado</p>
                            <p style="margin-top: 8px;">Verifique o SKU e tente novamente</p>
                        </div>
                    ` : `
                        <div class="empty-state">
                            <p style="font-size: 18px; font-weight: 600;">Digite um SKU para consultar</p>
                        </div>
                    `}
                </div>
            `;
        }

        function renderEstoqueGeral() {
            return `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Foto</th>
                                <th>SKU</th>
                                <th>Descri√ß√£o</th>
                                <th>Linha</th>
                                <th>Quantidade Atual</th>
                                <th>√öltima Atualiza√ß√£o</th>
                                <th>M√≠nimo Ideal</th>
                                ${hasPermission('view-values') ? '<th>Custo</th><th>Venda</th>' : ''}
                            </tr>
                        </thead>
                        <tbody>
                            ${state.produtos.filter(p => p.visivel).map(p => `
                                <tr>
                                    <td>
                                        ${p.foto ? 
                                            `<img src="${p.foto}" class="product-img" alt="${p.descricao}">` : 
                                            `<div class="img-placeholder">üì¶</div>`
                                        }
                                    </td>
                                    <td><strong>${p.sku}</strong></td>
                                    <td>${p.descricao}</td>
                                    <td><span class="badge badge-blue">${p.linha}</span></td>
                                    <td><strong>${p.quantidade}</strong></td>
                                    <td>${new Date(p.ultimaAtualizacao).toLocaleDateString('pt-BR')}</td>
                                    <td>${p.estoqueMinimo}</td>
                                    ${hasPermission('view-values') ? `
                                        <td>${formatCurrency(p.valorCusto)}</td>
                                        <td>${formatCurrency(p.valorVenda)}</td>
                                    ` : ''}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderMovimentacoes() {
            return `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Hor√°rio</th>
                                <th>Foto</th>
                                <th>SKU</th>
                                <th>Descri√ß√£o</th>
                                <th>Linha</th>
                                <th>Tipo</th>
                                <th>Quantidade</th>
                                <th>Pedido</th>
                                <th>Respons√°vel</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${state.movimentacoes.length === 0 ? `
                                <tr>
                                    <td colspan="10" style="text-align: center; padding: 60px 20px; color: #94a3b8;">
                                        <p style="font-size: 18px; font-weight: 600;">Nenhuma movimenta√ß√£o registrada</p>
                                    </td>
                                </tr>
                            ` : state.movimentacoes.map(m => `
                                <tr>
                                    <td>${m.data}</td>
                                    <td>${m.horario}</td>
                                    <td>
                                        ${m.foto ? 
                                            `<img src="${m.foto}" class="product-img" alt="${m.descricao}">` : 
                                            `<div class="img-placeholder">üì¶</div>`
                                        }
                                    </td>
                                    <td><strong>${m.sku}</strong></td>
                                    <td>${m.descricao}</td>
                                    <td><span class="badge badge-blue">${m.linha}</span></td>
                                    <td>
                                        <span class="badge ${m.tipo === 'entrada' ? 'badge-green' : 'badge-red'}">
                                            ${m.tipo === 'entrada' ? '‚Üë Entrada' : '‚Üì Sa√≠da'}
                                        </span>
                                    </td>
                                    <td><strong>${m.tipo === 'entrada' ? '+' : '-'}${m.quantidade}</strong></td>
                                    <td>${m.pedido || '-'}</td>
                                    <td>${m.responsavel}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderNovaMovimentacao() {
            return `
                <div class="form-card">
                    <form onsubmit="salvarMovimentacao(event); return false;">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Data</label>
                                <input type="text" value="${new Date().toLocaleDateString('pt-BR')}" disabled>
                            </div>
                            <div class="form-group">
                                <label>Hor√°rio</label>
                                <input type="text" value="${new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}" disabled>
                            </div>
                            <div class="form-group" style="grid-column: span 2;">
                                <label>SKU *</label>
                                <select id="mov-sku" required>
                                    <option value="">Selecione um produto...</option>
                                    ${state.produtos.filter(p => p.ativo && p.visivel).map(p => `
                                        <option value="${p.sku}">${p.sku} - ${p.descricao}</option>
                                    `).join('')}
                                </select>
                            </div>
                            <div class="form-group" style="grid-column: span 2;">
                                <label>Tipo de Movimenta√ß√£o *</label>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-primary" id="tipo-entrada" onclick="setTipoMovimento('entrada')">‚Üë Entrada</button>
                                    <button type="button" class="btn btn-secondary" id="tipo-saida" onclick="setTipoMovimento('saida')">‚Üì Sa√≠da</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Quantidade *</label>
                                <input type="number" id="mov-quantidade" min="1" required>
                            </div>
                            <div class="form-group">
                                <label>Pedido do Movimento</label>
                                <input type="text" id="mov-pedido" placeholder="Ex: #12345">
                            </div>
                            <div class="form-group" style="grid-column: span 2;">
                                <label>Respons√°vel *</label>
                                <select id="mov-responsavel" required>
                                    <option value="">Selecione um respons√°vel...</option>
                                    ${state.responsaveis.filter(r => r.ativo).map(r => `
                                        <option value="${r.nome} ${r.sobrenome}">${r.nome} ${r.sobrenome} - ${r.departamento}</option>
                                    `).join('')}
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 24px;">
                            üíæ Registrar Movimenta√ß√£o
                        </button>
                    </form>
                </div>
            `;
        }

        function renderNovoProduto() {
            return `
                <div class="form-card">
                    <h3>${state.editingItem ? 'Editar Produto' : 'Novo Produto'}</h3>
                    <form onsubmit="salvarProduto(event); return false;">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>SKU *</label>
                                <input type="text" id="prod-sku" placeholder="Ex: POL-001" value="${state.editingItem ? state.editingItem.sku : ''}" required>
                            </div>
                            <div class="form-group">
                                <label>Descri√ß√£o *</label>
                                <input type="text" id="prod-descricao" placeholder="Nome do produto" value="${state.editingItem ? state.editingItem.descricao : ''}" required>
                            </div>
                            <div class="form-group">
                                <label>Linha *</label>
                                <select id="prod-linha" required>
                                    <option value="">Selecione uma linha...</option>
                                    ${state.linhas.map(l => `
                                        <option value="${l.nome}" ${state.editingItem && state.editingItem.linha === l.nome ? 'selected' : ''}>${l.nome}</option>
                                    `).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Estoque Inicial</label>
                                <input type="number" id="prod-estoque" min="0" step="1" value="${state.editingItem ? state.editingItem.quantidade : 0}">
                            </div>
                            <div class="form-group">
                                <label>Estoque M√≠nimo</label>
                                <input type="number" id="prod-minimo" min="0" step="1" value="${state.editingItem ? state.editingItem.estoqueMinimo : 0}">
                            </div>
                            <div class="form-group">
                                <label>Valor de Custo (R$)</label>
                                <input type="number" id="prod-custo" min="0" step="0.01" placeholder="0.00" value="${state.editingItem ? (state.editingItem.valorCusto || '') : ''}">
                            </div>
                            <div class="form-group">
                                <label>Valor de Venda (R$)</label>
                                <input type="number" id="prod-venda" min="0" step="0.01" placeholder="0.00" value="${state.editingItem ? (state.editingItem.valorVenda || '') : ''}">
                            </div>
                            <div class="form-group">
                                <label>URL da Foto</label>
                                <input type="url" id="prod-foto" placeholder="https://..." value="${state.editingItem ? (state.editingItem.foto || '') : ''}">
                            </div>
                            <div class="form-group">
                                <label>Status</label>
                                <div class="radio-group">
                                    <label>
                                        <input type="radio" name="prod-ativo" value="true" ${!state.editingItem || state.editingItem.ativo ? 'checked' : ''}> Ativo
                                    </label>
                                    <label>
                                        <input type="radio" name="prod-ativo" value="false" ${state.editingItem && !state.editingItem.ativo ? 'checked' : ''}> Inativo
                                    </label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Visibilidade</label>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="prod-visivel" ${!state.editingItem || state.editingItem.visivel ? 'checked' : ''}>
                                    <label for="prod-visivel" style="margin: 0;">Produto vis√≠vel no estoque</label>
                                </div>
                                <small style="color: #64748b; margin-top: 4px;">Desmarque para ocultar produtos descontinuados</small>
                            </div>
                        </div>
                        <div style="display: flex; gap: 12px; margin-top: 24px;">
                            <button type="submit" class="btn btn-primary" style="flex: 1;">
                                üíæ ${state.editingItem ? 'Atualizar' : 'Cadastrar'} Produto
                            </button>
                            ${state.editingItem ? `
                                <button type="button" class="btn btn-secondary" onclick="state.editingItem = null; render()">
                                    Cancelar
                                </button>
                            ` : ''}
                        </div>
                    </form>
                </div>

                <div class="table-container">
                    <div style="padding: 20px; border-bottom: 1px solid #e2e8f0;">
                        <h3 style="font-size: 18px; font-weight: 700;">Produtos Cadastrados</h3>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>SKU</th>
                                <th>Descri√ß√£o</th>
                                <th>Linha</th>
                                <th>Quantidade</th>
                                ${hasPermission('view-values') ? '<th>Custo</th><th>Venda</th>' : ''}
                                <th>Status</th>
                                <th>Vis√≠vel</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${state.produtos.map(p => `
                                <tr>
                                    <td><strong>${p.sku}</strong></td>
                                    <td>${p.descricao}</td>
                                    <td><span class="badge badge-blue">${p.linha}</span></td>
                                    <td><strong>${p.quantidade}</strong></td>
                                    ${hasPermission('view-values') ? `
                                        <td>${formatCurrency(p.valorCusto)}</td>
                                        <td>${formatCurrency(p.valorVenda)}</td>
                                    ` : ''}
                                    <td>
                                        <span class="badge ${p.ativo ? 'badge-green' : 'badge-gray'}">
                                            ${p.ativo ? '‚úì Ativo' : '‚úó Inativo'}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge ${p.visivel ? 'badge-green' : 'badge-orange'}">
                                            ${p.visivel ? 'üëÅÔ∏è Sim' : 'üîí N√£o'}
                                        </span>
                                    </td>
                                    <td>
                                        <button class="icon-btn" onclick="editarProduto('${p.id}')">‚úèÔ∏è</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderNovoResponsavel() {
            return `
                <div class="form-card">
                    <h3>${state.editingItem ? 'Editar Respons√°vel' : 'Novo Respons√°vel'}</h3>
                    <form onsubmit="salvarResponsavel(event); return false;">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Nome *</label>
                                <input type="text" id="resp-nome" placeholder="Nome" value="${state.editingItem ? state.editingItem.nome : ''}" required>
                            </div>
                            <div class="form-group">
                                <label>Sobrenome *</label>
                                <input type="text" id="resp-sobrenome" placeholder="Sobrenome" value="${state.editingItem ? state.editingItem.sobrenome : ''}" required>
                            </div>
                            <div class="form-group">
                                <label>Departamento *</label>
                                <input type="text" id="resp-departamento" placeholder="Ex: Estoque, Comercial" value="${state.editingItem ? state.editingItem.departamento : ''}" required>
                            </div>
                            <div class="form-group">
                                <label>Status</label>
                                <div class="radio-group">
                                    <label>
                                        <input type="radio" name="resp-ativo" value="true" ${!state.editingItem || state.editingItem.ativo ? 'checked' : ''}> Ativo
                                    </label>
                                    <label>
                                        <input type="radio" name="resp-ativo" value="false" ${state.editingItem && !state.editingItem.ativo ? 'checked' : ''}> Inativo
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 12px; margin-top: 24px;">
                            <button type="submit" class="btn btn-primary" style="flex: 1;">
                                üíæ ${state.editingItem ? 'Atualizar' : 'Cadastrar'} Respons√°vel
                            </button>
                            ${state.editingItem ? `
                                <button type="button" class="btn btn-secondary" onclick="state.editingItem = null; render()">
                                    Cancelar
                                </button>
                            ` : ''}
                        </div>
                    </form>
                </div>

                <div class="table-container">
                    <div style="padding: 20px; border-bottom: 1px solid #e2e8f0;">
                        <h3 style="font-size: 18px; font-weight: 700;">Respons√°veis Cadastrados</h3>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Sobrenome</th>
                                <th>Departamento</th>
                                <th>Status</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${state.responsaveis.map(r => `
                                <tr>
                                    <td><strong>${r.nome}</strong></td>
                                    <td>${r.sobrenome}</td>
                                    <td><span class="badge badge-purple">${r.departamento}</span></td>
                                    <td>
                                        <span class="badge ${r.ativo ? 'badge-green' : 'badge-gray'}">
                                            ${r.ativo ? '‚úì Ativo' : '‚úó Inativo'}
                                        </span>
                                    </td>
                                    <td>
                                        <div style="display: flex; gap: 8px;">
                                            <button class="icon-btn" onclick="editarResponsavel('${r.id}')">‚úèÔ∏è</button>
                                            <button class="icon-btn delete" onclick="deletarResponsavel('${r.id}')">üóëÔ∏è</button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderNovaLinha() {
            return `
                <div class="form-card">
                    <h3>${state.editingItem ? 'Editar Linha' : 'Nova Linha'}</h3>
                    <form onsubmit="salvarLinha(event); return false;">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>C√≥digo da Linha *</label>
                                <input type="text" id="linha-codigo" placeholder="Ex: TIN, VER" value="${state.editingItem ? state.editingItem.codigo : ''}" required>
                            </div>
                            <div class="form-group">
                                <label>Nome da Linha *</label>
                                <input type="text" id="linha-nome" placeholder="Ex: Tintas, Vernizes" value="${state.editingItem ? state.editingItem.nome : ''}" required>
                            </div>
                        </div>
                        <div style="display: flex; gap: 12px; margin-top: 24px;">
                            <button type="submit" class="btn btn-primary" style="flex: 1;">
                                üíæ ${state.editingItem ? 'Atualizar' : 'Cadastrar'} Linha
                            </button>
                            ${state.editingItem ? `
                                <button type="button" class="btn btn-secondary" onclick="state.editingItem = null; render()">
                                    Cancelar
                                </button>
                            ` : ''}
                        </div>
                    </form>
                </div>

                <div class="table-container">
                    <div style="padding: 20px; border-bottom: 1px solid #e2e8f0;">
                        <h3 style="font-size: 18px; font-weight: 700;">Linhas Cadastradas</h3>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>C√≥digo</th>
                                <th>Nome da Linha</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${state.linhas.map(l => `
                                <tr>
                                    <td><strong>${l.codigo}</strong></td>
                                    <td><span class="badge badge-blue">${l.nome}</span></td>
                                    <td>
                                        <div style="display: flex; gap: 8px;">
                                            <button class="icon-btn" onclick="editarLinha('${l.id}')">‚úèÔ∏è</button>
                                            <button class="icon-btn delete" onclick="deletarLinha('${l.id}')">üóëÔ∏è</button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderUsuarios() {
            return `
                <div class="form-card">
                    <h3>${state.editingItem ? 'Editar Usu√°rio' : 'Novo Usu√°rio'}</h3>
                    <form onsubmit="salvarUsuario(event); return false;">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Nome Completo *</label>
                                <input type="text" id="user-nome" placeholder="Nome do usu√°rio" value="${state.editingItem ? state.editingItem.nome : ''}" required>
                            </div>
                            <div class="form-group">
                                <label>Nome de Usu√°rio (Login) *</label>
                                <input type="text" id="user-username" placeholder="Ex: joao.silva" value="${state.editingItem ? state.editingItem.username : ''}" ${state.editingItem && state.editingItem.username === 'admin' ? 'disabled' : ''} required>
                                ${state.editingItem && state.editingItem.username === 'admin' ? '<small style="color: #64748b;">Admin n√£o pode ser alterado</small>' : ''}
                            </div>
                            <div class="form-group">
                                <label>Senha *</label>
                                <input type="password" id="user-password" placeholder="${state.editingItem ? 'Deixe vazio para manter a senha atual' : 'Senha'}" ${!state.editingItem ? 'required' : ''}>
                            </div>
                            <div class="form-group">
                                <label>N√≠vel de Acesso *</label>
                                <select id="user-role" required ${state.editingItem && state.editingItem.username === 'admin' ? 'disabled' : ''}>
                                    <option value="admin" ${state.editingItem && state.editingItem.role === 'admin' ? 'selected' : ''}>üëë Administrador (Acesso Total)</option>
                                    <option value="operador" ${state.editingItem && state.editingItem.role === 'operador' ? 'selected' : ''}>‚öôÔ∏è Operador (Movimenta√ß√µes, sem valores)</option>
                                    <option value="leitor" ${state.editingItem && state.editingItem.role === 'leitor' ? 'selected' : ''}>üëÅÔ∏è Leitor (Apenas Visualiza√ß√£o)</option>
                                </select>
                                ${state.editingItem && state.editingItem.username === 'admin' ? '<small style="color: #64748b;">Admin sempre mant√©m acesso total</small>' : ''}
                            </div>
                        </div>
                        <div style="display: flex; gap: 12px; margin-top: 24px;">
                            <button type="submit" class="btn btn-primary" style="flex: 1;">
                                üíæ ${state.editingItem ? 'Atualizar' : 'Cadastrar'} Usu√°rio
                            </button>
                            ${state.editingItem ? `
                                <button type="button" class="btn btn-secondary" onclick="state.editingItem = null; render()">
                                    Cancelar
                                </button>
                            ` : ''}
                        </div>
                    </form>
                </div>

                <div class="table-container">
                    <div style="padding: 20px; border-bottom: 1px solid #e2e8f0;">
                        <h3 style="font-size: 18px; font-weight: 700;">Usu√°rios Cadastrados</h3>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Usu√°rio (Login)</th>
                                <th>N√≠vel de Acesso</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${state.usuarios.map(u => `
                                <tr>
                                    <td><strong>${u.nome}</strong></td>
                                    <td>${u.username}</td>
                                    <td>
                                        <span class="badge ${
                                            u.role === 'admin' ? 'badge-purple' : 
                                            u.role === 'operador' ? 'badge-blue' : 
                                            'badge-gray'
                                        }">
                                            ${
                                                u.role === 'admin' ? 'üëë Administrador' : 
                                                u.role === 'operador' ? '‚öôÔ∏è Operador' : 
                                                'üëÅÔ∏è Leitor'
                                            }
                                        </span>
                                    </td>
                                    <td>
                                        <div style="display: flex; gap: 8px;">
                                            <button class="icon-btn" onclick="editarUsuario('${u.id}')">‚úèÔ∏è</button>
                                            ${u.username !== 'admin' ? `
                                                <button class="icon-btn delete" onclick="deletarUsuario('${u.id}')">üóëÔ∏è</button>
                                            ` : ''}
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderConfiguracoes() {
            return `
                <div class="form-card">
                    <div class="config-section">
                        <h4>‚ÑπÔ∏è N√≠veis de Acesso</h4>
                        <div style="background: #f8fafc; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                            <p style="margin-bottom: 12px;"><strong>üëë Administrador:</strong></p>
                            <ul style="margin-left: 20px; margin-bottom: 16px; color: #64748b;">
                                <li>Acesso total ao sistema</li>
                                <li>Visualiza valores de custo e venda</li>
                                <li>Cadastra produtos, respons√°veis, linhas e usu√°rios</li>
                                <li>Edita e exclui todos os dados</li>
                                <li>Acessa configura√ß√µes e backup</li>
                            </ul>
                            
                            <p style="margin-bottom: 12px;"><strong>‚öôÔ∏è Operador:</strong></p>
                            <ul style="margin-left: 20px; margin-bottom: 16px; color: #64748b;">
                                <li>Visualiza estoque (sem valores financeiros)</li>
                                <li>Registra movimenta√ß√µes de entrada e sa√≠da</li>
                                <li>Consulta produtos</li>
                                <li>N√£o pode cadastrar ou editar produtos</li>
                            </ul>
                            
                            <p style="margin-bottom: 12px;"><strong>üëÅÔ∏è Leitor:</strong></p>
                            <ul style="margin-left: 20px; color: #64748b;">
                                <li>Apenas visualiza√ß√£o do estoque</li>
                                <li>N√£o visualiza valores financeiros</li>
                                <li>N√£o pode fazer movimenta√ß√µes</li>
                                <li>N√£o pode cadastrar ou editar nada</li>
                            </ul>
                        </div>
                    </div>

                    <div class="config-section">
                        <h4>üóëÔ∏è Limpar Dados</h4>
                        <p style="color: #64748b; margin-bottom: 16px;">Remova dados espec√≠ficos do sistema. Esta a√ß√£o n√£o pode ser desfeita.</p>
                        <div class="config-actions">
                            <button class="btn btn-danger" onclick="zerarProdutos()">
                                Zerar Produtos
                            </button>
                            <button class="btn btn-danger" onclick="zerarMovimentacoes()">
                                Zerar Movimenta√ß√µes
                            </button>
                            <button class="btn btn-danger" onclick="zerarResponsaveis()">
                                Zerar Respons√°veis
                            </button>
                            <button class="btn btn-danger" onclick="zerarLinhas()">
                                Zerar Linhas
                            </button>
                            <button class="btn btn-danger" onclick="zerarTudo()">
                                ‚ö†Ô∏è Zerar TODOS os Dados
                            </button>
                        </div>
                    </div>

                    <div class="config-section">
                        <h4>üíæ Backup e Restaura√ß√£o</h4>
                        <p style="color: #64748b; margin-bottom: 16px;">Fa√ßa backup dos seus dados ou restaure de um arquivo anterior.</p>
                        <div class="config-actions">
                            <button class="btn btn-primary" onclick="exportarBackup()">
                                üì• Baixar Backup Completo
                            </button>
                            <button class="btn btn-secondary" onclick="document.getElementById('import-backup').click()">
                                üì§ Restaurar de Backup
                            </button>
                            <input type="file" id="import-backup" accept=".json" style="display: none;" onchange="importarBackup(event)">
                        </div>
                    </div>

                    <div class="config-section">
                        <h4>‚ÑπÔ∏è Sobre o Sistema</h4>
                        <p style="color: #64748b; margin-bottom: 8px;">Sistema de Estoque Policryl v1.0</p>
                        <p style="color: #64748b; margin-bottom: 8px;">Desenvolvido para gest√£o completa de invent√°rio</p>
                        <p style="color: #64748b;">¬© 2025 Policryl - Todos os direitos reservados</p>
                    </div>
                </div>
            `;
        }

        // ==================== ACTIONS ====================
        let tipoMovimento = 'entrada';

        function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            
            if (login(username, password)) {
                render();
                showAlert('Login realizado com sucesso!');
            } else {
                showAlert('Usu√°rio ou senha incorretos', 'error');
            }
        }

        function setTipoMovimento(tipo) {
            tipoMovimento = tipo;
            const entradaBtn = document.getElementById('tipo-entrada');
            const saidaBtn = document.getElementById('tipo-saida');
            if (entradaBtn && saidaBtn) {
                entradaBtn.className = tipo === 'entrada' ? 'btn btn-primary' : 'btn btn-secondary';
                saidaBtn.className = tipo === 'saida' ? 'btn btn-primary' : 'btn btn-secondary';
            }
        }

        function salvarMovimentacao(e) {
            e.preventDefault();
            const sku = document.getElementById('mov-sku').value;
            const quantidade = parseInt(document.getElementById('mov-quantidade').value);
            const pedido = document.getElementById('mov-pedido').value;
            const responsavel = document.getElementById('mov-responsavel').value;

            const produto = state.produtos.find(p => p.sku === sku);
            if (!produto) {
                showAlert('Produto n√£o encontrado', 'error');
                return;
            }

            const novaQuantidade = tipoMovimento === 'entrada' ? produto.quantidade + quantidade : produto.quantidade - quantidade;
            if (novaQuantidade < 0) {
                showAlert('Quantidade insuficiente em estoque', 'error');
                return;
            }

            const novaMovimentacao = {
                id: Date.now().toString(),
                sku,
                descricao: produto.descricao,
                linha: produto.linha,
                foto: produto.foto,
                tipo: tipoMovimento,
                quantidade,
                pedido,
                responsavel,
                data: new Date().toLocaleDateString('pt-BR'),
                horario: new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })
            };

            state.movimentacoes = [novaMovimentacao, ...state.movimentacoes];
            state.produtos = state.produtos.map(p => 
                p.sku === sku ? { ...p, quantidade: novaQuantidade, ultimaAtualizacao: new Date().toISOString() } : p
            );

            storage.set('policryl-movimentacoes', state.movimentacoes);
            storage.set('policryl-produtos', state.produtos);

            showAlert('Movimenta√ß√£o registrada com sucesso!');
            e.target.reset();
            tipoMovimento = 'entrada';
            render();
        }

        function salvarProduto(e) {
            e.preventDefault();
            const sku = document.getElementById('prod-sku').value;
            const descricao = document.getElementById('prod-descricao').value;
            const linha = document.getElementById('prod-linha').value;
            const estoqueInicial = parseInt(document.getElementById('prod-estoque').value) || 0;
            const estoqueMinimo = parseInt(document.getElementById('prod-minimo').value) || 0;
            const valorCusto = parseFloat(document.getElementById('prod-custo').value) || 0;
            const valorVenda = parseFloat(document.getElementById('prod-venda').value) || 0;
            const foto = document.getElementById('prod-foto').value;
            const ativo = document.querySelector('input[name="prod-ativo"]:checked').value === 'true';
            const visivel = document.getElementById('prod-visivel').checked;

            if (state.editingItem) {
                state.produtos = state.produtos.map(p => 
                    p.id === state.editingItem.id 
                        ? { ...p, sku, descricao, linha, estoqueMinimo, valorCusto, valorVenda, foto, ativo, visivel, ultimaAtualizacao: new Date().toISOString() }
                        : p
                );
                showAlert('Produto atualizado com sucesso!');
                state.editingItem = null;
            } else {
                const novoProduto = {
                    id: Date.now().toString(),
                    sku,
                    descricao,
                    linha,
                    quantidade: estoqueInicial,
                    estoqueMinimo,
                    valorCusto,
                    valorVenda,
                    foto,
                    ativo,
                    visivel,
                    ultimaAtualizacao: new Date().toISOString()
                };
                state.produtos.push(novoProduto);
                showAlert('Produto cadastrado com sucesso!');
            }

            storage.set('policryl-produtos', state.produtos);
            e.target.reset();
            render();
        }

        function salvarResponsavel(e) {
            e.preventDefault();
            const nome = document.getElementById('resp-nome').value;
            const sobrenome = document.getElementById('resp-sobrenome').value;
            const departamento = document.getElementById('resp-departamento').value;
            const ativo = document.querySelector('input[name="resp-ativo"]:checked').value === 'true';

            if (state.editingItem) {
                state.responsaveis = state.responsaveis.map(r => 
                    r.id === state.editingItem.id ? { ...r, nome, sobrenome, departamento, ativo } : r
                );
                showAlert('Respons√°vel atualizado com sucesso!');
                state.editingItem = null;
            } else {
                const novoResponsavel = {
                    id: Date.now().toString(),
                    nome,
                    sobrenome,
                    departamento,
                    ativo
                };
                state.responsaveis.push(novoResponsavel);
                showAlert('Respons√°vel cadastrado com sucesso!');
            }

            storage.set('policryl-responsaveis', state.responsaveis);
            e.target.reset();
            render();
        }

        function salvarLinha(e) {
            e.preventDefault();
            const codigo = document.getElementById('linha-codigo').value;
            const nome = document.getElementById('linha-nome').value;

            if (state.editingItem) {
                state.linhas = state.linhas.map(l => 
                    l.id === state.editingItem.id ? { ...l, codigo, nome } : l
                );
                showAlert('Linha atualizada com sucesso!');
                state.editingItem = null;
            } else {
                const novaLinha = {
                    id: Date.now().toString(),
                    codigo,
                    nome
                };
                state.linhas.push(novaLinha);
                showAlert('Linha cadastrada com sucesso!');
            }

            storage.set('policryl-linhas', state.linhas);
            e.target.reset();
            render();
        }

        function editarProduto(id) {
            const produto = state.produtos.find(p => p.id === id);
            state.editingItem = produto;
            window.scrollTo({ top: 0, behavior: 'smooth' });
            render();
        }

        function editarResponsavel(id) {
            const responsavel = state.responsaveis.find(r => r.id === id);
            state.editingItem = responsavel;
            window.scrollTo({ top: 0, behavior: 'smooth' });
            render();
        }

        function editarLinha(id) {
            const linha = state.linhas.find(l => l.id === id);
            state.editingItem = linha;
            window.scrollTo({ top: 0, behavior: 'smooth' });
            render();
        }

        function deletarResponsavel(id) {
            if (confirm('Tem certeza que deseja excluir este respons√°vel?')) {
                state.responsaveis = state.responsaveis.filter(r => r.id !== id);
                storage.set('policryl-responsaveis', state.responsaveis);
                showAlert('Respons√°vel exclu√≠do com sucesso!');
                render();
            }
        }

        function deletarLinha(id) {
            if (confirm('Tem certeza que deseja excluir esta linha?')) {
                state.linhas = state.linhas.filter(l => l.id !== id);
                storage.set('policryl-linhas', state.linhas);
                showAlert('Linha exclu√≠da com sucesso!');
                render();
            }
        }

        function changeTab(tab) {
            state.activeTab = tab;
            state.editingItem = null;
            render();
        }

        // Configura√ß√µes
        function zerarProdutos() {
            if (confirm('Tem certeza que deseja ZERAR todos os produtos? Esta a√ß√£o n√£o pode ser desfeita!')) {
                state.produtos = [];
                storage.set('policryl-produtos', state.produtos);
                showAlert('Produtos zerados com sucesso!');
                render();
            }
        }

        function zerarMovimentacoes() {
            if (confirm('Tem certeza que deseja ZERAR todas as movimenta√ß√µes? Esta a√ß√£o n√£o pode ser desfeita!')) {
                state.movimentacoes = [];
                storage.set('policryl-movimentacoes', state.movimentacoes);
                showAlert('Movimenta√ß√µes zeradas com sucesso!');
                render();
            }
        }

        function zerarResponsaveis() {
            if (confirm('Tem certeza que deseja ZERAR todos os respons√°veis? Esta a√ß√£o n√£o pode ser desfeita!')) {
                state.responsaveis = [];
                storage.set('policryl-responsaveis', state.responsaveis);
                showAlert('Respons√°veis zerados com sucesso!');
                render();
            }
        }

        function zerarLinhas() {
            if (confirm('Tem certeza que deseja ZERAR todas as linhas? Esta a√ß√£o n√£o pode ser desfeita!')) {
                state.linhas = [];
                storage.set('policryl-linhas', state.linhas);
                showAlert('Linhas zeradas com sucesso!');
                render();
            }
        }

        function zerarTudo() {
            if (confirm('‚ö†Ô∏è ATEN√á√ÉO! Tem certeza que deseja ZERAR TODOS OS DADOS? Esta a√ß√£o n√£o pode ser desfeita!')) {
                if (confirm('Confirme novamente: Deseja realmente apagar TUDO?')) {
                    localStorage.clear();
                    showAlert('Todos os dados foram zerados! Recarregando...');
                    setTimeout(() => location.reload(), 2000);
                }
            }
        }

        function exportarBackup() {
            const backup = {
                produtos: state.produtos,
                movimentacoes: state.movimentacoes,
                responsaveis: state.responsaveis,
                linhas: state.linhas,
                usuarios: state.usuarios,
                data: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `backup_policryl_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            showAlert('Backup exportado com sucesso!');
        }

        function importarBackup(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backup = JSON.parse(e.target.result);
                    
                    if (confirm('Tem certeza que deseja restaurar este backup? Os dados atuais ser√£o substitu√≠dos!')) {
                        state.produtos = backup.produtos || [];
                        state.movimentacoes = backup.movimentacoes || [];
                        state.responsaveis = backup.responsaveis || [];
                        state.linhas = backup.linhas || [];
                        
                        storage.set('policryl-produtos', state.produtos);
                        storage.set('policryl-movimentacoes', state.movimentacoes);
                        storage.set('policryl-responsaveis', state.responsaveis);
                        storage.set('policryl-linhas', state.linhas);
                        
                        showAlert('Backup restaurado com sucesso!');
                        render();
                    }
                } catch (error) {
                    showAlert('Erro ao ler arquivo de backup', 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function salvarUsuario(e) {
            e.preventDefault();
            const nome = document.getElementById('user-nome').value;
            const username = document.getElementById('user-username').value;
            const password = document.getElementById('user-password').value;
            const role = document.getElementById('user-role').value;

            // Validar username √∫nico
            if (!state.editingItem) {
                const usernameExists = state.usuarios.find(u => u.username === username);
                if (usernameExists) {
                    showAlert('Este nome de usu√°rio j√° existe!', 'error');
                    return;
                }
            }

            if (state.editingItem) {
                state.usuarios = state.usuarios.map(u => {
                    if (u.id === state.editingItem.id) {
                        const updated = { ...u, nome };
                        // Admin sempre mant√©m admin role e username
                        if (u.username !== 'admin') {
                            updated.role = role;
                            if (password) updated.password = password;
                        }
                        return updated;
                    }
                    return u;
                });
                showAlert('Usu√°rio atualizado com sucesso!');
                state.editingItem = null;
            } else {
                const novoUsuario = {
                    id: Date.now().toString(),
                    username,
                    password,
                    nome,
                    role
                };
                state.usuarios.push(novoUsuario);
                showAlert('Usu√°rio cadastrado com sucesso!');
            }

            storage.set('policryl-usuarios', state.usuarios);
            e.target.reset();
            render();
        }

        function editarUsuario(id) {
            const usuario = state.usuarios.find(u => u.id === id);
            state.editingItem = usuario;
            window.scrollTo({ top: 0, behavior: 'smooth' });
            render();
        }

        function deletarUsuario(id) {
            const usuario = state.usuarios.find(u => u.id === id);
            if (usuario.username === 'admin') {
                showAlert('O usu√°rio Admin n√£o pode ser exclu√≠do!', 'error');
                return;
            }

            if (confirm(`Tem certeza que deseja excluir o usu√°rio "${usuario.nome}"?`)) {
                state.usuarios = state.usuarios.filter(u => u.id !== id);
                storage.set('policryl-usuarios', state.usuarios);
                showAlert('Usu√°rio exclu√≠do com sucesso!');
                render();
            }
        }

        // ==================== RENDER ====================
        function render() {
            const app = document.getElementById('app');
            
            if (!state.currentUser) {
                app.innerHTML = renderLogin();
                return;
            }

            app.innerHTML = `
                <div class="app-container">
                    ${renderSidebar()}
                    <div class="main-content">
                        ${renderHeader()}
                        <div id="alert-container"></div>
                        <main class="content-area">
                            ${
                                state.activeTab === 'dashboard' ? renderDashboard() :
                                state.activeTab === 'consulta' ? renderConsulta() :
                                state.activeTab === 'estoque' ? renderEstoqueGeral() :
                                state.activeTab === 'movimentacoes' ? renderMovimentacoes() :
                                state.activeTab === 'nova-movimentacao' ? renderNovaMovimentacao() :
                                state.activeTab === 'novo-produto' ? renderNovoProduto() :
                                state.activeTab === 'novo-responsavel' ? renderNovoResponsavel() :
                                state.activeTab === 'nova-linha' ? renderNovaLinha() :
                                state.activeTab === 'usuarios' ? renderUsuarios() :
                                state.activeTab === 'configuracoes' ? renderConfiguracoes() :
                                ''
                            }
                        </main>
                    </div>
                </div>
            `;

            if (state.activeTab === 'nova-movimentacao') {
                setTimeout(() => setTipoMovimento('entrada'), 0);
            }
        }

        // ==================== INIT ====================
        initData();
        render();
    </script>
</body>
</html><!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Estoque Policryl</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
            overflow: hidden;
        }

        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-box {
            background: white;
            padding: 48px;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 420px;
        }

        .login-box h1 {
            font-size: 32px;
            color: #10b981;
            margin-bottom: 8px;
        }

        .login-box p {
            color: #64748b;
            margin-bottom: 32px;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 260px;
            background: linear-gradient(180deg, #334155 0%, #1e293b 100%);
            color: white;
            display: flex;
            flex-direction: column;
            box-shadow: 4px 0 20px rgba(0,0,0,0.15);
        }

        .sidebar-header {
            padding: 24px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .sidebar-header h1 {
            font-size: 24px;
            font-weight: 700;
            color: #10b981;
            margin-bottom: 4px;
        }

        .sidebar-header p {
            font-size: 13px;
            color: #94a3b8;
        }

        .user-info {
            padding: 16px 20px;
            background: rgba(16, 185, 129, 0.1);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .user-info .name {
            font-weight: 600;
            font-size: 14px;
        }

        .user-info .role {
            font-size: 12px;
            color: #10b981;
            margin-top: 2px;
        }

        .sidebar-nav {
            flex: 1;
            overflow-y: auto;
            padding: 16px 0;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            color: #cbd5e1;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 14px;
        }

        .nav-item:hover {
            background: #475569;
            color: white;
        }

        .nav-item.active {
            background: #10b981;
            color: white;
            font-weight: 600;
        }

        .nav-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .logout-btn {
            margin: 16px 20px;
            padding: 12px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }

        .logout-btn:hover {
            background: #dc2626;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background: white;
            border-bottom: 1px solid #e2e8f0;
            padding: 20px 32px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .header h2 {
            font-size: 24px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 4px;
        }

        .header p {
            font-size: 14px;
            color: #64748b;
        }

        .header-actions {
            margin-top: 16px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #10b981;
            color: white;
        }

        .btn-primary:hover {
            background: #059669;
        }

        .btn-secondary {
            background: #64748b;
            color: white;
        }

        .btn-secondary:hover {
            background: #475569;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 32px;
        }

        .alert {
            padding: 16px 24px;
            margin: 0 32px 0 32px;
            margin-top: 16px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
            animation: slideDown 0.3s;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
        }

        .stat-card.blue {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        }

        .stat-card.gray {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            box-shadow: 0 4px 12px rgba(107, 114, 128, 0.2);
        }

        .stat-card.yellow {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.2);
        }

        .stat-card.red {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.2);
        }

        .stat-card.purple {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.2);
        }

        .stat-card h3 {
            font-size: 13px;
            opacity: 0.9;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .stat-card .value {
            font-size: 36px;
            font-weight: 700;
        }

        .filters {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 24px;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-size: 13px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 10px 14px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .table-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        th {
            padding: 14px 20px;
            text-align: left;
            font-size: 11px;
            font-weight: 700;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: 16px 20px;
            border-bottom: 1px solid #f1f5f9;
            font-size: 14px;
            color: #334155;
        }

        tbody tr:hover {
            background: #f8fafc;
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        .product-img {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            object-fit: cover;
        }

        .img-placeholder {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            background: #f1f5f9;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #94a3b8;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-danger {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-blue {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-purple {
            background: #e9d5ff;
            color: #6b21a8;
        }

        .badge-green {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-red {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-gray {
            background: #f3f4f6;
            color: #4b5563;
        }

        .badge-orange {
            background: #ffedd5;
            color: #9a3412;
        }

        .consulta-box {
            background: white;
            padding: 32px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .consulta-search {
            display: flex;
            gap: 12px;
            margin-bottom: 32px;
        }

        .consulta-search input {
            flex: 1;
            padding: 14px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
        }

        .consulta-result {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 24px;
        }

        .info-card {
            padding: 20px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .info-card.highlight {
            background: #d1fae5;
            border-color: #6ee7b7;
        }

        .info-card label {
            font-size: 12px;
            color: #64748b;
            margin-bottom: 6px;
            display: block;
        }

        .info-card .value {
            font-size: 20px;
            font-weight: 700;
            color: #1e293b;
        }

        .info-card.highlight .value {
            color: #065f46;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #94a3b8;
        }

        .form-card {
            background: white;
            padding: 32px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 24px;
        }

        .form-card h3 {
            font-size: 18px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 24px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .radio-group {
            display: flex;
            gap: 20px;
        }

        .radio-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .btn-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .icon-btn {
            padding: 8px;
            background: none;
            border: none;
            cursor: pointer;
            color: #3b82f6;
            transition: color 0.2s;
        }

        .icon-btn:hover {
            color: #2563eb;
        }

        .icon-btn.delete {
            color: #ef4444;
        }

        .icon-btn.delete:hover {
            color: #dc2626;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 32px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-content h3 {
            font-size: 20px;
            margin-bottom: 20px;
        }

        .config-section {
            margin-bottom: 32px;
            padding-bottom: 32px;
            border-bottom: 1px solid #e2e8f0;
        }

        .config-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .config-section h4 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #1e293b;
        }

        .config-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .hidden {
            display: none !important;
        }

        .blur-value {
            filter: blur(6px);
            user-select: none;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 80px;
            }

            .sidebar-header h1,
            .sidebar-header p,
            .nav-item span:last-child,
            .user-info {
                display: none;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .content-area {
                padding: 16px;
            }
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        // ==================== STORAGE ====================
        const storage = {
            get(key) {
                try {
                    const data = localStorage.getItem(key);
                    return data ? JSON.parse(data) : null;
                } catch (error) {
                    console.error('Erro ao ler storage:', error);
                    return null;
                }
            },
            set(key, value) {
                try {
                    localStorage.setItem(key, JSON.stringify(value));
                    return true;
                } catch (error) {
                    console.error('Erro ao salvar storage:', error);
                    return false;
                }
            },
            remove(key) {
                try {
                    localStorage.removeItem(key);
                    return true;
                } catch (error) {
                    console.error('Erro ao remover storage:', error);
                    return false;
                }
            }
        };

        // ==================== STATE ====================
        let state = {
            currentUser: null,
            activeTab: 'dashboard',
            produtos: [],
            movimentacoes: [],
            responsaveis: [],
            linhas: [],
            usuarios: [],
            searchTerm: '',
            filterStatus: 'todos',
            filterLinha: 'todas',
            filterVisibilidade: 'todos',
            sortBy: 'status',
            sortOrder: 'asc',
            consultaSKU: '',
            editingItem: null,
            showModal: false
        };

        // ==================== INIT DATA ====================
        function initData() {
            // Carregar usu√°rios - Admin sempre existe
            let usuarios = storage.get('policryl-usuarios');
            if (!usuarios || usuarios.length === 0) {
                usuarios = [
                    { id: '1', username: 'admin', password: 'admin123', nome: 'Administrador', role: 'admin' }
                ];
                storage.set('policryl-usuarios', usuarios);
            } else {
                // Garantir que admin sempre existe
                const adminExists = usuarios.find(u => u.username === 'admin');
                if (!adminExists) {
                    usuarios.unshift({ id: '1', username: 'admin', password: 'admin123', nome: 'Administrador', role: 'admin' });
                    storage.set('policryl-usuarios', usuarios);
                }
            }
            state.usuarios = usuarios;

            // Carregar produtos
            let produtos = storage.get('policryl-produtos');
            if (!produtos) {
                produtos = [
                    { id: '1', sku: 'POL-001', descricao: 'Tinta Acr√≠lica Branca 18L', linha: 'Tintas', quantidade: 150, estoqueMinimo: 50, valorCusto: 85.50, valorVenda: 142.90, foto: '', ativo: true, visivel: true, ultimaAtualizacao: new Date().toISOString() },
                    { id: '2', sku: 'POL-002', descricao: 'Verniz Acr√≠lico 3.6L', linha: 'Vernizes', quantidade: 35, estoqueMinimo: 40, valorCusto: 42.00, valorVenda: 78.90, foto: '', ativo: true, visivel: true, ultimaAtualizacao: new Date().toISOString() },
                    { id: '3', sku: 'POL-003', descricao: 'Primer Acr√≠lico 18L', linha: 'Primers', quantidade: 80, estoqueMinimo: 30, valorCusto: 68.00, valorVenda: 125.90, foto: '', ativo: true, visivel: true, ultimaAtualizacao: new Date().toISOString() },
                    { id: '4', sku: 'POL-004', descricao: 'Massa Acr√≠lica 25kg', linha: 'Massas', quantidade: 25, estoqueMinimo: 20, valorCusto: 95.00, valorVenda: 168.50, foto: '', ativo: true, visivel: true, ultimaAtualizacao: new Date().toISOString() },
                    { id: '5', sku: 'POL-005', descricao: 'Selador Acr√≠lico 18L', linha: 'Seladores', quantidade: 15, estoqueMinimo: 25, valorCusto: 52.00, valorVenda: 98.90, foto: '', ativo: true, visivel: true, ultimaAtualizacao: new Date().toISOString() }
                ];
                storage.set('policryl-produtos', produtos);
            }
            state.produtos = produtos;

            let movimentacoes = storage.get('policryl-movimentacoes');
            state.movimentacoes = movimentacoes || [];

            let responsaveis = storage.get('policryl-responsaveis');
            if (!responsaveis) {
                responsaveis = [
                    { id: '1', nome: 'Jo√£o', sobrenome: 'Silva', departamento: 'Estoque', ativo: true },
                    { id: '2', nome: 'Maria', sobrenome: 'Santos', departamento: 'Comercial', ativo: true },
                    { id: '3', nome: 'Pedro', sobrenome: 'Costa', departamento: 'Qualidade', ativo: true }
                ];
                storage.set('policryl-responsaveis', responsaveis);
            }
            state.responsaveis = responsaveis;

            let linhas = storage.get('policryl-linhas');
            if (!linhas) {
                linhas = [
                    { id: '1', codigo: 'TIN', nome: 'Tintas' },
                    { id: '2', codigo: 'VER', nome: 'Vernizes' },
                    { id: '3', codigo: 'PRI', nome: 'Primers' },
                    { id: '4', codigo: 'MAS', nome: 'Massas' },
                    { id: '5', codigo: 'SEL', nome: 'Seladores' }
                ];
                storage.set('policryl-linhas', linhas);
            }
            state.linhas = linhas;

            // Verificar se h√° usu√°rio logado
            const currentUser = storage.get('policryl-current-user');
            state.currentUser = currentUser;
        }

        // ==================== AUTH ====================
        function login(username, password) {
            console.log('Tentando login:', username);
            console.log('Usu√°rios dispon√≠veis:', state.usuarios);
            
            const user = state.usuarios.find(u => u.username === username && u.password === password);
            console.log('Usu√°rio encontrado:', user);
            
            if (user) {
                state.currentUser = user;
                storage.set('policryl-current-user', user);
                return true;
            }
            return false;
        }

        function logout() {
            state.currentUser = null;
            storage.remove('policryl-current-user');
            render();
        }

        function hasPermission(action) {
            if (!state.currentUser) return false;
            
            const permissions = {
                'admin': ['view', 'edit', 'create', 'delete', 'view-values', 'config'],
                'operador': ['view', 'create-movimento'],
                'leitor': ['view']
            };

            return permissions[state.currentUser.role]?.includes(action) || false;
        }

        // ==================== HELPERS ====================
        function getStatusProduto(produto) {
            if (produto.quantidade < produto.estoqueMinimo) return 'abaixo';
            if (produto.quantidade <= produto.estoqueMinimo * 1.2) return 'proximo';
            return 'ok';
        }

        function getStatusLabel(status) {
            const labels = {
                'abaixo': 'Abaixo do M√≠nimo',
                'proximo': 'Pr√≥ximo do M√≠nimo',
                'ok': 'OK'
            };
            return labels[status] || 'OK';
        }

        function formatCurrency(value) {
            if (!hasPermission('view-values')) return '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
            return `R$ ${parseFloat(value || 0).toFixed(2).replace('.', ',')}`;
        }

        function calcularEstatisticas() {
            const produtosVisiveis = state.produtos.filter(p => p.visivel);
            const total = produtosVisiveis.length;
            const ativos = produtosVisiveis.filter(p => p.ativo).length;
            const inativos = produtosVisiveis.filter(p => !p.ativo).length;
            const ok = produtosVisiveis.filter(p => getStatusProduto(p) === 'ok').length;
            const proximo = produtosVisiveis.filter(p => getStatusProduto(p) === 'proximo').length;
            const abaixo = produtosVisiveis.filter(p => getStatusProduto(p) === 'abaixo').length;
            
            const valorTotalEstoque = produtosVisiveis.reduce((acc, p) => acc + (p.quantidade * (p.valorCusto || 0)), 0);
            const valorTotalVenda = produtosVisiveis.reduce((acc, p) => acc + (p.quantidade * (p.valorVenda || 0)), 0);

            return { total, ativos, inativos, ok, proximo, abaixo, valorTotalEstoque, valorTotalVenda };
        }

        function showAlert(message, type = 'success') {
            const container = document.getElementById('alert-container');
            if (container) {
                container.innerHTML = `
                    <div class="alert alert-${type}">
                        <span>${message}</span>
                    </div>
                `;
                setTimeout(() => {
                    container.innerHTML = '';
                }, 3000);
            }
        }

        function exportarExcel() {
            const produtosFiltrados = getProdutosFiltrados();
            const headers = hasPermission('view-values') 
                ? ['SKU', 'Descri√ß√£o', 'Linha', 'Quantidade', 'M√≠nimo', 'Custo', 'Venda', 'Status', 'Vis√≠vel', '√öltima Atualiza√ß√£o']
                : ['SKU', 'Descri√ß√£o', 'Linha', 'Quantidade', 'M√≠nimo', 'Status', 'Vis√≠vel', '√öltima Atualiza√ß√£o'];
            
            const rows = produtosFiltrados.map(p => {
                const base = [
                    p.sku,
                    p.descricao,
                    p.linha,
                    p.quantidade,
                    p.estoqueMinimo
                ];
                
                if (hasPermission('view-values')) {
                    base.push(
                        (p.valorCusto || 0).toFixed(2),
                        (p.valorVenda || 0).toFixed(2)
                    );
                }
                
                base.push(
                    getStatusLabel(getStatusProduto(p)),
                    p.visivel ? 'Sim' : 'N√£o',
                    new Date(p.ultimaAtualizacao).toLocaleDateString('pt-BR')
                );
                
                return base;
            });

            const csv = [headers, ...rows].map(row => row.join(';')).join('\n');
            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `estoque_policryl_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            showAlert('Relat√≥rio exportado com sucesso!');
        }

        function getProdutosFiltrados() {
            return state.produtos
                .filter