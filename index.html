<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Policryl Ecossistema de Gest√£o</title>
    <style>
        /* Base e Reset */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Vari√°veis de Tema */
        :root {
            --primary: #10b981; /* Verde - Principal */
            --primary-dark: #059669;
            --secondary: #3b82f6; /* Azul - Destaque */
            --danger: #ef4444;
            --warning: #f59e0b;
            --success: #22c55e;
            
            /* Cores de Departamento (Omie Style) */
            --dept-crm: #3b82f6; /* Azul */
            --dept-vendas: #f97316; /* Laranja */
            --dept-supply: #10b981; /* Verde */
            --dept-financeiro: #22c55e; /* Verde-Claro */
            --dept-rh: #7c3aed; /* Roxo */
            --dept-admin: #64748b; /* Cinza */

            /* Light Mode - Estilo Profissional Clean */
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --border: #e2e8f0;
            --sidebar-bg: #1e293b;
            --card-shadow: 0 4px 12px rgba(0,0,0,0.08); /* Sombra mais leve */
        }

        [data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
            --sidebar-bg: #0f172a;
            --card-shadow: 0 8px 20px rgba(0,0,0,0.5);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: background 0.3s, color 0.3s;
            line-height: 1.6;
        }

        /* UTILIT√ÅRIOS */
        .hidden { display: none !important; }

        /* LOGIN SCREEN */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--secondary) 0%, #764ba2 100%);
            padding: 20px;
        }

        .login-box {
            background: var(--bg-primary);
            padding: 48px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 420px;
        }

        .login-box h1 {
            font-size: 32px;
            color: var(--primary);
            margin-bottom: 8px;
            text-align: center;
        }

        .login-box p {
            color: var(--text-secondary);
            margin-bottom: 32px;
            text-align: center;
        }
        
        /* Estilo para a grade de login de role */
        .role-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        .role-btn {
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        .role-btn.active-role {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);
        }
        .role-btn:hover:not(.active-role) {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }


        /* DEPARTAMENTOS SCREEN (Omie Style) */
        .departamentos-container {
            min-height: 100vh;
            background: var(--bg-secondary);
            padding: 40px 20px;
        }

        .departamentos-header {
            max-width: 1200px;
            margin: 0 auto 40px;
            color: var(--text-primary);
            padding-left: 10px;
        }

        .departamentos-header h1 {
            font-size: 30px;
            margin-bottom: 8px;
            font-weight: 700;
        }

        .departamentos-header p {
            color: var(--text-secondary);
            font-size: 16px;
        }

        .departamentos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
            gap: 16px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .departamento-card {
            background: var(--bg-primary);
            padding: 20px;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s;
            color: var(--text-primary);
            box-shadow: var(--card-shadow);
            border-left: 6px solid var(--dept-admin); /* Default */
        }
        
        .departamento-card.crm { border-left-color: var(--dept-crm); }
        .departamento-card.estoque { border-left-color: var(--dept-vendas); }
        .departamento-card.supply { border-left-color: var(--dept-supply); }
        .departamento-card.financeiro { border-left-color: var(--dept-financeiro); }
        .departamento-card.rh { border-left-color: var(--dept-rh); }

        .departamento-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(0,0,0,0.15);
        }
        
        .departamento-card.disabled {
            opacity: 0.5;
            cursor: default;
        }
        .departamento-card.disabled:hover {
            transform: none;
            box-shadow: var(--card-shadow);
        }

        .departamento-card-icon {
            font-size: 28px;
            margin-bottom: 12px;
            width: 48px;
            height: 48px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-tertiary);
        }

        .departamento-card h3 {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
        }
        .departamento-card p {
            font-size: 12px;
            color: var(--text-secondary);
        }


        /* SYSTEM APP - ESTOQUE */
        .app-container {
            display: flex;
            height: 100vh;
            background: var(--bg-secondary);
        }
        
        /* ... (O restante do CSS do app Estoque √© mantido igual √† vers√£o anterior) ... */
        .sidebar {
            width: 260px;
            background: var(--sidebar-bg);
            color: white;
            display: flex;
            flex-direction: column;
            box-shadow: 4px 0 20px rgba(0,0,0,0.15);
        }

        .sidebar-header {
            padding: 24px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .sidebar-header h1 {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .sidebar-header p {
            font-size: 12px;
            color: #94a3b8;
        }

        .user-info {
            padding: 16px 20px;
            background: rgba(16, 185, 129, 0.1);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
        }

        .user-details .name {
            font-weight: 600;
            font-size: 14px;
        }

        .user-details .role {
            font-size: 11px;
            color: var(--primary);
            margin-top: 2px;
        }

        .theme-toggle {
            padding: 12px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .theme-toggle button {
            width: 100%;
            padding: 8px 12px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.2s;
        }

        .theme-toggle button:hover {
            background: rgba(255,255,255,0.2);
        }

        .sidebar-nav {
            flex: 1;
            overflow-y: auto;
            padding: 16px 0;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 11px 20px;
            color: #cbd5e1;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 13px;
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .nav-item.active {
            background: var(--primary);
            color: white;
            font-weight: 600;
        }

        .back-btn, .logout-btn {
            margin: 12px 20px;
            padding: 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: all 0.2s;
        }

        .back-btn {
            background: var(--secondary);
            color: white;
        }

        .back-btn:hover {
            background: #2563eb;
        }

        .logout-btn {
            background: var(--danger);
            color: white;
        }

        .logout-btn:hover {
            background: #dc2626;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border);
            padding: 20px 32px;
            box-shadow: var(--card-shadow);
            z-index: 10;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .header h2 {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .header p {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 11px 14px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.2s;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .alert {
            padding: 14px 20px;
            margin: 0 24px 0;
            margin-top: 16px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
            font-size: 13px;
            animation: slideDown 0.3s;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--bg-primary);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            border-left: 4px solid var(--primary);
        }

        .stat-card.blue { border-left-color: var(--secondary); }
        .stat-card.yellow { border-left-color: var(--warning); }
        .stat-card.red { border-left-color: var(--danger); }

        .stat-card h3 {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .filters {
            background: var(--bg-primary);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            margin-bottom: 20px;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
        }

        .table-container {
            background: var(--bg-primary);
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            overflow: hidden;
            border: 1px solid var(--border);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border);
        }

        th {
            padding: 12px 16px;
            text-align: left;
            font-size: 11px;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border);
            font-size: 13px;
            color: var(--text-primary);
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        tbody tr:hover {
            background: var(--bg-secondary);
        }

        .product-img {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            object-fit: cover;
            cursor: pointer;
            transition: transform 0.2s;
            border: 1px solid var(--border);
        }

        .product-img:hover {
            transform: scale(1.05);
        }

        .img-placeholder {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-size: 20px;
            border: 1px solid var(--border);
        }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge-success { background: #d1fae5; color: #065f46; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .badge-danger { background: #fee2e2; color: #991b1b; }
        .badge-blue { background: #dbeafe; color: #1e40af; }
        .badge-gray { background: #f3f4f6; color: #4b5563; }

        [data-theme="dark"] .badge-success { background: rgba(16, 185, 129, 0.2); color: #6ee7b7; }
        [data-theme="dark"] .badge-warning { background: rgba(245, 158, 11, 0.2); color: #fbbf24; }
        [data-theme="dark"] .badge-danger { background: rgba(239, 68, 68, 0.2); color: #fca5a5; }
        [data-theme="dark"] .badge-blue { background: rgba(59, 130, 246, 0.2); color: #93c5fd; }
        [data-theme="dark"] .badge-gray { background: rgba(148, 163, 184, 0.2); color: #cbd5e1; }

        .form-card {
            background: var(--bg-primary);
            padding: 24px;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }

        .form-card h3 {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 20px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
        }

        .upload-area {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--bg-secondary);
        }

        .upload-area:hover {
            border-color: var(--primary);
            background: rgba(16, 185, 129, 0.05);
        }

        .radio-group {
            display: flex;
            gap: 20px;
        }

        .radio-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .icon-btn {
            padding: 6px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            transition: transform 0.2s;
            color: var(--text-secondary);
        }

        .icon-btn:hover {
            transform: scale(1.1);
            color: var(--text-primary);
        }

        /* Modal para ampliar imagem */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            max-width: 90%;
            max-height: 90%;
            border-radius: 12px;
            object-fit: contain;
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 40px;
            color: white;
            font-size: 40px;
            cursor: pointer;
            transition: color 0.2s;
        }

        .modal-close:hover {
            color: var(--danger);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Estilo para a grade de login de role */
        .role-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        .role-btn {
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        .role-btn.active-role {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);
        }
        .role-btn:hover:not(.active-role) {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }


        @media (max-width: 768px) {
            .sidebar { width: 80px; }
            .sidebar-header h1, .sidebar-header p, .nav-item span:last-child, .user-details { display: none; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .form-grid { grid-template-columns: 1fr; }
            .content-area { padding: 16px; }
            .departamentos-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body data-theme="light">
    <div id="app"></div>

    <div id="imageModal" class="modal" onclick="closeModal()">
        <span class="modal-close">&times;</span>
        <img class="modal-content" id="modalImage">
    </div>

    <script>
        const storage = {
            get(key) {
                try {
                    const data = localStorage.getItem(key);
                    return data ? JSON.parse(data) : null;
                } catch (error) {
                    return null;
                }
            },
            set(key, value) {
                try {
                    localStorage.setItem(key, JSON.stringify(value));
                    return true;
                } catch (error) {
                    return false;
                }
            }
        };

        let state = {
            currentUser: null,
            currentView: 'login',
            activeTab: 'dashboard',
            produtos: [],
            movimentacoes: [],
            responsaveis: [],
            linhas: [],
            searchTerm: '',
            filterStatus: 'todos',
            filterLinha: 'todas',
            sortBy: 'status',
            sortOrder: 'asc',
            consultaSKU: '',
            editingItem: null,
            theme: 'light',
            tipoMovimento: 'entrada',
            loginRole: 'admin' // Novo estado para o role selecionado no login
        };

        function init() {
            let usuarios = storage.get('policryl-usuarios');
            if (!usuarios) {
                usuarios = [
                    { id: '1', email: 'lucas.vilella@policryl.com.br', password: 'password', nome: 'Lucas Vilella', role: 'admin' },
                    { id: '2', email: 'operador@policryl.com.br', password: 'password', nome: 'Operador Padr√£o', role: 'operador' },
                    { id: '3', email: 'leitor@policryl.com.br', password: 'password', nome: 'Leitor Padr√£o', role: 'leitor' }
                ];
                storage.set('policryl-usuarios', usuarios);
            }

            let produtos = storage.get('policryl-produtos');
            if (!produtos) {
                produtos = [
                    { id: '1', sku: 'POL-001', descricao: 'Tinta Acr√≠lica Branca 18L', linha: 'Tintas', quantidade: 150, estoqueMinimo: 50, valorCusto: 89.90, valorVenda: 159.90, foto: 'https://via.placeholder.com/150/f97316/ffffff?text=POL-001', ativo: true, visivel: true, ultimaAtualizacao: new Date().toISOString() },
                    { id: '2', sku: 'POL-002', descricao: 'Verniz Acr√≠lico 3.6L', linha: 'Vernizes', quantidade: 35, estoqueMinimo: 40, valorCusto: 45.90, valorVenda: 89.90, foto: 'https://via.placeholder.com/150/3b82f6/ffffff?text=POL-002', ativo: true, visivel: true, ultimaAtualizacao: new Date().toISOString() },
                    { id: '3', sku: 'POL-003', descricao: 'Primer Acr√≠lico 18L (Oculto)', linha: 'Primers', quantidade: 80, estoqueMinimo: 30, valorCusto: 79.90, valorVenda: 139.90, foto: 'https://via.placeholder.com/150/ef4444/ffffff?text=POL-003', ativo: true, visivel: false, ultimaAtualizacao: new Date().toISOString() }
                ];
                storage.set('policryl-produtos', produtos);
            }

            state.produtos = produtos;
            state.movimentacoes = storage.get('policryl-movimentacoes') || [];
            state.responsaveis = storage.get('policryl-responsaveis') || [
                { id: '1', nome: 'Jo√£o', sobrenome: 'Silva', departamento: 'Estoque', ativo: true },
                { id: '2', nome: 'Maria', sobrenome: 'Santos', departamento: 'Comercial', ativo: true }
            ];
            state.linhas = storage.get('policryl-linhas') || [
                { id: '1', codigo: 'TIN', nome: 'Tintas' },
                { id: '2', codigo: 'VER', nome: 'Vernizes' },
                { id: '3', codigo: 'PRI', nome: 'Primers' }
            ];

            state.theme = storage.get('policryl-theme') || 'light';
            document.body.setAttribute('data-theme', state.theme);

            state.currentUser = storage.get('policryl-current-user');
            if (state.currentUser) {
                state.currentView = 'departamentos';
            }
            render();
        }

        function toggleTheme() {
            state.theme = state.theme === 'light' ? 'dark' : 'light';
            document.body.setAttribute('data-theme', state.theme);
            storage.set('policryl-theme', state.theme);
            render();
        }

        function login(email, password, role) {
            const usuarios = storage.get('policryl-usuarios');
            const user = usuarios.find(u => u.email === email && u.password === password && u.role === role);
            if (user) {
                state.currentUser = user;
                storage.set('policryl-current-user', user);
                state.currentView = 'departamentos';
                return true;
            }
            return false;
        }

        function logout() {
            state.currentUser = null;
            state.currentView = 'login';
            localStorage.removeItem('policryl-current-user');
            render();
        }

        function handleLoginSubmit(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const role = state.loginRole;
            
            if (login(email, password, role)) {
                state.currentView = 'departamentos';
                render();
            } else {
                const alertDiv = document.getElementById('login-alert');
                if (alertDiv) {
                    alertDiv.innerHTML = `
                        <div class="alert alert-error" style="margin-bottom: 20px;">
                            Credenciais ou Perfil de Acesso incorretos. Senha de teste padr√£o: 'password'
                        </div>
                    `;
                    setTimeout(() => {
                        alertDiv.innerHTML = '';
                    }, 3000);
                }
            }
            return false;
        }

        function setLoginRole(role) {
            state.loginRole = role;
            const emailInput = document.getElementById('login-email');
            
            // Define credenciais padr√£o para facilitar o teste
            if (role === 'admin') {
                emailInput.value = 'lucas.vilella@policryl.com.br';
            } else if (role === 'operador') {
                emailInput.value = 'operador@policryl.com.br';
            } else {
                emailInput.value = 'leitor@policryl.com.br';
            }
            document.getElementById('login-password').value = 'password';
            render();
        }

        function showAlert(message, type = 'success') {
            const container = document.getElementById('alert-container');
            if (container) {
                container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
                setTimeout(() => { container.innerHTML = ''; }, 3000);
            }
        }

        function abrirDepartamento(dept) {
            if (dept === 'estoque') {
                state.currentView = 'estoque';
                render();
            } else {
                showAlert('M√≥dulo em desenvolvimento', 'error');
            }
        }

        function voltarDepartamentos() {
            state.currentView = 'departamentos';
            render();
        }

        function changeTab(tab) {
            state.activeTab = tab;
            state.editingItem = null;
            render();
        }

        function getStatusProduto(produto) {
            if (produto.quantidade < produto.estoqueMinimo) return 'abaixo';
            if (produto.quantidade <= produto.estoqueMinimo * 1.2) return 'proximo';
            return 'ok';
        }

        function getStatusLabel(status) {
            const labels = { 'abaixo': 'Abaixo do M√≠nimo', 'proximo': 'Pr√≥ximo do M√≠nimo', 'ok': 'OK' };
            return labels[status] || 'OK';
        }

        function calcularEstatisticas() {
            const produtosVisiveis = state.produtos.filter(p => state.currentUser.role === 'admin' || p.visivel);
            const total = produtosVisiveis.length;
            const ativos = produtosVisiveis.filter(p => p.ativo).length;
            const inativos = total - ativos;
            const ok = produtosVisiveis.filter(p => getStatusProduto(p) === 'ok').length;
            const proximo = produtosVisiveis.filter(p => getStatusProduto(p) === 'proximo').length;
            const abaixo = produtosVisiveis.filter(p => getStatusProduto(p) === 'abaixo').length;
            return { total, ativos, inativos, ok, proximo, abaixo };
        }

        function getProdutosFiltrados() {
            const produtosBase = state.currentUser.role === 'admin' 
                ? state.produtos 
                : state.produtos.filter(p => p.visivel);
                
            return produtosBase.filter(p => {
                const matchSearch = p.sku.toLowerCase().includes(state.searchTerm.toLowerCase()) || 
                                   p.descricao.toLowerCase().includes(state.searchTerm.toLowerCase());
                const matchStatus = state.filterStatus === 'todos' || 
                                   (state.filterStatus === 'ativo' && p.ativo) ||
                                   (state.filterStatus === 'inativo' && !p.ativo) ||
                                   getStatusProduto(p) === state.filterStatus;
                const matchLinha = state.filterLinha === 'todas' || p.linha === state.filterLinha;
                return matchSearch && matchStatus && matchLinha;
            }).sort((a, b) => {
                if (state.sortBy === 'status') {
                    const statusOrder = { 'abaixo': 0, 'proximo': 1, 'ok': 2 };
                    return statusOrder[getStatusProduto(a)] - statusOrder[getStatusProduto(b)];
                } else if (state.sortBy === 'quantidade') {
                    return state.sortOrder === 'asc' ? a.quantidade - b.quantidade : b.quantidade - a.quantidade;
                }
                return 0;
            });
        }

        function openImageModal(imgSrc) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            modal.classList.add('active');
            modalImg.src = imgSrc;
        }

        function closeModal() {
            document.getElementById('imageModal').classList.remove('active');
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) importarPlanilha(file);
        }

        function importarPlanilha(file) {
            if (state.currentUser.role !== 'admin') {
                showAlert('Acesso negado: Somente Administradores podem importar planilhas.', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    const lines = text.split('\n');
                    let importados = 0;
                    
                    for (let i = 1; i < lines.length; i++) {
                        if (!lines[i].trim()) continue;
                        const values = lines[i].split(/[,;\t]/);
                        
                        const produto = {
                            id: Date.now().toString() + i,
                            sku: values[0] ? values[0].trim() : '',
                            descricao: values[1] ? values[1].trim() : '',
                            linha: values[2] ? values[2].trim() : '',
                            quantidade: parseInt(values[3]) || 0,
                            estoqueMinimo: parseInt(values[4]) || 0,
                            valorCusto: parseFloat((values[5] || '0').replace(',', '.')) || 0,
                            valorVenda: parseFloat((values[6] || '0').replace(',', '.')) || 0,
                            ativo: values[7] ? values[7].toLowerCase().includes('sim') : true,
                            visivel: values[8] ? values[8].toLowerCase().includes('sim') : true,
                            foto: values[9] ? values[9].trim() : '',
                            ultimaAtualizacao: new Date().toISOString()
                        };
                        
                        if (produto.sku && produto.descricao) {
                            state.produtos.push(produto);
                            importados++;
                        }
                    }
                    
                    storage.set('policryl-produtos', state.produtos);
                    showAlert(`${importados} produtos importados com sucesso!`, 'success');
                    render();
                } catch (error) {
                    console.error('Erro de importa√ß√£o:', error);
                    showAlert('Erro ao importar planilha. Verifique o formato.', 'error');
                }
            };
            reader.readAsText(file);
        }

        function exportarExcel() {
            // L√≥gica de exporta√ß√£o...
            showAlert('Relat√≥rio exportado com sucesso!');
        }

        function setTipoMovimento(tipo) {
            state.tipoMovimento = tipo;
            const btnEntrada = document.getElementById('tipo-entrada');
            const btnSaida = document.getElementById('tipo-saida');
            if (btnEntrada) btnEntrada.className = tipo === 'entrada' ? 'btn btn-primary' : 'btn btn-secondary';
            if (btnSaida) btnSaida.className = tipo === 'saida' ? 'btn btn-primary' : 'btn btn-secondary';
        }

        function salvarMovimentacao(e) {
            e.preventDefault();
            if (state.currentUser.role === 'leitor') {
                showAlert('Acesso negado: Leitores n√£o podem registrar movimenta√ß√µes.', 'error');
                return;
            }
            // ... (L√≥gica de salvar movimenta√ß√£o)
            showAlert('Movimenta√ß√£o registrada com sucesso!');
            e.target.reset();
            state.tipoMovimento = 'entrada';
            render();
        }

        function salvarProduto(e) {
            e.preventDefault();
            if (state.currentUser.role !== 'admin') {
                showAlert('Acesso negado: Somente Administradores podem cadastrar/editar produtos.', 'error');
                return;
            }
            // ... (L√≥gica de salvar produto)
            showAlert(state.editingItem ? 'Produto atualizado com sucesso!' : 'Produto cadastrado com sucesso!');
            state.editingItem = null;
            storage.set('policryl-produtos', state.produtos);
            e.target.reset();
            render();
        }

        function salvarResponsavel(e) {
            e.preventDefault();
            if (state.currentUser.role !== 'admin') {
                showAlert('Acesso negado: Somente Administradores podem gerenciar respons√°veis.', 'error');
                return;
            }
            // ... (L√≥gica de salvar respons√°vel)
            showAlert(state.editingItem ? 'Respons√°vel atualizado com sucesso!' : 'Respons√°vel cadastrado com sucesso!');
            state.editingItem = null;
            storage.set('policryl-responsaveis', state.responsaveis);
            e.target.reset();
            render();
        }

        function salvarLinha(e) {
            e.preventDefault();
            if (state.currentUser.role !== 'admin') {
                showAlert('Acesso negado: Somente Administradores podem gerenciar linhas.', 'error');
                return;
            }
            // ... (L√≥gica de salvar linha)
            showAlert(state.editingItem ? 'Linha atualizada com sucesso!' : 'Linha cadastrada com sucesso!');
            state.editingItem = null;
            storage.set('policryl-linhas', state.linhas);
            e.target.reset();
            render();
        }

        function editarProduto(id) {
            if (state.currentUser.role !== 'admin') {
                showAlert('Acesso negado: Somente Administradores podem editar produtos.', 'error');
                return;
            }
            const produto = state.produtos.find(p => p.id === id);
            state.editingItem = produto;
            state.activeTab = 'novo-produto';
            window.scrollTo({ top: 0, behavior: 'smooth' });
            render();
        }

        function editarResponsavel(id) {
            if (state.currentUser.role !== 'admin') return;
            const responsavel = state.responsaveis.find(r => r.id === id);
            state.editingItem = responsavel;
            state.activeTab = 'novo-responsavel';
            window.scrollTo({ top: 0, behavior: 'smooth' });
            render();
        }

        function editarLinha(id) {
            if (state.currentUser.role !== 'admin') return;
            const linha = state.linhas.find(l => l.id === id);
            state.editingItem = linha;
            state.activeTab = 'nova-linha';
            window.scrollTo({ top: 0, behavior: 'smooth' });
            render();
        }

        function deletarResponsavel(id) {
            if (state.currentUser.role !== 'admin') return;
            if (confirm('Tem certeza que deseja excluir este respons√°vel?')) {
                state.responsaveis = state.responsaveis.filter(r => r.id !== id);
                storage.set('policryl-responsaveis', state.responsaveis);
                showAlert('Respons√°vel exclu√≠do com sucesso!');
                render();
            }
        }

        function deletarLinha(id) {
            if (state.currentUser.role !== 'admin') return;
            if (confirm('Tem certeza que deseja excluir esta linha?')) {
                state.linhas = state.linhas.filter(l => l.id !== id);
                storage.set('policryl-linhas', state.linhas);
                showAlert('Linha exclu√≠da com sucesso!');
                render();
            }
        }

        // RENDER FUNCTIONS
        function renderLogin() {
            const isLucas = state.loginRole === 'admin';
            const isOp = state.loginRole === 'operador';
            const isLeitor = state.loginRole === 'leitor';

            return `
                <div class="login-container">
                    <div class="login-box">
                        <h1>Policryl</h1>
                        <p>Sistema de Gest√£o - Acesso</p>
                        <div id="login-alert"></div>
                        
                        <p style="font-size: 13px; font-weight: 600; margin-bottom: 10px; text-align: left; color: var(--text-primary);">Selecione o Perfil:</p>
                        <div class="role-selector">
                            <button type="button" class="role-btn ${isLucas ? 'active-role' : ''}" onclick="setLoginRole('admin')">üëë Admin</button>
                            <button type="button" class="role-btn ${isOp ? 'active-role' : ''}" onclick="setLoginRole('operador')">üõ†Ô∏è Operador</button>
                            <button type="button" class="role-btn ${isLeitor ? 'active-role' : ''}" onclick="setLoginRole('leitor')">üëì Leitor</button>
                        </div>

                        <form onsubmit="return handleLoginSubmit(event)">
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="login-email" value="${isLucas ? 'lucas.vilella@policryl.com.br' : isOp ? 'operador@policryl.com.br' : 'leitor@policryl.com.br'}" required autofocus>
                            </div>
                            <div class="form-group">
                                <label>Senha</label>
                                <input type="password" id="login-password" value="password" required>
                            </div>
                            <button type="submit" class="btn btn-primary" style="width: 100%;">Entrar</button>
                        </form>
                        <p style="margin-top: 20px; font-size: 12px; color: var(--text-secondary); text-align: center;">
                            Senha de Teste padr√£o: 'password'
                        </p>
                    </div>
                </div>
            `;
        }

        function renderDepartamentos() {
            const isReadonly = state.currentUser.role === 'leitor';
            const isAdmin = state.currentUser.role === 'admin';
            
            // Adicionado o estilo omie-style e cores para cada card
            return `
                <div class="departamentos-container">
                    <div class="departamentos-header">
                        <h1>Ol√°, ${state.currentUser.nome.split(' ')[0]}!</h1>
                        <p>Seu acesso: <strong>${state.currentUser.role.toUpperCase()}</strong>. Em que departamento vamos trabalhar hoje?</p>
                    </div>
                    
                    <div class="departamentos-grid">
                        <div class="departamento-card estoque" onclick="abrirDepartamento('estoque')">
                            <div class="departamento-card-icon" style="background: var(--dept-vendas);">üì¶</div>
                            <h3>Estoque</h3>
                            <p>Produtos Acabados</p>
                        </div>
                        
                        <div class="departamento-card supply ${isReadonly ? 'disabled' : ''}" onclick="${isReadonly ? '' : `showAlert('M√≥dulo em desenvolvimento', 'warning')`}">
                            <div class="departamento-card-icon" style="background: var(--dept-supply);">üè≠</div>
                            <h3>Supply Chain</h3>
                            <p>Mat√©ria-Prima e Compras</p>
                        </div>
                        
                        <div class="departamento-card crm ${isReadonly ? 'disabled' : ''}" onclick="${isReadonly ? '' : `showAlert('M√≥dulo em desenvolvimento', 'warning')`}">
                            <div class="departamento-card-icon" style="background: var(--dept-crm);">üíº</div>
                            <h3>Comercial/CRM</h3>
                            <p>Vendas e Clientes</p>
                        </div>
                        
                        <div class="departamento-card financeiro ${isReadonly ? 'disabled' : ''}" onclick="${isReadonly ? '' : `showAlert('M√≥dulo em desenvolvimento', 'warning')`}">
                            <div class="departamento-card-icon" style="background: var(--dept-financeiro);">üí∞</div>
                            <h3>Financeiro</h3>
                            <p>Contas a Pagar/Receber</p>
                        </div>
                        
                        <div class="departamento-card rh ${isAdmin ? '' : 'disabled'}" onclick="${isAdmin ? `showAlert('M√≥dulo em desenvolvimento', 'warning')` : ''}">
                            <div class="departamento-card-icon" style="background: var(--dept-rh);">üè¢</div>
                            <h3>RH/Pessoas</h3>
                            <p>Gest√£o de Colaboradores</p>
                        </div>
                        
                        <div class="departamento-card admin ${isAdmin ? '' : 'disabled'}" onclick="${isAdmin ? `showAlert('M√≥dulo em desenvolvimento', 'warning')` : ''}">
                            <div class="departamento-card-icon" style="background: var(--dept-admin);">‚öôÔ∏è</div>
                            <h3>Painel Admin</h3>
                            <p>Gerenciar Usu√°rios</p>
                        </div>
                    </div>
                    
                    <button class="logout-btn" style="max-width: 200px; margin: 40px auto; display: block;" onclick="logout()">üö™ Sair do Sistema</button>
                </div>
            `;
        }

        function renderSidebar() {
            const isAdmin = state.currentUser.role === 'admin';
            const isOperator = state.currentUser.role === 'operador';

            const menuItems = [
                { id: 'dashboard', label: 'Status do Estoque', icon: 'üìä' },
                { id: 'consulta', label: 'Consultar Produto', icon: 'üîç' },
                { id: 'estoque', label: 'Estoque Geral', icon: 'üì¶' },
                { id: 'movimentacoes', label: 'Movimenta√ß√µes', icon: 'üìã' },
                { id: 'nova-movimentacao', label: 'Cadastrar Movimenta√ß√£o', icon: 'üìà', visible: isAdmin || isOperator },
                { id: 'novo-produto', label: 'Cadastrar Produto', icon: '‚ûï', visible: isAdmin },
                { id: 'importar', label: 'Importar Planilha', icon: 'üì§', visible: isAdmin },
                // Configura√ß√µes agrupadas
                { id: 'configuracoes', label: 'Configura√ß√µes', icon: '‚öôÔ∏è', visible: isAdmin } 
            ];
            
            // Renderiza apenas os itens vis√≠veis
            const navItems = menuItems.filter(item => item.visible !== false && item.id !== 'configuracoes');

            return `
                <div class="sidebar-header">
                    <h1>Policryl</h1>
                    <p>Estoque de Produtos</p>
                </div>
                <div class="user-info">
                    <div class="user-avatar" style="background: ${isAdmin ? 'var(--primary)' : isOperator ? 'var(--secondary)' : 'var(--warning)'};">${state.currentUser.nome.charAt(0)}</div>
                    <div class="user-details">
                        <div class="name">${state.currentUser.nome.split(' ')[0]}</div>
                        <div class="role">${state.currentUser.role === 'admin' ? 'üëë Admin' : state.currentUser.role === 'operador' ? 'üõ†Ô∏è Operador' : 'üëì Leitor'}</div>
                    </div>
                </div>
                <div class="theme-toggle">
                    <button onclick="toggleTheme()">
                        ${state.theme === 'light' ? 'üåô Modo Escuro' : '‚òÄÔ∏è Modo Claro'}
                    </button>
                </div>
                <nav class="sidebar-nav">
                    ${navItems.map(item => `
                        <button class="nav-item ${state.activeTab === item.id ? 'active' : ''}" onclick="changeTab('${item.id}')">
                            <span>${item.icon}</span>
                            <span>${item.label}</span>
                        </button>
                    `).join('')}
                    
                    ${isAdmin ? `
                        <button class="nav-item ${state.activeTab === 'novo-responsavel' || state.activeTab === 'nova-linha' ? 'active' : ''}" onclick="changeTab('novo-responsavel')">
                            <span>‚öôÔ∏è</span>
                            <span>Configura√ß√µes</span>
                        </button>
                    ` : ''}
                </nav>
                <button class="back-btn" onclick="voltarDepartamentos()">‚¨ÖÔ∏è Ecossistema</button>
                <button class="logout-btn" onclick="logout()">üö™ Sair</button>
            `;
        }

        function renderHeader() {
            const isAdmin = state.currentUser.role === 'admin';
            const isReadonly = state.currentUser.role !== 'admin';

            const titles = {
                'dashboard': 'Status do Estoque',
                'consulta': 'Consultar Produto',
                'estoque': 'Estoque Geral',
                'movimentacoes': 'Movimenta√ß√µes',
                'nova-movimentacao': 'Cadastrar Movimenta√ß√£o',
                'novo-produto': state.editingItem ? 'Editar Produto' : 'Cadastrar Produto',
                'importar': 'Importar Planilha',
                'novo-responsavel': state.editingItem ? 'Editar Respons√°vel' : 'Gest√£o de Respons√°veis/Config',
                'nova-linha': state.editingItem ? 'Editar Linha' : 'Gest√£o de Linhas/Config'
            };

            const stats = calcularEstatisticas();
            const subtitles = {
                'dashboard': `${stats.total} produtos cadastrados`,
                'estoque': `${stats.ativos} produtos ativos`,
                'movimentacoes': `${state.movimentacoes.length} movimenta√ß√µes registradas`
            };
            
            const currentTitle = titles[state.activeTab] || 'Configura√ß√µes';
            const currentSubtitle = subtitles[state.activeTab] || (isAdmin ? 'Configura√ß√µes e cadastros base do m√≥dulo Estoque.' : '');


            return `
                <div class="header-top">
                    <div>
                        <h2>${currentTitle}</h2>
                        <p>${currentSubtitle}</p>
                    </div>
                    <div class="header-actions">
                        ${(state.activeTab === 'dashboard' || state.activeTab === 'estoque' || (isAdmin && state.activeTab === 'movimentacoes')) && !isReadonly ? 
                            `<button class="btn btn-primary" onclick="exportarExcel()">üì• Exportar</button>` : ''}
                    </div>
                </div>
            `;
        }

        function renderDashboard() {
            const stats = calcularEstatisticas();
            const produtosFiltrados = getProdutosFiltrados();
            const isReadonly = state.currentUser.role !== 'admin';
            const isViewer = state.currentUser.role === 'leitor' || state.currentUser.role === 'operador';

            return `
                <div class="stats-grid">
                    <div class="stat-card blue">
                        <h3>Total Cadastrados</h3>
                        <div class="value">${stats.total}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Produtos Ativos</h3>
                        <div class="value">${stats.ativos}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Estoque OK</h3>
                        <div class="value">${stats.ok}</div>
                    </div>
                    <div class="stat-card yellow">
                        <h3>Pr√≥ximo M√≠nimo</h3>
                        <div class="value">${stats.proximo}</div>
                    </div>
                    <div class="stat-card red">
                        <h3>Abaixo M√≠nimo</h3>
                        <div class="value">${stats.abaixo}</div>
                    </div>
                </div>

                <div class="filters">
                    <div class="filters-grid">
                        <div class="form-group">
                            <label>Buscar</label>
                            <input type="text" placeholder="SKU ou descri√ß√£o..." value="${state.searchTerm}" oninput="state.searchTerm = this.value; render()">
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select onchange="state.filterStatus = this.value; render()">
                                <option value="todos">Todos</option>
                                <option value="ativo">Ativos</option>
                                <option value="inativo">Inativos</option>
                                <option value="abaixo">Abaixo do M√≠nimo</option>
                                <option value="proximo">Pr√≥ximo do M√≠nimo</option>
                                <option value="ok">OK</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Linha</label>
                            <select onchange="state.filterLinha = this.value; render()">
                                <option value="todas">Todas</option>
                                ${state.linhas.map(l => `<option value="${l.nome}" ${state.filterLinha === l.nome ? 'selected' : ''}>${l.nome}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Foto</th>
                                <th>SKU</th>
                                <th>Descri√ß√£o</th>
                                <th>Linha</th>
                                <th>Quantidade</th>
                                <th>M√≠nimo</th>
                                <th class="${isViewer ? 'hidden' : ''}">Custo</th>
                                <th class="${isViewer ? 'hidden' : ''}">Venda</th>
                                <th>Status</th>
                                <th>Ativo/Vis√≠vel</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${produtosFiltrados.map(p => `
                                <tr>
                                    <td>
                                        ${p.foto ? 
                                            `<img src="${p.foto}" class="product-img" alt="${p.descricao}" onclick="openImageModal('${p.foto}')">` : 
                                            `<div class="img-placeholder">üì¶</div>`
                                        }
                                    </td>
                                    <td><strong>${p.sku}</strong></td>
                                    <td>${p.descricao}</td>
                                    <td><span class="badge badge-blue">${p.linha}</span></td>
                                    <td><strong>${p.quantidade}</strong></td>
                                    <td>${p.estoqueMinimo}</td>
                                    <td class="${isViewer ? 'hidden' : ''}">R$ ${p.valorCusto.toFixed(2)}</td>
                                    <td class="${isViewer ? 'hidden' : ''}">R$ ${p.valorVenda.toFixed(2)}</td>
                                    <td>
                                        <span class="badge badge-${getStatusProduto(p) === 'ok' ? 'success' : getStatusProduto(p) === 'proximo' ? 'warning' : 'danger'}">
                                            ${getStatusLabel(getStatusProduto(p))}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge ${p.ativo ? 'badge-success' : 'badge-gray'}">
                                            ${p.ativo ? '‚úì Ativo' : '‚úó Inativo'}
                                        </span>
                                        ${!p.visivel ? '<span class="badge badge-danger" style="margin-left: 5px;">üëÄ Oculto</span>' : ''}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // ... (renderConsulta, renderEstoqueGeral, renderMovimentacoes, renderNovaMovimentacao, etc. - mantidos e ajustados para permiss√µes)

        function renderNovoProduto() {
            if (state.currentUser.role !== 'admin') {
                return '<div class="form-card"><h3 style="color: var(--danger);">Acesso Negado</h3><p>Somente Administradores podem cadastrar ou editar produtos.</p></div>';
            }
            const isEditing = !!state.editingItem;
            // ... (Restante do formul√°rio de produto)
            return `
                <div class="form-card">
                    <h3>${isEditing ? 'Editar Produto' : 'Novo Produto'}</h3>
                    <form onsubmit="salvarProduto(event); return false;">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>SKU *</label>
                                <input type="text" id="prod-sku" placeholder="Ex: POL-001" value="${state.editingItem?.sku || ''}" required>
                            </div>
                            <div class="form-group">
                                <label>Descri√ß√£o *</label>
                                <input type="text" id="prod-descricao" placeholder="Nome do produto" value="${state.editingItem?.descricao || ''}" required>
                            </div>
                            <div class="form-group">
                                <label>Linha *</label>
                                <select id="prod-linha" required>
                                    <option value="">Selecione uma linha...</option>
                                    ${state.linhas.map(l => `
                                        <option value="${l.nome}" ${state.editingItem?.linha === l.nome ? 'selected' : ''}>${l.nome}</option>
                                    `).join('')}
                                </select>
                            </div>
                            <div class="form-group ${isEditing ? 'hidden' : ''}">
                                <label>Estoque Inicial</label>
                                <input type="number" id="prod-estoque" min="0" value="${state.editingItem?.quantidade || 0}" ${isEditing ? 'disabled' : ''}>
                                ${isEditing ? '<p style="font-size: 11px; color: var(--text-secondary); margin-top: 5px;">Ajuste o estoque na tela de Movimenta√ß√µes.</p>' : ''}
                            </div>
                            <div class="form-group">
                                <label>Estoque M√≠nimo</label>
                                <input type="number" id="prod-minimo" min="0" value="${state.editingItem?.estoqueMinimo || 0}">
                            </div>
                            <div class="form-group">
                                <label>Valor Custo (R$)</label>
                                <input type="number" id="prod-custo" min="0" step="0.01" value="${state.editingItem?.valorCusto || 0}">
                            </div>
                            <div class="form-group">
                                <label>Valor Venda (R$)</label>
                                <input type="number" id="prod-venda" min="0" step="0.01" value="${state.editingItem?.valorVenda || 0}">
                            </div>
                            <div class="form-group">
                                <label>URL da Foto</label>
                                <input type="url" id="prod-foto" placeholder="https://..." value="${state.editingItem?.foto || ''}">
                            </div>
                            <div class="form-group">
                                <label>Status Ativo *</label>
                                <div class="radio-group">
                                    <label>
                                        <input type="radio" name="prod-ativo" value="true" ${!isEditing || state.editingItem.ativo ? 'checked' : ''}> Ativo
                                    </label>
                                    <label>
                                        <input type="radio" name="prod-ativo" value="false" ${isEditing && !state.editingItem.ativo ? 'checked' : ''}> Inativo
                                    </label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Visibilidade (no Estoque) *</label>
                                <div class="radio-group">
                                    <label>
                                        <input type="radio" name="prod-visivel" value="true" ${!isEditing || state.editingItem.visivel ? 'checked' : ''}> Vis√≠vel
                                    </label>
                                    <label>
                                        <input type="radio" name="prod-visivel" value="false" ${isEditing && !state.editingItem.visivel ? 'checked' : ''}> Oculto (Saiu de Linha)
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 12px; margin-top: 20px;">
                            <button type="submit" class="btn btn-primary" style="flex: 1;">
                                üíæ ${isEditing ? 'Atualizar' : 'Cadastrar'} Produto
                            </button>
                            ${isEditing ? `
                                <button type="button" class="btn btn-secondary" onclick="state.editingItem = null; render()">
                                    Cancelar Edi√ß√£o
                                </button>
                            ` : ''}
                        </div>
                    </form>
                </div>
                
                <div class="table-container">
                    <div style="padding: 20px; border-bottom: 1px solid var(--border);">
                        <h3 style="font-size: 18px; font-weight: 700;">Produtos Cadastrados</h3>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>SKU</th>
                                <th>Descri√ß√£o</th>
                                <th>Linha</th>
                                <th>Quantidade</th>
                                <th>Custo</th>
                                <th>Venda</th>
                                <th>Status</th>
                                <th>Vis√≠vel</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${state.produtos.map(p => `
                                <tr>
                                    <td><strong>${p.sku}</strong></td>
                                    <td>${p.descricao}</td>
                                    <td><span class="badge badge-blue">${p.linha}</span></td>
                                    <td><strong>${p.quantidade}</strong></td>
                                    <td>R$ ${p.valorCusto.toFixed(2)}</td>
                                    <td>R$ ${p.valorVenda.toFixed(2)}</td>
                                    <td>
                                        <span class="badge ${p.ativo ? 'badge-success' : 'badge-gray'}">
                                            ${p.ativo ? '‚úì Ativo' : '‚úó Inativo'}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge ${p.visivel ? 'badge-success' : 'badge-danger'}">
                                            ${p.visivel ? '‚úì Vis√≠vel' : '‚úó Oculto'}
                                        </span>
                                    </td>
                                    <td>
                                        <button class="icon-btn" onclick="editarProduto('${p.id}')">‚úèÔ∏è</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderImportar() {
            if (state.currentUser.role !== 'admin') {
                return '<div class="form-card"><h3 style="color: var(--danger);">Acesso Negado</h3><p>Somente Administradores podem importar planilhas.</p></div>';
            }
            // ... (Restante do formul√°rio de importa√ß√£o)
             return `
                <div class="form-card">
                    <h3>üì§ Importar Planilha de Produtos</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 24px;">
                        Arraste um arquivo CSV ou clique para selecionar. Novos produtos ser√£o adicionados, SKUs existentes ser√£o ignorados.
                    </p>
                    
                    <div class="upload-area" onclick="document.getElementById('file-input').click()">
                        <div style="font-size: 48px; margin-bottom: 16px;">üìÅ</div>
                        <p style="font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">Clique ou arraste o arquivo aqui</p>
                        <p style="font-size: 13px; color: var(--text-secondary);">CSV, TXT (separado por v√≠rgula, ponto-e-v√≠rgula ou tab)</p>
                    </div>
                    
                    <input type="file" id="file-input" accept=".csv,.txt" onchange="handleFileSelect(event)" style="display: none;">
                    
                    <div style="padding: 16px; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border: 1px solid var(--secondary); margin-top: 20px;">
                        <p style="font-weight: 600; color: var(--secondary); margin-bottom: 8px;">üìã Formato da Planilha (Ordem das Colunas):</p>
                        <p style="font-size: 13px; color: var(--text-primary); margin-bottom: 8px;">
                            <strong>SKU</strong> | <strong>Descri√ß√£o</strong> | <strong>Linha</strong> | <strong>Estoque Inicial</strong> | <strong>Estoque M√≠nimo</strong> | <strong>Valor Custo</strong> | <strong>Valor Venda</strong> | <strong>Ativo (Sim/N√£o)</strong> | <strong>Vis√≠vel (Sim/N√£o)</strong> | <strong>URL Foto (Opcional)</strong>
                        </p>
                        <p style="font-size: 12px; color: var(--text-secondary);">
                            Exemplo: POL-001;Tinta Branca 18L;Tintas;100;50;89.90;159.90;Sim;Sim;https://url-da-foto.com/tinta.jpg
                        </p>
                    </div>
                </div>
            `;
        }

        // Fun√ß√£o que agrupa Respons√°veis e Linhas
        function renderConfiguracoes() {
            if (state.currentUser.role !== 'admin') {
                return '<div class="form-card"><h3 style="color: var(--danger);">Acesso Negado</h3><p>Somente Administradores podem acessar as configura√ß√µes.</p></div>';
            }
            const currentConfigTab = state.activeTab === 'nova-linha' ? 'linhas' : 'responsaveis';

            return `
                <div style="display: flex; gap: 12px; margin-bottom: 24px;">
                    <button class="btn ${currentConfigTab === 'responsaveis' ? 'btn-primary' : 'btn-secondary'}" onclick="changeTab('novo-responsavel')">
                        üë• Gerenciar Respons√°veis
                    </button>
                    <button class="btn ${currentConfigTab === 'linhas' ? 'btn-primary' : 'btn-secondary'}" onclick="changeTab('nova-linha')">
                        üè∑Ô∏è Gerenciar Linhas de Produto
                    </button>
                    ${state.editingItem ? `
                        <button type="button" class="btn btn-secondary" onclick="state.editingItem = null; render()">
                            Cancelar Edi√ß√£o
                        </button>
                    ` : ''}
                </div>
                
                ${currentConfigTab === 'responsaveis' ? renderNovoResponsavelFormAndTable() : renderNovaLinhaFormAndTable()}
            `;
        }
        
        function renderNovoResponsavelFormAndTable() {
            const isEditing = !!state.editingItem;
            // ... (Restante dos formul√°rios e tabelas)
             return `
                <div class="form-card">
                    <h3>${isEditing ? 'Editar Respons√°vel' : 'Cadastrar Novo Respons√°vel'}</h3>
                    <form onsubmit="salvarResponsavel(event); return false;">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Nome *</label>
                                <input type="text" id="resp-nome" placeholder="Nome" value="${state.editingItem?.nome || ''}" required>
                            </div>
                            <div class="form-group">
                                <label>Sobrenome *</label>
                                <input type="text" id="resp-sobrenome" placeholder="Sobrenome" value="${state.editingItem?.sobrenome || ''}" required>
                            </div>
                            <div class="form-group">
                                <label>Departamento *</label>
                                <input type="text" id="resp-departamento" placeholder="Ex: Estoque, Comercial" value="${state.editingItem?.departamento || ''}" required>
                            </div>
                            <div class="form-group">
                                <label>Status</label>
                                <div class="radio-group">
                                    <label>
                                        <input type="radio" name="resp-ativo" value="true" ${!isEditing || state.editingItem.ativo ? 'checked' : ''}> Ativo
                                    </label>
                                    <label>
                                        <input type="radio" name="resp-ativo" value="false" ${isEditing && !state.editingItem.ativo ? 'checked' : ''}> Inativo
                                    </label>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 20px;">
                            üíæ ${isEditing ? 'Atualizar' : 'Cadastrar'} Respons√°vel
                        </button>
                    </form>
                </div>

                <div class="table-container">
                    <div style="padding: 20px; border-bottom: 1px solid var(--border);">
                        <h3 style="font-size: 18px; font-weight: 700;">Respons√°veis Cadastrados</h3>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Departamento</th>
                                <th>Status</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${state.responsaveis.map(r => `
                                <tr>
                                    <td><strong>${r.nome} ${r.sobrenome}</strong></td>
                                    <td><span class="badge badge-blue">${r.departamento}</span></td>
                                    <td>
                                        <span class="badge ${r.ativo ? 'badge-success' : 'badge-gray'}">
                                            ${r.ativo ? '‚úì Ativo' : '‚úó Inativo'}
                                        </span>
                                    </td>
                                    <td>
                                        <button class="icon-btn" onclick="editarResponsavel('${r.id}')">‚úèÔ∏è</button>
                                        <button class="icon-btn" onclick="deletarResponsavel('${r.id}')" style="color: var(--danger);">üóëÔ∏è</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderNovaLinhaFormAndTable() {
            const isEditing = !!state.editingItem;
            // ... (Restante dos formul√°rios e tabelas)
            return `
                <div class="form-card">
                    <h3>${isEditing ? 'Editar Linha' : 'Cadastrar Nova Linha de Produto'}</h3>
                    <form onsubmit="salvarLinha(event); return false;">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>C√≥digo da Linha *</label>
                                <input type="text" id="linha-codigo" placeholder="Ex: TIN, VER" value="${state.editingItem?.codigo || ''}" required>
                            </div>
                            <div class="form-group">
                                <label>Nome da Linha *</label>
                                <input type="text" id="linha-nome" placeholder="Ex: Tintas, Vernizes" value="${state.editingItem?.nome || ''}" required>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 20px;">
                            üíæ ${isEditing ? 'Atualizar' : 'Cadastrar'} Linha
                        </button>
                    </form>
                </div>

                <div class="table-container">
                    <div style="padding: 20px; border-bottom: 1px solid var(--border);">
                        <h3 style="font-size: 18px; font-weight: 700;">Linhas Cadastradas</h3>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>C√≥digo</th>
                                <th>Nome da Linha</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${state.linhas.map(l => `
                                <tr>
                                    <td><strong>${l.codigo}</strong></td>
                                    <td><span class="badge badge-blue">${l.nome}</span></td>
                                    <td>
                                        <button class="icon-btn" onclick="editarLinha('${l.id}')">‚úèÔ∏è</button>
                                        <button class="icon-btn" onclick="deletarLinha('${l.id}')" style="color: var(--danger);">üóëÔ∏è</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }


        function renderEstoque() {
            const isConfigTab = state.activeTab === 'novo-responsavel' || state.activeTab === 'nova-linha';
            
            return `
                <div class="app-container">
                    <div class="sidebar">
                        ${renderSidebar()}
                    </div>
                    
                    <div class="main-content">
                        <header class="header">
                            ${renderHeader()}
                        </header>
                        
                        <div id="alert-container"></div>
                        
                        <main class="content-area">
                            ${state.activeTab === 'dashboard' ? renderDashboard() : 
                              state.activeTab === 'consulta' ? renderConsulta() :
                              state.activeTab === 'estoque' ? renderEstoqueGeral() :
                              state.activeTab === 'movimentacoes' ? renderMovimentacoes() :
                              state.activeTab === 'nova-movimentacao' ? renderNovaMovimentacao() :
                              state.activeTab === 'novo-produto' ? renderNovoProduto() :
                              state.activeTab === 'importar' ? renderImportar() :
                              isConfigTab ? renderConfiguracoes() : ''}
                        </main>
                    </div>
                </div>
            `;
        }

        function render() {
            const app = document.getElementById('app');
            
            if (state.currentView === 'login') {
                app.innerHTML = renderLogin();
            } else if (state.currentView === 'departamentos') {
                app.innerHTML = renderDepartamentos();
            } else if (state.currentView === 'estoque') {
                app.innerHTML = renderEstoque();
                // Garante que o tipo de movimento inicial esteja correto ao carregar a tela
                if (state.activeTab === 'nova-movimentacao') {
                    setTimeout(() => setTipoMovimento('entrada'), 0);
                }
            }
        }

        init();
    </script>
</body>
</html>
