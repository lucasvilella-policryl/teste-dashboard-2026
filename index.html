<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Policryl Ecossistema de Gestão</title>
    <style>
        /* Base e Reset */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Variáveis de Tema */
        :root {
            --primary: #10b981; /* Verde - Principal */
            --primary-dark: #059669;
            --secondary: #3b82f6; /* Azul - Destaque */
            --danger: #ef4444;
            --warning: #f59e0b;
            --success: #22c55e;
            
            /* Cores de Departamento (Omie Style) */
            --dept-crm: #3b82f6; 
            --dept-vendas: #f97316; 
            --dept-supply: #10b981; 
            --dept-financeiro: #22c55e; 
            --dept-rh: #7c3aed; 
            --dept-admin: #64748b; 

            /* Light Mode - Estilo Profissional Clean */
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --border: #e2e8f0;
            --sidebar-bg: #1e293b;
            --card-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        [data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
            --sidebar-bg: #0f172a;
            --card-shadow: 0 8px 20px rgba(0,0,0,0.5);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: background 0.3s, color 0.3s;
            line-height: 1.6;
            overflow: auto; 
        }

        /* UTILITÁRIOS */
        .hidden { display: none !important; }

        /* LOGIN SCREEN */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--secondary) 0%, #764ba2 100%);
            padding: 20px;
        }

        .login-box {
            background: var(--bg-primary);
            padding: 48px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 420px;
        }

        .login-box h1 {
            font-size: 32px;
            color: var(--primary);
            margin-bottom: 8px;
            text-align: center;
        }

        .login-box p {
            color: var(--text-secondary);
            margin-bottom: 32px;
            text-align: center;
        }
        
        .role-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        .role-btn {
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        .role-btn.active-role {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);
        }
        .role-btn:hover:not(.active-role) {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        /* DEPARTAMENTOS SCREEN (Omie Style) */
        .departamentos-container {
            min-height: 100vh;
            background: var(--bg-secondary);
            padding: 40px 20px;
        }

        .departamentos-header {
            max-width: 1200px;
            margin: 0 auto 40px;
            color: var(--text-primary);
            padding-left: 10px;
        }

        .departamentos-header h1 {
            font-size: 30px;
            margin-bottom: 8px;
            font-weight: 700;
        }

        .departamentos-header p {
            color: var(--text-secondary);
            font-size: 16px;
        }

        .departamentos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
            gap: 16px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .departamento-card {
            background: var(--bg-primary);
            padding: 20px;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s;
            color: var(--text-primary);
            box-shadow: var(--card-shadow);
            border-left: 6px solid var(--dept-admin); 
        }
        
        .departamento-card.crm { border-left-color: var(--dept-crm); }
        .departamento-card.estoque { border-left-color: var(--dept-vendas); }
        .departamento-card.supply { border-left-color: var(--dept-supply); }
        .departamento-card.financeiro { border-left-color: var(--dept-financeiro); }
        .departamento-card.rh { border-left-color: var(--dept-rh); }

        .departamento-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(0,0,0,0.15);
        }
        
        .departamento-card.disabled {
            opacity: 0.5;
            cursor: default;
        }
        .departamento-card.disabled:hover {
            transform: none;
            box-shadow: var(--card-shadow);
        }

        .departamento-card-icon {
            font-size: 28px;
            margin-bottom: 12px;
            width: 48px;
            height: 48px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-tertiary);
        }

        .departamento-card h3 {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
        }
        .departamento-card p {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* SYSTEM APP - ESTOQUE */
        .app-container {
            display: flex;
            height: 100vh;
            background: var(--bg-secondary);
        }
        
        .sidebar {
            width: 260px;
            background: var(--sidebar-bg);
            color: white;
            display: flex;
            flex-direction: column;
            box-shadow: 4px 0 20px rgba(0,0,0,0.15);
        }

        .sidebar-header {
            padding: 24px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .sidebar-header h1 {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .sidebar-header p {
            font-size: 12px;
            color: #94a3b8;
        }

        .user-info {
            padding: 16px 20px;
            background: rgba(16, 185, 129, 0.1);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
        }

        .user-details .name {
            font-weight: 600;
            font-size: 14px;
        }

        .user-details .role {
            font-size: 11px;
            color: var(--primary);
            margin-top: 2px;
        }

        .theme-toggle {
            padding: 12px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .theme-toggle button {
            width: 100%;
            padding: 8px 12px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.2s;
        }

        .theme-toggle button:hover {
            background: rgba(255,255,255,0.2);
        }

        .sidebar-nav {
            flex: 1;
            overflow-y: auto;
            padding: 16px 0;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 11px 20px;
            color: #cbd5e1;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 13px;
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .nav-item.active {
            background: var(--primary);
            color: white;
            font-weight: 600;
        }

        .back-btn, .logout-btn {
            margin: 12px 20px;
            padding: 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: all 0.2s;
        }

        .back-btn {
            background: var(--secondary);
            color: white;
        }

        .back-btn:hover {
            background: #2563eb;
        }

        .logout-btn {
            background: var(--danger);
            color: white;
        }

        .logout-btn:hover {
            background: #dc2626;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border);
            padding: 20px 32px;
            box-shadow: var(--card-shadow);
            z-index: 10;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .header h2 {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .header p {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 11px 14px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.2s;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .alert {
            padding: 14px 20px;
            margin: 0 24px 0;
            margin-top: 16px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
            font-size: 13px;
            animation: slideDown 0.3s;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--bg-primary);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            border-left: 4px solid var(--primary);
        }
        
        .stat-card.blue { border-left-color: var(--secondary); }
        .stat-card.yellow { border-left-color: var(--warning); }
        .stat-card.red { border-left-color: var(--danger); }

        .stat-card h3 {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .filters {
            background: var(--bg-primary);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            margin-bottom: 20px;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
        }

        .table-container {
            background: var(--bg-primary);
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            overflow: hidden;
            border: 1px solid var(--border);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border);
        }

        th {
            padding: 12px 16px;
            text-align: left;
            font-size: 11px;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border);
            font-size: 13px;
            color: var(--text-primary);
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        tbody tr:hover {
            background: var(--bg-secondary);
        }

        .product-img {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            object-fit: cover;
            cursor: pointer;
            transition: transform 0.2s;
            border: 1px solid var(--border);
        }

        .product-img:hover {
            transform: scale(1.05);
        }

        .img-placeholder {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-size: 20px;
            border: 1px solid var(--border);
        }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge-success { background: #d1fae5; color: #065f46; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .badge-danger { background: #fee2e2; color: #991b1b; }
        .badge-blue { background: #dbeafe; color: #1e40af; }
        .badge-gray { background: #f3f4f6; color: #4b5563; }
        .badge-purple { background: #e9d5ff; color: #6b21a8; }

        [data-theme="dark"] .badge-success { background: rgba(16, 185, 129, 0.2); color: #6ee7b7; }
        [data-theme="dark"] .badge-warning { background: rgba(245, 158, 11, 0.2); color: #fbbf24; }
        [data-theme="dark"] .badge-danger { background: rgba(239, 68, 68, 0.2); color: #fca5a5; }
        [data-theme="dark"] .badge-blue { background: rgba(59, 130, 246, 0.2); color: #93c5fd; }
        [data-theme="dark"] .badge-gray { background: rgba(148, 163, 184, 0.2); color: #cbd5e1; }
        [data-theme="dark"] .badge-purple { background: rgba(124, 58, 237, 0.2); color: #a78bfa; }


        .form-card {
            background: var(--bg-primary);
            padding: 24px;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }

        .form-card h3 {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 20px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
        }

        .upload-area {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--bg-secondary);
        }

        .upload-area:hover {
            border-color: var(--primary);
            background: rgba(16, 185, 129, 0.05);
        }

        .radio-group {
            display: flex;
            gap: 20px;
        }

        .radio-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .icon-btn {
            padding: 6px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            transition: transform 0.2s;
            color: var(--text-secondary);
        }

        .icon-btn:hover {
            transform: scale(1.1);
            color: var(--text-primary);
        }

        .icon-btn.delete {
            color: var(--danger);
        }
        
        /* Modal para ampliar imagem */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            max-width: 90%;
            max-height: 90%;
            border-radius: 12px;
            object-fit: contain;
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 40px;
            color: white;
            font-size: 40px;
            cursor: pointer;
            transition: color 0.2s;
        }

        .modal-close:hover {
            color: var(--danger);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .role-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 768px) {
            .sidebar { width: 80px; }
            .sidebar-header h1, .sidebar-header p, .nav-item span:last-child, .user-details { display: none; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .form-grid { grid-template-columns: 1fr; }
            .content-area { padding: 16px; }
            .departamentos-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body data-theme="light">
    <div id="app"></div>

    <div id="imageModal" class="modal" onclick="closeModal()">
        <span class="modal-close">&times;</span>
        <img class="modal-content" id="modalImage">
    </div>

    <script>
        // ==================== STORAGE ====================
        const storage = {
            get(key) {
                try {
                    const data = localStorage.getItem(key);
                    return data ? JSON.parse(data) : null;
                } catch (error) {
                    return null;
                }
            },
            set(key, value) {
                try {
                    localStorage.setItem(key, JSON.stringify(value));
                    return true;
                } catch (error) {
                    return false;
                }
            },
            remove(key) {
                try {
                    localStorage.removeItem(key);
                    return true;
                } catch (error) {
                    return false;
                }
            }
        };

        // ==================== STATE ====================
        let state = {
            currentUser: null,
            currentView: 'login',
            activeTab: 'dashboard',
            produtos: [], 
            movimentacoes: [],
            responsaveis: [],
            linhas: [],
            searchTerm: '',
            filterStatus: 'todos',
            filterLinha: 'todas',
            sortBy: 'status',
            sortOrder: 'asc',
            consultaSKU: '',
            editingItem: null,
            theme: 'light',
            tipoMovimento: 'entrada',
            loginRole: 'admin' 
        };

        // ==================== INIT DATA ====================
        function initData() {
            let usuarios = storage.get('policryl-usuarios');
            if (!usuarios) {
                usuarios = [
                    { id: '1', email: 'lucas.vilella@policryl.com.br', password: 'password', nome: 'Lucas Vilella', role: 'admin' },
                    { id: '2', email: 'operador@policryl.com.br', password: 'password', nome: 'Operador Padrão', role: 'operador' },
                    { id: '3', email: 'leitor@policryl.com.br', password: 'password', nome: 'Leitor Padrão', role: 'leitor' }
                ];
                storage.set('policryl-usuarios', usuarios);
            }

            let produtos = storage.get('policryl-produtos');
            if (!produtos) {
                produtos = [
                    { id: '1', sku: 'POL-001', descricao: 'Tinta Acrílica Branca 18L', linha: 'Tintas', quantidade: 150, estoqueMinimo: 50, valorCusto: 89.90, valorVenda: 159.90, foto: 'https://via.placeholder.com/150/f97316/ffffff?text=POL-001', ativo: true, visivel: true, ultimaAtualizacao: new Date().toISOString() },
                    { id: '2', sku: 'POL-002', descricao: 'Verniz Acrílico 3.6L', linha: 'Vernizes', quantidade: 35, estoqueMinimo: 40, valorCusto: 45.90, valorVenda: 89.90, foto: 'https://via.placeholder.com/150/3b82f6/ffffff?text=POL-002', ativo: true, visivel: true, ultimaAtualizacao: new Date().toISOString() },
                    { id: '3', sku: 'POL-003', descricao: 'Primer Acrílico 18L (Oculto)', linha: 'Primers', quantidade: 80, estoqueMinimo: 30, valorCusto: 79.90, valorVenda: 139.90, foto: 'https://via.placeholder.com/150/ef4444/ffffff?text=POL-003', ativo: true, visivel: false, ultimaAtualizacao: new Date().toISOString() },
                    { id: '4', sku: 'POL-004', descricao: 'Massa Acrílica 25kg', linha: 'Massas', quantidade: 25, estoqueMinimo: 20, valorCusto: 25.00, valorVenda: 45.00, foto: 'https://via.placeholder.com/150/10b981/ffffff?text=POL-004', ativo: true, visivel: true, ultimaAtualizacao: new Date().toISOString() },
                    { id: '5', sku: 'POL-005', descricao: 'Selador Acrílico 18L', linha: 'Seladores', quantidade: 15, estoqueMinimo: 25, valorCusto: 70.00, valorVenda: 110.00, foto: 'https://via.placeholder.com/150/7c3aed/ffffff?text=POL-005', ativo: true, visivel: true, ultimaAtualizacao: new Date().toISOString() }
                ];
                storage.set('policryl-produtos', produtos);
            }

            state.produtos = produtos;
            state.movimentacoes = storage.get('policryl-movimentacoes') || [];
            state.responsaveis = storage.get('policryl-responsaveis') || [
                { id: '1', nome: 'João', sobrenome: 'Silva', departamento: 'Estoque', ativo: true },
                { id: '2', nome: 'Maria', sobrenome: 'Santos', departamento: 'Comercial', ativo: true },
                { id: '3', nome: 'Pedro', sobrenome: 'Costa', departamento: 'Qualidade', ativo: true }
            ];
            state.linhas = storage.get('policryl-linhas') || [
                { id: '1', codigo: 'TIN', nome: 'Tintas' },
                { id: '2', codigo: 'VER', nome: 'Vernizes' },
                { id: '3', codigo: 'PRI', nome: 'Primers' },
                { id: '4', codigo: 'MAS', nome: 'Massas' },
                { id: '5', codigo: 'SEL', nome: 'Seladores' }
            ];

            state.theme = storage.get('policryl-theme') || 'light';
            document.body.setAttribute('data-theme', state.theme);

            state.currentUser = storage.get('policryl-current-user');
            if (state.currentUser) {
                state.currentView = 'departamentos';
            }
        }

        // ==================== HELPERS E UTILS ====================
        function toggleTheme() {
            state.theme = state.theme === 'light' ? 'dark' : 'light';
            document.body.setAttribute('data-theme', state.theme);
            storage.set('policryl-theme', state.theme);
            render();
        }

        function login(email, password, role) {
            const usuarios = storage.get('policryl-usuarios');
            const user = usuarios.find(u => u.email === email && u.password === password && u.role === role);
            if (user) {
                state.currentUser = user;
                storage.set('policryl-current-user', user);
                state.currentView = 'departamentos';
                return true;
            }
            return false;
        }

        function logout() {
            state.currentUser = null;
            state.currentView = 'login';
            localStorage.removeItem('policryl-current-user');
            render();
        }

        function handleLoginSubmit(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const role = state.loginRole;
            
            if (login(email, password, role)) {
                state.currentView = 'departamentos';
                render();
            } else {
                const alertDiv = document.getElementById('login-alert');
                if (alertDiv) {
                    alertDiv.innerHTML = `
                        <div class="alert alert-error" style="margin-bottom: 20px;">
                            Credenciais ou Perfil de Acesso incorretos. Senha de teste padrão: 'password'
                        </div>
                    `;
                    setTimeout(() => {
                        alertDiv.innerHTML = '';
                    }, 3000);
                }
            }
            return false;
        }

        function setLoginRole(role) {
            state.loginRole = role;
            const emailInput = document.getElementById('login-email');
            
            if (role === 'admin') {
                emailInput.value = 'lucas.vilella@policryl.com.br';
            } else if (role === 'operador') {
                emailInput.value = 'operador@policryl.com.br';
            } else {
                emailInput.value = 'leitor@policryl.com.br';
            }
            document.getElementById('login-password').value = 'password';
            render();
        }
        
        function abrirDepartamento(dept) {
            if (dept === 'estoque') {
                state.currentView = 'estoque';
                state.activeTab = 'dashboard';
                render();
            } else {
                showAlert(`Módulo ${dept.toUpperCase()} em desenvolvimento`, 'error');
            }
        }

        function voltarDepartamentos() {
            state.currentView = 'departamentos';
            render();
        }

        function changeTab(tab) {
            state.activeTab = tab;
            state.editingItem = null;
            render();
        }
        
        function openImageModal(imgSrc) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            modal.classList.add('active');
            modalImg.src = imgSrc;
        }

        function closeModal() {
            document.getElementById('imageModal').classList.remove('active');
        }

        function getStatusProduto(produto) {
            if (produto.quantidade < produto.estoqueMinimo) return 'abaixo';
            if (produto.quantidade <= produto.estoqueMinimo * 1.2) return 'proximo';
            return 'ok';
        }

        function getStatusLabel(status) {
            const labels = {
                'abaixo': 'Abaixo do Mínimo',
                'proximo': 'Próximo do Mínimo',
                'ok': 'OK'
            };
            return labels[status] || 'OK';
        }

        function calcularEstatisticas() {
            const produtosVisiveis = state.produtos.filter(p => state.currentUser.role === 'admin' || p.visivel);
            const total = produtosVisiveis.length;
            const ativos = produtosVisiveis.filter(p => p.ativo).length;
            const inativos = total - ativos;
            const ok = produtosVisiveis.filter(p => getStatusProduto(p) === 'ok').length;
            const proximo = produtosVisiveis.filter(p => getStatusProduto(p) === 'proximo').length;
            const abaixo = produtosVisiveis.filter(p => getStatusProduto(p) === 'abaixo').length;

            return { total, ativos, inativos, ok, proximo, abaixo, produtosVisiveis: state.produtos.length };
        }

        function showAlert(message, type = 'success') {
            const container = document.getElementById('alert-container');
            container.innerHTML = `
                <div class="alert alert-${type}">
                    <span>${message}</span>
                </div>
            `;
            setTimeout(() => {
                container.innerHTML = '';
            }, 3000);
        }

        function getProdutosFiltrados() {
            const produtosBase = state.currentUser.role === 'admin' 
                ? state.produtos 
                : state.produtos.filter(p => p.visivel);
                
            return produtosBase.filter(p => {
                const matchSearch = p.sku.toLowerCase().includes(state.searchTerm.toLowerCase()) || 
                                   p.descricao.toLowerCase().includes(state.searchTerm.toLowerCase());
                const matchStatus = state.filterStatus === 'todos' || 
                                   (state.filterStatus === 'ativo' && p.ativo) ||
                                   (state.filterStatus === 'inativo' && !p.ativo) ||
                                   getStatusProduto(p) === state.filterStatus;
                const matchLinha = state.filterLinha === 'todas' || p.linha === state.filterLinha;
                return matchSearch && matchStatus && matchLinha;
            }).sort((a, b) => {
                if (state.sortBy === 'status') {
                    const statusOrder = { 'abaixo': 0, 'proximo': 1, 'ok': 2 };
                    return statusOrder[getStatusProduto(a)] - statusOrder[getStatusProduto(b)];
                } else if (state.sortBy === 'quantidade') {
                    return state.sortOrder === 'asc' ? a.quantidade - b.quantidade : b.quantidade - a.quantidade;
                }
                return 0;
            });
        }
        
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) importarPlanilha(file);
        }

        function importarPlanilha(file) {
            if (state.currentUser.role !== 'admin') {
                showAlert('Acesso negado: Somente Administradores podem importar planilhas.', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    const lines = text.split('\n');
                    let importados = 0;
                    
                    for (let i = 1; i < lines.length; i++) {
                        if (!lines[i].trim()) continue;
                        const values = lines[i].split(/[,;\t]/);
                        
                        const produto = {
                            id: Date.now().toString() + i,
                            sku: values[0] ? values[0].trim() : '',
                            descricao: values[1] ? values[1].trim() : '',
                            linha: values[2] ? values[2].trim() : '',
                            quantidade: parseInt(values[3]) || 0,
                            estoqueMinimo: parseInt(values[4]) || 0,
                            valorCusto: parseFloat((values[5] || '0').replace(',', '.')) || 0,
                            valorVenda: parseFloat((values[6] || '0').replace(',', '.')) || 0,
                            ativo: values[7] ? values[7].toLowerCase().includes('sim') : true,
                            visivel: values[8] ? values[8].toLowerCase().includes('sim') : true,
                            foto: values[9] ? values[9].trim() : '', 
                            ultimaAtualizacao: new Date().toISOString()
                        };
                        
                        if (produto.sku && produto.descricao && !state.produtos.some(p => p.sku === produto.sku)) {
                            state.produtos.push(produto);
                            importados++;
                        }
                    }
                    
                    storage.set('policryl-produtos', state.produtos);
                    showAlert(`${importados} produtos importados com sucesso!`, 'success');
                    render();
                } catch (error) {
                    console.error('Erro de importação:', error);
                    showAlert('Erro ao importar planilha. Verifique o formato.', 'error');
                }
            };
            reader.readAsText(file);
        }

        function exportarExcel() {
            const produtosFiltrados = getProdutosFiltrados();
            const isAdmin = state.currentUser.role === 'admin';
            
            const headers = isAdmin 
                ? ['SKU', 'Descrição', 'Linha', 'Quantidade', 'Mínimo', 'Custo', 'Venda', 'Status', 'Visível', 'Ativo', 'Última Atualização']
                : ['SKU', 'Descrição', 'Linha', 'Quantidade', 'Mínimo', 'Status', 'Visível', 'Ativo', 'Última Atualização'];

            const csvData = produtosFiltrados.map(p => {
                if (isAdmin) {
                    return [
                        p.sku,
                        p.descricao,
                        p.linha,
                        p.quantidade,
                        p.estoqueMinimo,
                        p.valorCusto.toFixed(2).replace('.', ','),
                        p.valorVenda.toFixed(2).replace('.', ','),
                        getStatusLabel(getStatusProduto(p)),
                        p.visivel ? 'Sim' : 'Não',
                        p.ativo ? 'Sim' : 'Não',
                        new Date(p.ultimaAtualizacao).toLocaleDateString('pt-BR')
                    ];
                }
                return [
                    p.sku,
                    p.descricao,
                    p.linha,
                    p.quantidade,
                    p.estoqueMinimo,
                    getStatusLabel(getStatusProduto(p)),
                    p.visivel ? 'Sim' : 'Não',
                    p.ativo ? 'Sim' : 'Não',
                    new Date(p.ultimaAtualizacao).toLocaleDateString('pt-BR')
                ];
            });
            
            const csv = [headers.join(';'), ...csvData.map(row => row.join(';'))].join('\n');

            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `estoque_policryl_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            showAlert('Relatório exportado com sucesso!');
        }


        // ==================== ACTIONS ====================
        function setTipoMovimento(tipo) {
            state.tipoMovimento = tipo;
            const btnEntrada = document.getElementById('tipo-entrada');
            const btnSaida = document.getElementById('tipo-saida');
            if (btnEntrada) btnEntrada.className = tipo === 'entrada' ? 'btn btn-primary' : 'btn btn-secondary';
            if (btnSaida) btnSaida.className = tipo === 'saida' ? 'btn btn-primary' : 'btn btn-secondary';
        }

        function salvarMovimentacao(e) {
            e.preventDefault();
            if (state.currentUser.role === 'leitor') {
                showAlert('Acesso negado: Leitores não podem registrar movimentações.', 'error');
                return;
            }
            const sku = document.getElementById('mov-sku').value;
            const quantidade = parseInt(document.getElementById('mov-quantidade').value);
            const pedido = document.getElementById('mov-pedido').value;
            const responsavel = document.getElementById('mov-responsavel').value;

            const produto = state.produtos.find(p => p.sku === sku);
            if (!produto) {
                showAlert('Produto não encontrado', 'error');
                return;
            }

            const novaQuantidade = state.tipoMovimento === 'entrada' ? produto.quantidade + quantidade : produto.quantidade - quantidade;
            if (novaQuantidade < 0) {
                showAlert('Quantidade insuficiente em estoque', 'error');
                return;
            }

            const novaMovimentacao = {
                id: Date.now().toString(),
                sku,
                descricao: produto.descricao,
                linha: produto.linha,
                foto: produto.foto,
                tipo: state.tipoMovimento,
                quantidade,
                pedido,
                responsavel,
                data: new Date().toLocaleDateString('pt-BR'),
                horario: new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })
            };

            state.movimentacoes = [novaMovimentacao, ...state.movimentacoes];
            state.produtos = state.produtos.map(p => 
                p.sku === sku ? { ...p, quantidade: novaQuantidade, ultimaAtualizacao: new Date().toISOString() } : p
            );

            storage.set('policryl-movimentacoes', state.movimentacoes);
            storage.set('policryl-produtos', state.produtos);

            showAlert('Movimentação registrada com sucesso!');
            e.target.reset();
            state.tipoMovimento = 'entrada';
            render();
        }

        function salvarProduto(e) {
            e.preventDefault();
            if (state.currentUser.role !== 'admin') {
                showAlert('Acesso negado: Somente Administradores podem cadastrar/editar produtos.', 'error');
                return;
            }
            const sku = document.getElementById('prod-sku').value;
            const descricao = document.getElementById('prod-descricao').value;
            const linha = document.getElementById('prod-linha').value;
            const estoqueInicial = parseInt(document.getElementById('prod-estoque')?.value) || 0;
            const estoqueMinimo = parseInt(document.getElementById('prod-minimo').value) || 0;
            const valorCusto = parseFloat(document.getElementById('prod-custo').value) || 0;
            const valorVenda = parseFloat(document.getElementById('prod-venda').value) || 0;
            const foto = document.getElementById('prod-foto').value;
            const ativo = document.querySelector('input[name="prod-ativo"]:checked').value === 'true';
            const visivel = document.querySelector('input[name="prod-visivel"]:checked').value === 'true';

            if (state.editingItem) {
                state.produtos = state.produtos.map(p => 
                    p.id === state.editingItem.id 
                        ? { ...p, sku, descricao, linha, estoqueMinimo, valorCusto, valorVenda, foto, ativo, visivel, ultimaAtualizacao: new Date().toISOString(), quantidade: p.quantidade } 
                        : p
                );
                showAlert('Produto atualizado com sucesso!');
                state.editingItem = null;
            } else {
                const novoProduto = {
                    id: Date.now().toString(),
                    sku,
                    descricao,
                    linha,
                    quantidade: estoqueInicial,
                    estoqueMinimo,
                    valorCusto,
                    valorVenda,
                    foto,
                    ativo,
                    visivel,
                    ultimaAtualizacao: new Date().toISOString()
                };
                state.produtos.push(novoProduto);
                showAlert('Produto cadastrado com sucesso!');
            }

            storage.set('policryl-produtos', state.produtos);
            e.target.reset();
            render();
        }

        function salvarResponsavel(e) {
            e.preventDefault();
            if (state.currentUser.role !== 'admin') {
                showAlert('Acesso negado: Somente Administradores podem gerenciar responsáveis.', 'error');
                return;
            }
            const nome = document.getElementById('resp-nome').value;
            const sobrenome = document.getElementById('resp-sobrenome').value;
            const departamento = document.getElementById('resp-departamento').value;
            const ativo = document.querySelector('input[name="resp-ativo"]:checked').value === 'true';

            if (state.editingItem) {
                state.responsaveis = state.responsaveis.map(r => 
                    r.id === state.editingItem.id ? { ...r, nome, sobrenome, departamento, ativo } : r
                );
                showAlert('Responsável atualizado com sucesso!');
                state.editingItem = null;
            } else {
                const novoResponsavel = {
                    id: Date.now().toString(),
                    nome,
                    sobrenome,
                    departamento,
                    ativo
                };
                state.responsaveis.push(novoResponsavel);
                showAlert('Responsável cadastrado com sucesso!');
            }

            storage.set('policryl-responsaveis', state.responsaveis);
            e.target.reset();
            render();
        }

        function salvarLinha(e) {
            e.preventDefault();
            if (state.currentUser.role !== 'admin') {
                showAlert('Acesso negado: Somente Administradores podem gerenciar linhas.', 'error');
                return;
            }
            const codigo = document.getElementById('linha-codigo').value;
            const nome = document.getElementById('linha-nome').value;

            if (state.editingItem) {
                state.linhas = state.linhas.map(l => 
                    l.id === state.editingItem.id ? { ...l, codigo, nome } : l
                );
                showAlert('Linha atualizada com sucesso!');
                state.editingItem = null;
            } else {
                const novaLinha = {
                    id: Date.now().toString(),
                    codigo,
                    nome
                };
                if (state.linhas.some(l => l.nome === nome || l.codigo === codigo)) {
                    showAlert('Linha ou Código já existem', 'error');
                    return;
                }
                state.linhas.push(novaLinha);
                showAlert('Linha cadastrada com sucesso!');
            }

            storage.set('policryl-linhas', state.linhas);
            e.target.reset();
            render();
        }

        function editarProduto(id) {
            if (state.currentUser.role !== 'admin') {
                showAlert('Acesso negado: Somente Administradores podem editar produtos.', 'error');
                return;
            }
            const produto = state.produtos.find(p => p.id === id);
            state.editingItem = produto;
            state.activeTab = 'novo-produto';
            window.scrollTo({ top: 0, behavior: 'smooth' });
            render();
        }

        function editarResponsavel(id) {
            if (state.currentUser.role !== 'admin') return;
            const responsavel = state.responsaveis.find(r => r.id === id);
            state.editingItem = responsavel;
            state.activeTab = 'novo-responsavel';
            window.scrollTo({ top: 0, behavior: 'smooth' });
            render();
        }

        function editarLinha(id) {
            if (state.currentUser.role !== 'admin') return;
            const linha = state.linhas.find(l => l.id === id);
            state.editingItem = linha;
            state.activeTab = 'nova-linha';
            window.scrollTo({ top: 0, behavior: 'smooth' });
            render();
        }

        function deletarResponsavel(id) {
            if (state.currentUser.role !== 'admin') return;
            if (confirm('Tem certeza que deseja excluir este responsável?')) {
                state.responsaveis = state.responsaveis.filter(r => r.id !== id);
                storage.set('policryl-responsaveis', state.responsaveis);
                showAlert('Responsável excluído com sucesso!');
                render();
            }
        }

        function deletarLinha(id) {
            if (state.currentUser.role !== 'admin') return;
            if (confirm('Tem certeza que deseja excluir esta linha?')) {
                if (state.produtos.some(p => p.linha === state.linhas.find(l => l.id === id).nome)) {
                    showAlert('Não é possível excluir: existem produtos associados a esta linha.', 'error');
                    return;
                }
                state.linhas = state.linhas.filter(l => l.id !== id);
                storage.set('policryl-linhas', state.linhas);
                showAlert('Linha excluída com sucesso!');
                render();
            }
        }


        // ==================== RENDER FUNCTIONS - Telas Principais ====================
        function renderLogin() {
            const isLucas = state.loginRole === 'admin';
            const isOp = state.loginRole === 'operador';
            const isLeitor = state.loginRole === 'leitor';

            return `
                <div class="login-container">
                    <div class="login-box">
                        <h1>Policryl</h1>
                        <p>Sistema de Gestão - Acesso</p>
                        <div id="login-alert"></div>
                        
                        <p style="font-size: 13px; font-weight: 600; margin-bottom: 10px; text-align: left; color: var(--text-primary);">Selecione o Perfil:</p>
                        <div class="role-selector">
                            <button type="button" class="role-btn ${isLucas ? 'active-role' : ''}" onclick="setLoginRole('admin')">👑 Admin</button>
                            <button type="button" class="role-btn ${isOp ? 'active-role' : ''}" onclick="setLoginRole('operador')">🛠️ Operador</button>
                            <button type="button" class="role-btn ${isLeitor ? 'active-role' : ''}" onclick="setLoginRole('leitor')">👓 Leitor</button>
                        </div>

                        <form onsubmit="return handleLoginSubmit(event)">
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="login-email" value="${isLucas ? 'lucas.vilella@policryl.com.br' : isOp ? 'operador@policryl.com.br' : 'leitor@policryl.com.br'}" required autofocus>
                            </div>
                            <div class="form-group">
                                <label>Senha</label>
                                <input type="password" id="login-password" value="password" required>
                            </div>
                            <button type="submit" class="btn btn-primary" style="width: 100%;">Entrar</button>
                        </form>
                        <p style="margin-top: 20px; font-size: 12px; color: var(--text-secondary); text-align: center;">
                            Senha de Teste padrão: 'password'
                        </p>
                    </div>
                </div>
            `;
        }

        function renderDepartamentos() {
            const isReadonly = state.currentUser.role === 'leitor';
            const isAdmin = state.currentUser.role === 'admin';
            
            return `
                <div class="departamentos-container">
                    <div class="departamentos-header">
                        <h1>Olá, ${state.currentUser.nome.split(' ')[0]}!</h1>
                        <p>Seu acesso: <strong>${state.currentUser.role.toUpperCase()}</strong>. Em que departamento vamos trabalhar hoje?</p>
                    </div>
                    
                    <div class="departamentos-grid">
                        <div class="departamento-card estoque" onclick="abrirDepartamento('estoque')">
                            <div class="departamento-card-icon" style="background: var(--dept-vendas);">📦</div>
                            <h3>Estoque</h3>
                            <p>Produtos Acabados</p>
                        </div>
                        
                        <div class="departamento-card supply ${isReadonly ? 'disabled' : ''}" onclick="${isReadonly ? '' : `abrirDepartamento('supply')`}">
                            <div class="departamento-card-icon" style="background: var(--dept-supply);">🏭</div>
                            <h3>Supply Chain</h3>
                            <p>Matéria-Prima e Compras</p>
                        </div>
                        
                        <div class="departamento-card crm ${isReadonly ? 'disabled' : ''}" onclick="${isReadonly ? '' : `abrirDepartamento('crm')`}">
                            <div class="departamento-card-icon" style="background: var(--dept-crm);">💼</div>
                            <h3>Comercial/CRM</h3>
                            <p>Vendas e Clientes</p>
                        </div>
                        
                        <div class="departamento-card financeiro ${isReadonly ? 'disabled' : ''}" onclick="${isReadonly ? '' : `abrirDepartamento('financeiro')`}">
                            <div class="departamento-card-icon" style="background: var(--dept-financeiro);">💰</div>
                            <h3>Financeiro</h3>
                            <p>Contas a Pagar/Receber</p>
                        </div>
                        
                        <div class="departamento-card rh ${isAdmin ? '' : 'disabled'}" onclick="${isAdmin ? `abrirDepartamento('rh')` : ''}">
                            <div class="departamento-card-icon" style="background: var(--dept-rh);">🏢</div>
                            <h3>RH/Pessoas</h3>
                            <p>Gestão de Colaboradores</p>
                        </div>
                        
                        <div class="departamento-card admin ${isAdmin ? '' : 'disabled'}" onclick="${isAdmin ? `abrirDepartamento('admin')` : ''}">
                            <div class="departamento-card-icon" style="background: var(--dept-admin);">⚙️</div>
                            <h3>Painel Admin</h3>
                            <p>Gerenciar Usuários</p>
                        </div>
                    </div>
                    
                    <button class="logout-btn" style="max-width: 200px; margin: 40px auto; display: block;" onclick="logout()">🚪 Sair do Sistema</button>
                </div>
            `;
        }

        // ==================== RENDER FUNCTIONS - Módulo Estoque ====================
        function renderSidebarEstoque() {
            const isAdmin = state.currentUser.role === 'admin';
            const isOperator = state.currentUser.role === 'operador';

            const menuItems = [
                { id: 'dashboard', label: 'Status do Estoque', icon: '📊' },
                { id: 'consulta', label: 'Consultar Produto', icon: '🔍' },
                { id: 'estoque', label: 'Estoque Geral', icon: '📦' },
                { id: 'movimentacoes', label: 'Movimentações', icon: '📋' },
                { id: 'nova-movimentacao', label: 'Cadastrar Movimentação', icon: '📈', visible: isAdmin || isOperator },
                { id: 'novo-produto', label: 'Cadastrar Produto', icon: '➕', visible: isAdmin },
                { id: 'importar', label: 'Importar Planilha', icon: '📤', visible: isAdmin },
                { id: 'novo-responsavel', label: 'Gerenciar Responsáveis', icon: '👥', visible: isAdmin }, 
                { id: 'nova-linha', label: 'Gerenciar Linhas', icon: '🏷️', visible: isAdmin } 
            ];
            
            const nav = document.createElement('nav');
            nav.className = 'sidebar-nav';
            nav.id = 'sidebar-nav';
            
            nav.innerHTML = menuItems.filter(item => item.visible !== false).map(item => `
                <button class="nav-item ${state.activeTab === item.id ? 'active' : ''}" onclick="changeTab('${item.id}')">
                    <span>${item.icon}</span>
                    <span>${item.label}</span>
                </button>
            `).join('');

            return `
                <div class="sidebar-header">
                    <h1>Policryl</h1>
                    <p>Estoque de Produtos</p>
                </div>
                <div class="user-info">
                    <div class="user-avatar" style="background: ${isAdmin ? 'var(--primary)' : isOperator ? 'var(--secondary)' : 'var(--warning)'};">${state.currentUser.nome.charAt(0)}</div>
                    <div class="user-details">
                        <div class="name">${state.currentUser.nome.split(' ')[0]}</div>
                        <div class="role">${state.currentUser.role === 'admin' ? '👑 Admin' : state.currentUser.role === 'operador' ? '🛠️ Operador' : '👓 Leitor'}</div>
                    </div>
                </div>
                <div class="theme-toggle">
                    <button onclick="toggleTheme()">
                        ${state.theme === 'light' ? '🌙 Modo Escuro' : '☀️ Modo Claro'}
                    </button>
                </div>
                ${nav.outerHTML}
                <button class="back-btn" onclick="voltarDepartamentos()">⬅️ Ecossistema</button>
                <button class="logout-btn" onclick="logout()">🚪 Sair</button>
            `;
        }

        function renderHeaderEstoque() {
            const isAdmin = state.currentUser.role === 'admin';
            
            const titles = {
                'dashboard': 'Status do Estoque',
                'consulta': 'Consultar Produto',
                'estoque': 'Estoque Geral',
                'movimentacoes': 'Movimentações',
                'nova-movimentacao': 'Cadastrar Movimentação',
                'novo-produto': state.editingItem ? 'Editar Produto' : 'Cadastrar Produto',
                'importar': 'Importar Planilha',
                'novo-responsavel': state.editingItem ? 'Editar Responsável' : 'Gestão de Responsáveis',
                'nova-linha': state.editingItem ? 'Editar Linha' : 'Gestão de Linhas'
            };

            const stats = calcularEstatisticas();
            const subtitles = {
                'dashboard': `${stats.total} produtos visíveis (${stats.produtosVisiveis} cadastrados)`,
                'estoque': `${stats.ativos} produtos ativos`,
                'movimentacoes': `${state.movimentacoes.length} movimentações registradas`
            };
            
            const currentSubtitle = subtitles[state.activeTab] || (isAdmin ? 'Configurações e cadastros base do módulo Estoque.' : '');

            return `
                <div class="header-top">
                    <div>
                        <h2>${titles[state.activeTab]}</h2>
                        <p>${currentSubtitle}</p>
                    </div>
                    <div class="header-actions">
                        ${(state.activeTab === 'dashboard' || state.activeTab === 'estoque' || state.activeTab === 'movimentacoes') ? 
                            `<button class="btn btn-primary" onclick="exportarExcel()">📥 Exportar</button>` : ''}
                    </div>
                </div>
            `;
        }

        function renderDashboard() {
            const stats = calcularEstatisticas();
            const produtosFiltrados = getProdutosFiltrados();
            const isViewer = state.currentUser.role !== 'admin';

            return `
                <div class="stats-grid">
                    <div class="stat-card blue">
                        <h3>Produtos Visíveis</h3>
                        <div class="value">${stats.total}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Produtos Ativos</h3>
                        <div class="value">${stats.ativos}</div>
                    </div>
                    <div class="stat-card yellow">
                        <h3>Próximo Mínimo</h3>
                        <div class="value">${stats.proximo}</div>
                    </div>
                    <div class="stat-card red">
                        <h3>Abaixo Mínimo</h3>
                        <div class="value">${stats.abaixo}</div>
                    </div>
                </div>

                <div class="filters">
                    <div class="filters-grid">
                        <div class="form-group">
                            <label>Buscar</label>
                            <input type="text" placeholder="SKU ou descrição..." value="${state.searchTerm}" oninput="state.searchTerm = this.value; render()">
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select onchange="state.filterStatus = this.value; render()">
                                <option value="todos" ${state.filterStatus === 'todos' ? 'selected' : ''}>Todos</option>
                                <option value="ativo" ${state.filterStatus === 'ativo' ? 'selected' : ''}>Ativos</option>
                                <option value="inativo" ${state.filterStatus === 'inativo' ? 'selected' : ''}>Inativos</option>
                                <option value="abaixo" ${state.filterStatus === 'abaixo' ? 'selected' : ''}>Abaixo do Mínimo</option>
                                <option value="proximo" ${state.filterStatus === 'proximo' ? 'selected' : ''}>Próximo do Mínimo</option>
                                <option value="ok" ${state.filterStatus === 'ok' ? 'selected' : ''}>OK</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Linha</label>
                            <select onchange="state.filterLinha = this.value; render()">
                                <option value="todas" ${state.filterLinha === 'todas' ? 'selected' : ''}>Todas</option>
                                ${state.linhas.map(l => `<option value="${l.nome}" ${state.filterLinha === l.nome ? 'selected' : ''}>${l.nome}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Ordenar por Quantidade</label>
                            <div class="btn-group" style="display: flex; gap: 10px;">
                                <button class="btn ${state.sortBy === 'quantidade' && state.sortOrder === 'asc' ? 'btn-primary' : 'btn-secondary'}" onclick="state.sortBy = 'quantidade'; state.sortOrder = 'asc'; render()">Cresc.</button>
                                <button class="btn ${state.sortBy === 'quantidade' && state.sortOrder === 'desc' ? 'btn-primary' : 'btn-secondary'}" onclick="state.sortBy = 'quantidade'; state.sortOrder = 'desc'; render()">Decresc.</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Foto</th>
                                <th>SKU</th>
                                <th>Descrição</th>
                                <th>Linha</th>
                                <th>Quantidade</th>
                                <th>Mínimo</th>
                                <th class="${isViewer ? 'hidden' : ''}">Custo</th>
                                <th class="${isViewer ? 'hidden' : ''}">Venda</th>
                                <th>Status</th>
                                <th>Ativo/Visível</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${produtosFiltrados.map(p => `
                                <tr>
                                    <td>
                                        ${p.foto ? 
                                            `<img src="${p.foto}" class="product-img" alt="${p.descricao}" onclick="openImageModal('${p.foto}')">` : 
                                            `<div class="img-placeholder">📦</div>`
                                        }
                                    </td>
                                    <td><strong>${p.sku}</strong></td>
                                    <td>${p.descricao}</td>
                                    <td><span class="badge badge-blue">${p.linha}</span></td>
                                    <td><strong>${p.quantidade}</strong></td>
                                    <td>${p.estoqueMinimo}</td>
                                    <td class="${isViewer ? 'hidden' : ''}">R$ ${p.valorCusto.toFixed(2)}</td>
                                    <td class="${isViewer ? 'hidden' : ''}">R$ ${p.valorVenda.toFixed(2)}</td>
                                    <td>
                                        <span class="badge badge-${getStatusProduto(p) === 'ok' ? 'success' : getStatusProduto(p) === 'proximo' ? 'warning' : 'danger'}">
                                            ${getStatusLabel(getStatusProduto(p))}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge ${p.ativo ? 'badge-success' : 'badge-gray'}">
                                            ${p.ativo ? '✓ Ativo' : '✗ Inativo'}
                                        </span>
                                        ${!p.visivel ? '<span class="badge badge-danger" style="margin-left: 5px;">👀 Oculto</span>' : ''}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderConsulta() {
            const produto = state.produtos.find(p => p.sku.toLowerCase() === state.consultaSKU.toLowerCase());
            const isViewer = state.currentUser.role !== 'admin';

            return `
                <div class="form-card">
                    <div class="consulta-search">
                        <input type="text" placeholder="Ex: POL-001" value="${state.consultaSKU}" oninput="state.consultaSKU = this.value">
                        <button class="btn btn-primary" onclick="render()">🔍 Buscar</button>
                    </div>

                    ${produto ? `
                        <div class="form-grid">
                            <div class="info-card" style="background: var(--bg-secondary); border: 1px solid var(--border);">
                                <label>SKU</label>
                                <div class="value">${produto.sku}</div>
                            </div>
                            <div class="info-card" style="background: var(--bg-secondary); border: 1px solid var(--border);">
                                <label>Descrição</label>
                                <div class="value">${produto.descricao}</div>
                            </div>
                            <div class="info-card" style="background: var(--bg-secondary); border: 1px solid var(--border);">
                                <label>Linha</label>
                                <div class="value">${produto.linha}</div>
                            </div>
                            <div class="info-card" style="background: var(--bg-secondary); border: 1px solid var(--border);">
                                <label>Status</label>
                                <div class="value">${produto.ativo ? 'Ativo' : 'Inativo'} ${!produto.visivel ? ' (Oculto)' : ''}</div>
                            </div>
                            <div class="info-card" style="background: rgba(16, 185, 129, 0.1); border: 1px solid var(--primary);">
                                <label>Quantidade Atual</label>
                                <div class="value" style="color: var(--primary);">${produto.quantidade}</div>
                            </div>
                            <div class="info-card" style="background: var(--bg-secondary); border: 1px solid var(--border);">
                                <label>Quantidade Mínima</label>
                                <div class="value">${produto.estoqueMinimo}</div>
                            </div>
                            <div class="info-card ${isViewer ? 'hidden' : ''}" style="background: var(--bg-secondary); border: 1px solid var(--border);">
                                <label>Valor Custo (R$)</label>
                                <div class="value">R$ ${produto.valorCusto.toFixed(2)}</div>
                            </div>
                            <div class="info-card ${isViewer ? 'hidden' : ''}" style="background: var(--bg-secondary); border: 1px solid var(--border);">
                                <label>Valor Venda (R$)</label>
                                <div class="value">R$ ${produto.valorVenda.toFixed(2)}</div>
                            </div>
                        </div>
                        <div style="margin-top: 24px;">
                            <label style="display: block; margin-bottom: 12px; font-weight: 600;">Nível no Estoque</label>
                            <span class="badge badge-${getStatusProduto(produto) === 'ok' ? 'success' : getStatusProduto(produto) === 'proximo' ? 'warning' : 'danger'}" style="font-size: 16px; padding: 10px 20px;">
                                ${getStatusLabel(getStatusProduto(produto))}
                            </span>
                        </div>
                    ` : state.consultaSKU ? `
                        <div class="empty-state" style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
                            <p style="font-size: 18px; font-weight: 600;">Nenhum produto encontrado</p>
                            <p style="margin-top: 8px;">Verifique o SKU e tente novamente</p>
                        </div>
                    ` : `
                        <div class="empty-state" style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
                            <p style="font-size: 18px; font-weight: 600;">Digite um SKU para consultar</p>
                        </div>
                    `}
                </div>
            `;
        }


        function renderEstoqueGeral() {
            const produtosBase = state.currentUser.role === 'admin' 
                ? state.produtos 
                : state.produtos.filter(p => p.visivel);
                
            return `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Foto</th>
                                <th>SKU</th>
                                <th>Descrição</th>
                                <th>Linha</th>
                                <th>Quantidade Atual</th>
                                <th>Última Atualização</th>
                                <th>Mínimo Ideal</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${produtosBase.map(p => `
                                <tr>
                                    <td>
                                        ${p.foto ? 
                                            `<img src="${p.foto}" class="product-img" alt="${p.descricao}" onclick="openImageModal('${p.foto}')">` : 
                                            `<div class="img-placeholder">📦</div>`
                                        }
                                    </td>
                                    <td><strong>${p.sku}</strong></td>
                                    <td>${p.descricao}</td>
                                    <td><span class="badge badge-blue">${p.linha}</span></td>
                                    <td><strong>${p.quantidade}</strong></td>
                                    <td>${new Date(p.ultimaAtualizacao).toLocaleDateString('pt-BR')}</td>
                                    <td>${p.estoqueMinimo}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderMovimentacoes() {
            return `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Horário</th>
                                <th>SKU</th>
                                <th>Descrição</th>
                                <th>Linha</th>
                                <th>Tipo</th>
                                <th>Quantidade</th>
                                <th>Pedido</th>
                                <th>Responsável</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${state.movimentacoes.length === 0 ? `
                                <tr>
                                    <td colspan="9" style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
                                        <p style="font-size: 18px; font-weight: 600;">Nenhuma movimentação registrada</p>
                                    </td>
                                </tr>
                            ` : state.movimentacoes.map(m => `
                                <tr>
                                    <td>${m.data}</td>
                                    <td>${m.horario}</td>
                                    <td><strong>${m.sku}</strong></td>
                                    <td>${m.descricao}</td>
                                    <td><span class="badge badge-blue">${m.linha}</span></td>
                                    <td>
                                        <span class="badge ${m.tipo === 'entrada' ? 'badge-success' : 'badge-danger'}">
                                            ${m.tipo === 'entrada' ? '↑ Entrada' : '↓ Saída'}
                                        </span>
                                    </td>
                                    <td><strong>${m.tipo === 'entrada' ? '+' : '-'}${m.quantidade}</strong></td>
                                    <td>${m.pedido || '-'}</td>
                                    <td>${m.responsavel}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderNovaMovimentacao() {
             if (state.currentUser.role === 'leitor') {
                return '<div class="form-card"><h3 style="color: var(--danger);">Acesso Negado</h3><p>Somente Administradores e Operadores podem registrar movimentações.</p></div>';
            }
            const produtosDisponiveis = state.produtos.filter(p => p.ativo && p.visivel);

            return `
                <div class="form-card">
                    <h3>Cadastro de Movimentação</h3>
                    <form onsubmit="salvarMovimentacao(event); return false;">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Data</label>
                                <input type="text" value="${new Date().toLocaleDateString('pt-BR')}" disabled>
                            </div>
                            <div class="form-group">
                                <label>Horário</label>
                                <input type="text" value="${new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}" disabled>
                            </div>
                            <div class="form-group" style="grid-column: span 2;">
                                <label>SKU *</label>
                                <select id="mov-sku" required>
                                    <option value="">Selecione um produto...</option>
                                    ${produtosDisponiveis.map(p => `
                                        <option value="${p.sku}">${p.sku} - ${p.descricao}</option>
                                    `).join('')}
                                </select>
                                ${produtosDisponiveis.length === 0 ? '<p style="color: var(--danger); font-size: 12px; margin-top: 5px;">Nenhum produto ativo/visível para movimentação.</p>' : ''}
                            </div>
                            <div class="form-group" style="grid-column: span 2;">
                                <label>Tipo de Movimentação *</label>
                                <div style="display: flex; gap: 12px;">
                                    <button type="button" class="btn btn-primary" id="tipo-entrada" onclick="setTipoMovimento('entrada')" style="flex: 1;">↑ Entrada</button>
                                    <button type="button" class="btn btn-secondary" id="tipo-saida" onclick="setTipoMovimento('saida')" style="flex: 1;">↓ Saída</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Quantidade *</label>
                                <input type="number" id="mov-quantidade" min="1" required>
                            </div>
                            <div class="form-group">
                                <label>Pedido do Movimento</label>
                                <input type="text" id="mov-pedido" placeholder="Ex: #12345">
                            </div>
                            <div class="form-group" style="grid-column: span 2;">
                                <label>Responsável *</label>
                                <select id="mov-responsavel" required>
                                    <option value="">Selecione um responsável...</option>
                                    ${state.responsaveis.filter(r => r.ativo).map(r => `
                                        <option value="${r.nome} ${r.sobrenome}">${r.nome} ${r.sobrenome} - ${r.departamento}</option>
                                    `).join('')}
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 20px;">
                            💾 Registrar Movimentação
                        </button>
                    </form>
                </div>
            `;
        }

        function renderNovoProduto() {
            if (state.currentUser.role !== 'admin') {
                return '<div class="form-card"><h3 style="color: var(--danger);">Acesso Negado</h3><p>Somente Administradores podem cadastrar ou editar produtos.</p></div>';
            }
            const isEditing = !!state.editingItem;
            return `
                <div class="form-card">
                    <h3>${isEditing ? 'Editar Produto' : 'Novo Produto'}</h3>
                    <form onsubmit="salvarProduto(event); return false;">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>SKU *</label>
                                <input type="text" id="prod-sku" placeholder="Ex: POL-001" value="${state.editingItem?.sku || ''}" required>
                            </div>
                            <div class="form-group">
                                <label>Descrição *</label>
                                <input type="text" id="prod-descricao" placeholder="Nome do produto" value="${state.editingItem?.descricao || ''}" required>
                            </div>
                            <div class="form-group">
                                <label>Linha *</label>
                                <select id="prod-linha" required>
                                    <option value="">Selecione uma linha...</option>
                                    ${state.linhas.map(l => `
                                        <option value="${l.nome}" ${state.editingItem?.linha === l.nome ? 'selected' : ''}>${l.nome}</option>
                                    `).join('')}
                                </select>
                            </div>
                            <div class="form-group ${isEditing ? 'hidden' : ''}">
                                <label>Estoque Inicial</label>
                                <input type="number" id="prod-estoque" min="0" value="${state.editingItem?.quantidade || 0}" ${isEditing ? 'disabled' : ''}>
                                ${isEditing ? '<p style="font-size: 11px; color: var(--text-secondary); margin-top: 5px;">Ajuste o estoque na tela de Movimentações.</p>' : ''}
                            </div>
                            <div class="form-group">
                                <label>Estoque Mínimo</label>
                                <input type="number" id="prod-minimo" min="0" value="${state.editingItem?.estoqueMinimo || 0}">
                            </div>
                            <div class="form-group">
                                <label>Valor Custo (R$)</label>
                                <input type="number" id="prod-custo" min="0" step="0.01" value="${state.editingItem?.valorCusto || 0}">
                            </div>
                            <div class="form-group">
                                <label>Valor Venda (R$)</label>
                                <input type="number" id="prod-venda" min="0" step="0.01" value="${state.editingItem?.valorVenda || 0}">
                            </div>
                            <div class="form-group">
                                <label>URL da Foto</label>
                                <input type="url" id="prod-foto" placeholder="https://..." value="${state.editingItem?.foto || ''}">
                            </div>
                            <div class="form-group">
                                <label>Status Ativo *</label>
                                <div class="radio-group">
                                    <label>
                                        <input type="radio" name="prod-ativo" value="true" ${!isEditing || state.editingItem.ativo ? 'checked' : ''}> Ativo
                                    </label>
                                    <label>
                                        <input type="radio" name="prod-ativo" value="false" ${isEditing && !state.editingItem.ativo ? 'checked' : ''}> Inativo
                                    </label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Visibilidade (no Estoque) *</label>
                                <div class="radio-group">
                                    <label>
                                        <input type="radio" name="prod-visivel" value="true" ${!isEditing || state.editingItem.visivel ? 'checked' : ''}> Visível
                                    </label>
                                    <label>
                                        <input type="radio" name="prod-visivel" value="false" ${isEditing && !state.editingItem.visivel ? 'checked' : ''}> Oculto (Saiu de Linha)
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 12px; margin-top: 20px;">
                            <button type="submit" class="btn btn-primary" style="flex: 1;">
                                💾 ${isEditing ? 'Atualizar' : 'Cadastrar'} Produto
                            </button>
                            ${isEditing ? `
                                <button type="button" class="btn btn-secondary" onclick="state.editingItem = null; render()">
                                    Cancelar Edição
                                </button>
                            ` : ''}
                        </div>
                    </form>
                </div>

                <div class="table-container">
                    <div style="padding: 20px; border-bottom: 1px solid var(--border);">
                        <h3 style="font-size: 18px; font-weight: 700;">Produtos Cadastrados</h3>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>SKU</th>
                                <th>Descrição</th>
                                <th>Linha</th>
                                <th>Quantidade</th>
                                <th>Custo</th>
                                <th>Venda</th>
                                <th>Status</th>
                                <th>Visível</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${state.produtos.map(p => `
                                <tr>
                                    <td><strong>${p.sku}</strong></td>
                                    <td>${p.descricao}</td>
                                    <td><span class="badge badge-blue">${p.linha}</span></td>
                                    <td><strong>${p.quantidade}</strong></td>
                                    <td>R$ ${p.valorCusto.toFixed(2)}</td>
                                    <td>R$ ${p.valorVenda.toFixed(2)}</td>
                                    <td>
                                        <span class="badge ${p.ativo ? 'badge-success' : 'badge-gray'}">
                                            ${p.ativo ? '✓ Ativo' : '✗ Inativo'}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge ${p.visivel ? 'badge-success' : 'badge-danger'}">
                                            ${p.visivel ? '✓ Visível' : '✗ Oculto'}
                                        </span>
                                    </td>
                                    <td>
                                        <button class="icon-btn" onclick="editarProduto('${p.id}')">✏️</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        function renderImportar() {
            if (state.currentUser.role !== 'admin') {
                return '<div class="form-card"><h3 style="color: var(--danger);">Acesso Negado</h3><p>Somente Administradores podem importar planilhas.</p></div>';
            }
             return `
                <div class="form-card">
                    <h3>📤 Importar Planilha de Produtos</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 24px;">
                        Arraste um arquivo CSV ou clique para selecionar. Novos produtos serão adicionados, SKUs existentes serão ignorados.
                    </p>
                    
                    <div class="upload-area" onclick="document.getElementById('file-input').click()">
                        <div style="font-size: 48px; margin-bottom: 16px;">📁</div>
                        <p style="font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">Clique ou arraste o arquivo aqui</p>
                        <p style="font-size: 13px; color: var(--text-secondary);">CSV, TXT (separado por vírgula, ponto-e-vírgula ou tab)</p>
                    </div>
                    
                    <input type="file" id="file-input" accept=".csv,.txt" onchange="handleFileSelect(event)" style="display: none;">
                    
                    <div style="padding: 16px; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border: 1px solid var(--secondary); margin-top: 20px;">
                        <p style="font-weight: 600; color: var(--secondary); margin-bottom: 8px;">📋 Formato da Planilha (Ordem das Colunas):</p>
                        <p style="font-size: 13px; color: var(--text-primary); margin-bottom: 8px;">
                            <strong>SKU</strong> | <strong>Descrição</strong> | <strong>Linha</strong> | <strong>Estoque Inicial</strong> | <strong>Estoque Mínimo</strong> | <strong>Valor Custo</strong> | <strong>Valor Venda</strong> | <strong>Ativo (Sim/Não)</strong> | <strong>Visível (Sim/Não)</strong> | <strong>URL Foto (Opcional)</strong>
                        </p>
                        <p style="font-size: 12px; color: var(--text-secondary);">
                            Exemplo: POL-001;Tinta Branca 18L;Tintas;100;50;89.90;159.90;Sim;Sim;https://url-da-foto.com/tinta.jpg
                        </p>
                    </div>
                </div>
            `;
        }

        function renderNovoResponsavel() {
            if (state.currentUser.role !== 'admin') {
                return '<div class="form-card"><h3 style="color: var(--danger);">Acesso Negado</h3><p>Somente Administradores podem gerenciar responsáveis.</p></div>';
            }
            const isEditing = !!state.editingItem;
            return `
                <div class="form-card">
                    <h3>${isEditing ? 'Editar Responsável' : 'Cadastrar Novo Responsável'}</h3>
                    <form onsubmit="salvarResponsavel(event); return false;">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Nome *</label>
                                <input type="text" id="resp-nome" placeholder="Nome" value="${state.editingItem?.nome || ''}" required>
                            </div>
                            <div class="form-group">
                                <label>Sobrenome *</label>
                                <input type="text" id="resp-sobrenome" placeholder="Sobrenome" value="${state.editingItem?.sobrenome || ''}" required>
                            </div>
                            <div class="form-group">
                                <label>Departamento *</label>
                                <input type="text" id="resp-departamento" placeholder="Ex: Estoque, Comercial" value="${state.editingItem?.departamento || ''}" required>
                            </div>
                            <div class="form-group">
                                <label>Status</label>
                                <div class="radio-group">
                                    <label>
                                        <input type="radio" name="resp-ativo" value="true" ${!isEditing || state.editingItem.ativo ? 'checked' : ''}> Ativo
                                    </label>
                                    <label>
                                        <input type="radio" name="resp-ativo" value="false" ${isEditing && !state.editingItem.ativo ? 'checked' : ''}> Inativo
                                    </label>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 20px;">
                            💾 ${isEditing ? 'Atualizar' : 'Cadastrar'} Responsável
                        </button>
                    </form>
                </div>

                <div class="table-container">
                    <div style="padding: 20px; border-bottom: 1px solid var(--border);">
                        <h3 style="font-size: 18px; font-weight: 700;">Responsáveis Cadastrados</h3>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Departamento</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${state.responsaveis.map(r => `
                                <tr>
                                    <td><strong>${r.nome} ${r.sobrenome}</strong></td>
                                    <td><span class="badge badge-purple">${r.departamento}</span></td>
                                    <td>
                                        <span class="badge ${r.ativo ? 'badge-success' : 'badge-gray'}">
                                            ${r.ativo ? '✓ Ativo' : '✗ Inativo'}
                                        </span>
                                    </td>
                                    <td>
                                        <button class="icon-btn" onclick="editarResponsavel('${r.id}')">✏️</button>
                                        <button class="icon-btn delete" onclick="deletarResponsavel('${r.id}')">🗑️</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderNovaLinha() {
            if (state.currentUser.role !== 'admin') {
                return '<div class="form-card"><h3 style="color: var(--danger);">Acesso Negado</h3><p>Somente Administradores podem gerenciar linhas.</p></div>';
            }
            const isEditing = !!state.editingItem;
            return `
                <div class="form-card">
                    <h3>${isEditing ? 'Editar Linha' : 'Cadastrar Nova Linha de Produto'}</h3>
                    <form onsubmit="salvarLinha(event); return false;">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Código da Linha *</label>
                                <input type="text" id="linha-codigo" placeholder="Ex: TIN, VER" value="${state.editingItem?.codigo || ''}" required>
                            </div>
                            <div class="form-group">
                                <label>Nome da Linha *</label>
                                <input type="text" id="linha-nome" placeholder="Ex: Tintas, Vernizes" value="${state.editingItem?.nome || ''}" required>
                            </div>
                        </div>
                        <div style="display: flex; gap: 12px; margin-top: 20px;">
                            <button type="submit" class="btn btn-primary" style="flex: 1;">
                                💾 ${isEditing ? 'Atualizar' : 'Cadastrar'} Linha
                            </button>
                            ${isEditing ? `
                                <button type="button" class="btn btn-secondary" onclick="state.editingItem = null; render()">
                                    Cancelar
                                </button>
                            ` : ''}
                        </div>
                    </form>
                </div>

                <div class="table-container">
                    <div style="padding: 20px; border-bottom: 1px solid var(--border);">
                        <h3 style="font-size: 18px; font-weight: 700;">Linhas Cadastradas</h3>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Código</th>
                                <th>Nome da Linha</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${state.linhas.map(l => `
                                <tr>
                                    <td><strong>${l.codigo}</strong></td>
                                    <td><span class="badge badge-blue">${l.nome}</span></td>
                                    <td>
                                        <div style="display: flex; gap: 8px;">
                                            <button class="icon-btn" onclick="editarLinha('${l.id}')">✏️</button>
                                            <button class="icon-btn delete" onclick="deletarLinha('${l.id}')">🗑️</button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }


        function renderEstoque() {
            const contentArea = document.getElementById('app-content-area');
            
            // Oculta/Mostra o botão de exportar no Header
            const headerActions = document.getElementById('app-header-actions');
            if (headerActions) headerActions.innerHTML = '';
            
            let content = '';
            switch(state.activeTab) {
                case 'dashboard':
                    content = renderDashboard();
                    break;
                case 'consulta':
                    content = renderConsulta();
                    break;
                case 'estoque':
                    content = renderEstoqueGeral();
                    break;
                case 'movimentacoes':
                    content = renderMovimentacoes();
                    break;
                case 'nova-movimentacao':
                    content = renderNovaMovimentacao();
                    setTimeout(() => setTipoMovimento('entrada'), 0);
                    break;
                case 'novo-produto':
                    content = renderNovoProduto();
                    break;
                case 'importar':
                    content = renderImportar();
                    break;
                case 'novo-responsavel':
                    content = renderNovoResponsavel();
                    break;
                case 'nova-linha':
                    content = renderNovaLinha();
                    break;
                default:
                    content = renderDashboard();
            }
            
            // Recria a estrutura completa do app do estoque (Sidebar, Header, Content)
            return `
                <div class="app-container">
                    <div class="sidebar">
                        ${renderSidebarEstoque()}
                    </div>
                    
                    <div class="main-content">
                        <header class="header">
                            ${renderHeaderEstoque()}
                        </header>
                        
                        <div id="alert-container"></div>
                        
                        <main class="content-area" id="app-content-area">
                            ${content}
                        </main>
                    </div>
                </div>
            `;
        }


        function render() {
            const app = document.getElementById('app');
            
            if (state.currentView === 'login') {
                app.innerHTML = renderLogin();
            } else if (state.currentView === 'departamentos') {
                app.innerHTML = renderDepartamentos();
            } else if (state.currentView === 'estoque') {
                app.innerHTML = renderEstoque();
            } else {
                app.innerHTML = renderLogin(); 
            }
        }

        initData();
        render();
    </script>
</body>
</html>
